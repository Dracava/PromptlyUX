<!DOCTYPE html>
<html>
<head>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

:root {
    /* Colors */
    --eerie-black-1: hsl(240, 2%, 13%);
    --eerie-black-2: hsl(240, 2%, 12%);
    --jet: hsl(0, 0%, 22%);
    --onyx: hsl(240, 1%, 17%);
    --white-1: hsl(0, 0%, 100%);
    --white-2: hsl(0, 0%, 98%);
    --white-3: hsl(0, 0%, 83%);
    --light-gray-70: hsla(0, 0%, 84%, 0.7);
    --light-gray: hsl(0, 0%, 84%);
    --main-purple: hsl(270, 73%, 63%);
    --light-purple: hsl(270, 73%, 75%);
    --dark-purple: hsl(270, 73%, 53%);
    
    /* Disabled state colors */
    --disabled-bg: #1a1a1a;
    --disabled-border: #2a2a2a;
    --disabled-text: #666666;
    
    /* Typography */
    --fs-1: 24px;
    --fs-2: 18px;
    --fs-3: 17px;
    --fs-4: 16px;
    --fs-5: 15px;
    --fs-6: 14px;
    --fs-7: 13px;
    --fs-8: 11px;
    --fw-300: 300;
    --fw-400: 400;
    --fw-500: 500;
    --fw-600: 600;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Poppins', sans-serif;
    background: var(--eerie-black-2);
    color: var(--light-gray);
    font-size: var(--fs-6);
    margin: 0;
    overflow: hidden;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    height: 100vh;
}

/* Navigation */
.nav-bar {
    display: flex;
    justify-content: center;
    padding: 10px 10px 10px 50px;
    background: var(--onyx);
    border-bottom: 1px solid var(--jet);
}

.nav-tabs {
    display: flex;
    gap: 10px;
    list-style: none;
    padding: 0;
    margin: 0;
    justify-content: center;
    align-items: center;
    width: 100%;
}

.nav-tab {
    color: var(--light-gray);
    padding: 8px 16px;
    cursor: pointer;
    background: none;
    border: 1px solid var(--jet);
    border-radius: 8px;
    font-size: var(--fs-6);
    transition: all 0.2s ease;
}

.nav-tab:hover {
    color: var(--white-1);
    background: var(--eerie-black-1);
    border-color: var(--main-purple);
}

.nav-tab.active {
    color: var(--white-1);
    background: rgba(183, 82, 255, 0.15);
    border-color: var(--main-purple);
}

/* Content sections */
.content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.section {
    flex: 1;
    display: none;
    flex-direction: column;
    overflow-y: auto;
    padding: 20px;
}

.section.active {
    display: flex;
}

.section#prompts {
    padding: 0;
}

/* Questionnaire Section */
.questionnaire-container {
    display: none;
    padding: 0;
    height: 100%;
    overflow-y: auto;
    background: var(--eerie-black-2);
    position: relative;
}

.questionnaire-container .category-header {
    display: flex;
    flex-direction: row;
    align-items: right;
    justify-content: right;
    margin: 0px 20px 0px 0px;
    padding: 10px 16px;
    border-bottom: none;
    position: relative;
    height: auto;
    background-color: transparent;
    border: none;
    border-radius: 0;
}

/* Remove the chevron from the start category */
.questionnaire-container .category-header::after {
    display: none;
}

.questionnaire-container .category-icon {
    width: 24px;
    height: 24px;
    stroke: var(--white-2);
    stroke-width: 2;
    fill: none;
    margin-right: 15px;
    margin-top: 0;
    color: var(--white-2);
    justify-content: right;
}

.questionnaire-container h2 {
    color: var(--white-2);
    font-size: var(--fs-2);
    margin-bottom: 0;
    padding: 0;
    border-bottom: none;
    text-align: right;
    font-weight: 500;
}

.questionnaire-container .back-button {
    background: transparent;
    border: none;
    border-radius: 0;
    padding: 8px 16px;
    color: var(--light-gray);
    font-size: var(--fs-4);
    cursor: pointer;
    transition: all 0.2s ease;
    margin: 0 0 0 20px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    position: absolute;
    left: 0;
    z-index: 1;
}

.questionnaire-container .back-button:hover {
    color: var(--white-1);
}

.questionnaire {
    display: flex;
    flex-direction: column;
    gap: 40px; 
    padding: 0 30px 20px 30px;
    max-width: 800px;
    margin: 0 auto;
    width: 100%;
    background-color: transparent;
    color: var(--white-2);
}

.question-item {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 0;
}

.question-title {
    color: var(--white-1);
    font-size: var(--fs-4);
    font-weight: 500;
    margin: 0;
}

.text-input {
    background: var(--eerie-black-1);
    border: 1px solid var(--jet);
    border-radius: 8px;
    padding: 10px;
    color: var(--light-gray);
    font-family: 'Poppins', sans-serif;
    font-size: var(--fs-6);
    width: 100%;
    resize: vertical;
    min-height: 100px;
}

.text-input::placeholder {
    color: var(--light-gray-70);
}

.text-input:focus {
    outline: none;
    border-color: var(--main-purple);
}

.questionnaire-description {
    text-align: center;
    color: var(--light-purple);
    font-size: var(--fs-7);
    margin: 15px auto 30px auto;
    max-width: 600px;
    line-height: 1.5;
    padding: 0 20px 20px 20px;
    position: relative;
}

.questionnaire-description::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    height: 1px;
    background-color: var(--jet);
}

.option-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.option-item {
    background: var(--eerie-black-1);
    border: 1px solid var(--jet);
    border-radius: 8px;
    padding: 10px 5px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    user-select: none;
    -webkit-user-select: none;
    display: flex;
    justify-content: center;
    align-items: center;
    color: var(--light-gray);
    font-size: var(--fs-5);
}

.option-item:hover {
    background: rgba(183, 82, 255, 0.15);
    border-color: var(--main-purple);
    color: var(--main-purple);
}

.option-item.selected {
    background: rgba(183, 82, 255, 0.15);
    border-color: var(--main-purple);
    color: var(--main-purple);
}

.option-label {
    font-weight: 400;
    font-size: var(--fs-6);
}

.button-container {
    display: flex;
    justify-content: flex-end;
    margin-top: 15px; /* Reduced from 30px to 15px */
}

.button {
    padding: 12px 24px;
    border-radius: 8px;
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
    font-size: var(--fs-6);
    cursor: pointer;
    transition: all 0.2s;
    border: none;
}

/* Make the Make Overview button slightly smaller */
#makeOverviewButton {
    padding: 10px 20px;
    margin: 0;
}

.button-primary {
    background: var(--main-purple);
    color: var(--white-1);
}

.button-primary:hover {
    background: var(--dark-purple);
}

/* Button outline style for non-filled buttons */
.button-outline {
    background: transparent;
    color: var(--main-purple);
    border: 1px solid var(--main-purple);
}

.button-outline:hover {
    background: rgba(183, 82, 255, 0.1);
}

/* Welcome message styling */
.welcome-message {
    margin: 0 !important;
    padding: 12px 16px !important;
    border: none !important;
    background: var(--onyx);
}

.welcome-message .message-content {
    line-height: 1.4;
    padding: 0;
    margin: 0;
}

/* Welcome message buttons container */
.welcome-buttons {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: nowrap;
    justify-content: center;
    border: none;
}

.welcome-buttons .button {
    padding: 8px 12px;
    font-size: var(--fs-7);
    white-space: nowrap;
    border: 1px solid var(--main-purple);
}

/* Add these styles to your existing CSS */
.other-input {
    width: 100%;
    margin-top: 8px;
    padding: 8px;
    background: var(--eerie-black-1);
    border: 1px solid var(--jet);
    border-radius: 4px;
    color: var(--white-2);
    font-family: 'Poppins', sans-serif;
    font-size: var(--fs-6);
}

.other-input:focus {
    outline: none;
    border-color: var(--main-purple);
}

.multiple-select .option-item {
    position: relative;
}

.multiple-select .option-item.selected::after {
    content: '';
    display: none;
}

/* Remove the questionnaire overlay styles */
.questionnaire-overlay {
    display: none;
}

.prompt-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.prompt-popup {
    background: var(--eerie-black-2);
    border-radius: 12px;
    padding: 16px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.prompt-content {
    max-height: 60vh;
    overflow-y: auto;
    padding: 12px;
    background: var(--dark-2);
    border-radius: 8px;
    margin: 16px 0;
    white-space: pre-wrap;
    font-size: 14px;
    line-height: 1.4;
}

.prompt-content p {
    margin: 0 0 8px 0;
    font-size: inherit;
}

/* Style numbered lists */
.prompt-content p:has(+ p:first-of-type) {
    margin-bottom: 8px;
}

/* Add left padding for list items */
.prompt-content p:has(span[style*="color:var(--main-purple)"]),
.prompt-content p:has(strong) {
    padding-left: 0;
}

.prompt-content p:has(~ p:first-of-type) {
    padding-left: 24px;
}

.prompt-content[contenteditable="true"] {
    outline: 1px solid var(--main-purple);
    cursor: text;
}

/* Project overview specific styling */
.prompt-popup strong {
    color: var(--white-1);
    font-weight: 500;
}

.prompt-popup span[style*="color:var(--main-purple)"] {
    display: inline-block;
}

/* Chat Section */
.chat-container {
    display: flex;
    flex-direction: column;
    height: 100%;
    border: none;
}

.zoom-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 4px 12px;
    background: var(--eerie-black-2);
    opacity: 0.7;
    transition: opacity 0.2s;
    position: static;
    margin: 0 auto 0 auto;
    width: fit-content;
    z-index: 5;
    border-radius: 20px;
}

.zoom-controls:hover {
    opacity: 1;
}

/* Hide zoom controls when API key container is visible */
.api-key-container:not([style*="display: none"]) ~ .zoom-controls {
    display: none;
}

.zoom-button {
    background: none;
    border: none;
    color: var(--light-gray);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.zoom-button:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--main-purple);
}

.zoom-level {
    margin: 0 8px;
    font-size: var(--fs-7);
    color: var(--light-gray);
    user-select: none;
    min-width: 40px;
    text-align: center;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 40px 0 0 0;
    display: flex;
    flex-direction: column;
    gap: 16px;
    border: none;
}

.message {
    max-width: 90%;
    padding: 12px 16px;
    border-radius: 12px;
    line-height: 1.4;
    white-space: pre-wrap;
    font-size: var(--fs-7);
    border: none;
}

.message.user {
    align-self: flex-end;
    background: var(--main-purple);
    color: var(--white-1);
    border-bottom-right-radius: 4px;
}

.message.system {
    align-self: flex-start;
    background: var(--onyx);
    color: var(--light-gray);
    border-bottom-left-radius: 4px;
}

/* Add markdown formatting styles */
.message.system h1 {
    font-size: var(--fs-2);
    color: var(--white-1);
    margin: 5px 0;
    font-weight: 600;
}

.message.system h2 {
    font-size: var(--fs-3);
    color: var(--white-1);
    margin: 5px 0;
    font-weight: 600;
}

.message.system h3 {
    font-size: var(--fs-4);
    color: var(--white-1);
    margin: 5px 0;
    font-weight: 500;
}

.message.system strong {
    font-weight: 600;
    color: var(--white-2);
}

.message.system em {
    font-style: italic;
    opacity: 0.9;
}

.message.system code {
    background: rgba(255, 255, 255, 0.1);
    padding: 2px 4px;
    border-radius: 4px;
    font-family: monospace;
}

.message.system ul,
.message.system ol {
    margin: 8px 0;
    padding-left: 24px;
}

.message.system li {
    margin: 4px 0;
}

.chat-input-container {
    padding: 10px 16px 16px 16px;
    background: var(--eerie-black-1);
    border-top: none;
    display: flex;
    gap: 12px;
    align-items: flex-end;
    position: relative;
    z-index: 5;
}

.chat-input {
    flex: 1;
    min-height: 40px;
    padding: 12px;
    background: var(--eerie-black-2);
    border: 1px solid var(--jet);
    border-radius: 8px;
    color: var(--white-2);
    font-family: inherit;
    font-size: var(--fs-6);
    resize: none;
}

.chat-input:focus {
    outline: none;
    border-color: var(--main-purple);
}

.chat-input:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    background: var(--disabled-bg);
    border: 1px solid var(--disabled-border);
    color: var(--disabled-text);
}

.chat-input:disabled::placeholder {
    color: var(--disabled-text);
    font-style: italic;
}

.button-icon {
    background: var(--main-purple);
    border: none;
    border-radius: 8px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.button-icon:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    color: var(--disabled-text);
}

.button-icon:disabled:hover {
    background: none;
    color: var(--disabled-text);
}

.button-icon:hover {
    background: var(--dark-purple);
}

.button-icon svg {
    fill: var(--white-1);
}

/* Prompt Section */
.prompt-container {
    display: flex;
    flex-direction: column;
    padding: 15px;
    height: 100%;
    overflow: hidden;
}

.prompt-category {
    background: var(--eerie-black-1);
    border: 1px solid var(--jet);
    border-radius: 8px;
    padding: 16px;
}

.category-title {
    color: var(--white-2);
    font-size: var(--fs-4);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.prompt-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.prompt-item {
    background: var(--eerie-black-2);
    border-radius: 8px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.prompt-item:hover {
    background: rgba(183, 82, 255, 0.15);
    color: var(--main-purple);
}

.prompt-title {
    color: var(--white-2);
    font-size: var(--fs-5);
    margin-bottom: 4px;
}

.prompt-description {
    color: var(--light-gray-70);
    font-size: var(--fs-7);
}

/* Scrollbar styling */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--eerie-black-1);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: var(--jet);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--main-purple);
}

/* Prompts Grid Styling */
.prompts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 20px;
    height: 100%; 
    padding: 10px 30px 80px 30px ;
}

.category {
    background: var(--eerie-black-1);
    border: 1px solid var(--jet);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    transition: all 0.2s ease;
}

.category:hover {
    color: var(--white-1);
    background: rgba(183, 82, 255, 0.15);
    border-color: var(--main-purple);
}

.category-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px 0;
    width: 100%;
}

.category-icon {
    width: 60px;
    height: 60px;
    margin-bottom: 20px;
    fill: none;
    stroke: var(--main-purple);
    stroke-width: 1.2;
    transition: all 0.2s ease;
}

.category:hover .category-icon {
    stroke: var(--light-purple);
    transform: scale(1.1);
}

.category-title {
    font-size: 20px;
    color: var(--white-1);
    transition: all 0.2s ease;
}

.category:hover .category-title {
    color: var(--light-purple);
}

/* Page transition animation - modify to only apply to specific pages */
.page-transition .section#prompts:has(.questionnaire-container[style*="display: block"]),
.page-transition .section#prompts:has(.library-container),
.page-transition .section#prompts:has(.generate-form-container) {
    animation: fadeTransition 0.3s ease-in-out;
}

/* Remove the general section animation that applies to all sections */
.page-transition .section {
    animation: none;
}

@keyframes fadeTransition {
    0% {
        opacity: 0.5;
        transform: translateY(10px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}

/* API Key Container */
.api-key-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 20px;
    text-align: center;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--eerie-black-2);
    z-index: 10;
    padding: 20px 40px;
}

.api-key-input {
    width: 100%;
    max-width: 300px;
    padding: 12px 20px;
    margin: 30px;
    background: var(--eerie-black-1);
    border: 1px solid var(--jet);
    border-radius: 8px;
    color: var(--white-2);
    font-size: var(--fs-6);
    outline: none;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.api-key-input:focus {
    outline: none;
    border-color: var(--main-purple);
    box-shadow: 0 0 0 2px rgba(183, 82, 255, 0.2);
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
/* Prompt Suggestion Tabs */
.prompt-suggestions-row {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    background: var(--eerie-black-1);
    padding: 8px 16px;
    margin: 0 0 -10px 10px;
    position: relative;
    z-index: 15;
}

.prompt-suggestions {
    display: flex;
    flex-wrap: nowrap;
    gap: 12px;
    overflow-x: hidden;
    padding: 4px;
    flex: 1;
}

.prompt-tab {
    position: relative;
    padding: 8px 16px;
    height: 34px;
    min-width: 120px;
    max-width: 180px;
    background: var(--main-purple);
    color: var(--white-2);
    border: none;
    border-radius: 18px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: var(--fs-6);
    flex: 1;
    max-width: calc(50% - 6px);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    animation: fadeIn 0.3s ease-in-out;
}

.prompt-tab::after {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-top: 8px solid var(--main-purple);
}

.prompt-tab:hover::after {
    border-top-color: var(--dark-purple);
    color: var(--white-1);
}

.prompt-tab:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    color: var(--white-1);
}

.prompt-tab svg {
    width: 16px;
    height: 16px;
    margin-right: 8px;
}

.prompt-tab-header {
    color: white;
    font-size: var(--fs-7);
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.prompt-tab:hover .prompt-tab-header {
    color: var(--white-2);
}

/* Regenerate button styles */
.regenerate-button {
    background: var(--eerie-black-2);
    border: 1px solid var(--jet);
    border-radius: 6px;
    width: 34px;
    height: 34px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-left: 16px;
}

.regenerate-button:hover {
    background: rgba(183, 82, 255, 0.15);
    border-color: var(--main-purple);
}

.regenerate-button svg {
    width: 16px;
    height: 16px;
    fill: var(--light-gray);
}

.regenerate-button:hover svg {
    fill: var(--main-purple);
}

/* Initially hide the prompt suggestions */
.prompt-suggestions-container {
    display: none;
    position: relative;
    margin-top: -10px;
    z-index: 10;
}

/* Loading animation for prompt regeneration */
.loading-dot-container {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 30px;
    gap: 8px;
    margin-top: -5px;
    position: relative;
    z-index: 20;
}

.loading-dot {
    width: 8px;
    height: 8px;
    background-color: var(--light-gray);
    border-radius: 50%;
    animation: loading-dot-animation 1.4s infinite ease-in-out both;
}

.loading-dot:nth-child(1) {
    animation-delay: -0.32s;
}

.loading-dot:nth-child(2) {
    animation-delay: -0.16s;
}

@keyframes loading-dot-animation {
    0%, 80%, 100% {
        transform: scale(0);
    }
    40% {
        transform: scale(1);
    }
}

.prompt-suggestion-popup {
    background: var(--eerie-black-1);
    border: 1px solid var(--jet);
    border-radius: 8px;
    padding: 16px;
    width: 90%;
    max-width: 500px;
    position: relative;
}

.prompt-suggestion-title {
    color: var(--white-2);
    font-size: var(--fs-4);
    margin-bottom: 12px;
    font-weight: 500;
}

.prompt-suggestion-content {
    color: var(--light-gray);
    font-size: var(--fs-6);
    margin-bottom: 16px;
    line-height: 1.5;
    white-space: pre-wrap;
}

/* Typing indicator */
.typing-indicator {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    padding: 6px 10px;
    margin-bottom: 0;
}

.typing-indicator .dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--light-gray);
    margin-right: 4px;
    animation: typing-dot-bounce 1.4s infinite ease-in-out both;
}

.typing-indicator .dot:nth-child(1) {
    animation-delay: -0.32s;
}

.typing-indicator .dot:nth-child(2) {
    animation-delay: -0.16s;
}

@keyframes typing-dot-bounce {
    0%, 80%, 100% {
        transform: scale(0.6);
    }
    40% {
        transform: scale(1);
    }
}

.message-timestamp {
    font-size: var(--fs-8);
    opacity: 0.7;
    margin-top: -10px;
    text-align: right;
}

/* Chevron styling */
.chevron-toggle {
    position: relative;
    cursor: pointer;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease;
    margin-left: 12px;
}

.chevron-toggle svg {
    fill: var(--light-gray);
    transition: fill 0.2s ease;
}

.chevron-toggle:hover svg {
    fill: var(--white-1);
}

.chevron-toggle.collapsed {
    transform: rotate(180deg);
}

.plugin-collapsed .content {
    display: none;
}

.plugin-collapsed {
    min-height: 50px;
    height: 50px;
    overflow: hidden;
}

.section#chat {
    padding: 0;
}

.chat-messages {
    padding: 20px;
    width: 100%;
}

.section#prompts {
    padding: 0;
}

/* Message content styling */
.message-content {
    line-height: 1.5;
    color: var(--light-gray);
}

/* Zoom levels for message content */
.chat-container[data-zoom="80"] .message-content {
    font-size: 0.8em;
}
.chat-container[data-zoom="80"] .message-content h1 { font-size: calc(var(--fs-2) * 0.8); }
.chat-container[data-zoom="80"] .message-content h2 { font-size: calc(var(--fs-3) * 0.8); }
.chat-container[data-zoom="80"] .message-content h3 { font-size: calc(var(--fs-4) * 0.8); }
.chat-container[data-zoom="80"] .message-content pre code { font-size: calc(0.9em * 0.8); }

.chat-container[data-zoom="90"] .message-content {
    font-size: 0.9em;
}
.chat-container[data-zoom="90"] .message-content h1 { font-size: calc(var(--fs-2) * 0.9); }
.chat-container[data-zoom="90"] .message-content h2 { font-size: calc(var(--fs-3) * 0.9); }
.chat-container[data-zoom="90"] .message-content h3 { font-size: calc(var(--fs-4) * 0.9); }
.chat-container[data-zoom="90"] .message-content pre code { font-size: calc(0.9em * 0.9); }

.chat-container[data-zoom="100"] .message-content {
    font-size: 1em;
}
.chat-container[data-zoom="100"] .message-content h1 { font-size: var(--fs-2); }
.chat-container[data-zoom="100"] .message-content h2 { font-size: var(--fs-3); }
.chat-container[data-zoom="100"] .message-content h3 { font-size: var(--fs-4); }
.chat-container[data-zoom="100"] .message-content pre code { font-size: 0.9em; }

.chat-container[data-zoom="110"] .message-content {
    font-size: 1.1em;
}
.chat-container[data-zoom="110"] .message-content h1 { font-size: calc(var(--fs-2) * 1.1); }
.chat-container[data-zoom="110"] .message-content h2 { font-size: calc(var(--fs-3) * 1.1); }
.chat-container[data-zoom="110"] .message-content h3 { font-size: calc(var(--fs-4) * 1.1); }
.chat-container[data-zoom="110"] .message-content pre code { font-size: calc(0.9em * 1.1); }

.chat-container[data-zoom="120"] .message-content {
    font-size: 1.2em;
}
.chat-container[data-zoom="120"] .message-content h1 { font-size: calc(var(--fs-2) * 1.2); }
.chat-container[data-zoom="120"] .message-content h2 { font-size: calc(var(--fs-3) * 1.2); }
.chat-container[data-zoom="120"] .message-content h3 { font-size: calc(var(--fs-4) * 1.2); }
.chat-container[data-zoom="120"] .message-content pre code { font-size: calc(0.9em * 1.2); }

.chat-container[data-zoom="130"] .message-content {
    font-size: 1.3em;
}
.chat-container[data-zoom="130"] .message-content h1 { font-size: calc(var(--fs-2) * 1.3); }
.chat-container[data-zoom="130"] .message-content h2 { font-size: calc(var(--fs-3) * 1.3); }
.chat-container[data-zoom="130"] .message-content h3 { font-size: calc(var(--fs-4) * 1.3); }
.chat-container[data-zoom="130"] .message-content pre code { font-size: calc(0.9em * 1.3); }

.chat-container[data-zoom="140"] .message-content {
    font-size: 1.4em;
}
.chat-container[data-zoom="140"] .message-content h1 { font-size: calc(var(--fs-2) * 1.4); }
.chat-container[data-zoom="140"] .message-content h2 { font-size: calc(var(--fs-3) * 1.4); }
.chat-container[data-zoom="140"] .message-content h3 { font-size: calc(var(--fs-4) * 1.4); }
.chat-container[data-zoom="140"] .message-content pre code { font-size: calc(0.9em * 1.4); }

.chat-container[data-zoom="150"] .message-content {
    font-size: 1.5em;
}
.chat-container[data-zoom="150"] .message-content h1 { font-size: calc(var(--fs-2) * 1.5); }
.chat-container[data-zoom="150"] .message-content h2 { font-size: calc(var(--fs-3) * 1.5); }
.chat-container[data-zoom="150"] .message-content h3 { font-size: calc(var(--fs-4) * 1.5); }
.chat-container[data-zoom="150"] .message-content pre code { font-size: calc(0.9em * 1.5); }

/* Code block styling */
.message-content pre {
    background: var(--eerie-black-1);
    border-radius: 6px;
    padding: 12px;
    margin: 8px 0;
    overflow-x: auto;
}

.message-content pre code {
    background: none;
    padding: 0;
    font-family: monospace;
    font-size: 0.9em;
    color: var(--white-2);
    white-space: pre;
}

/* Inline code styling */
.message-content code:not(pre code) {
    background: rgba(255, 255, 255, 0.1);
    padding: 2px 4px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.9em;
    color: var(--white-2);
}

/* Headers - margin above headers, minimal margin below */
.message-content h1,
.message-content h2,
.message-content h3,
.message-content h4 {
    color: var(--white-1);
    margin: 8px 0 4px;
    font-weight: 500;
    line-height: 1.4;
}

/* Major section titles (like "Step 3", "Final Tips") get more top margin */
.message-content h2:not(:first-child) {
    margin-top: 32px;
}

/* Subsection titles get moderate top margin */
.message-content h3:not(:first-child) {
    margin-top: 24px;
}

/* First header in the content shouldn't have top margin */
.message-content > h1:first-child,
.message-content > h2:first-child,
.message-content > h3:first-child,
.message-content > h4:first-child {
    margin-top: 0;
}

/* Header sizes */
.message-content h1 {
    font-size: var(--fs-2);
}

.message-content h2 {
    font-size: var(--fs-3);
}

.message-content h3 {
    font-size: var(--fs-4);
}

.message-content h4 {
    font-size: var(--fs-5);
}

/* Paragraphs - minimal margins for compact content */
.message-content p {
    margin: 4px 0;
    color: var(--light-gray);
}

/* Remove margin between paragraph and list */
.message-content p + .list-item:first-of-type {
    margin-top: 0;
}

/* List items - no margins, minimal padding */
.message-content .list-item {
    margin: 0;
    padding-left: 12px;
    color: var(--light-gray);
    line-height: 1.4;
}

/* Add small spacing after lists before new content */
.message-content .list-item:last-of-type + :not(.list-item) {
    margin-top: 8px;
}

/* Add spacing before lists if preceded by non-list content */
:not(.list-item) + .list-item:first-of-type {
    margin-top: 4px;
}

.message-content strong {
    font-weight: 500;
    color: var(--white-1);
}

.message-content em {
    font-style: italic;
    opacity: 0.9;
}

.message-content a {
    color: var(--main-purple);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s ease;
}

.message-content a:hover {
    border-bottom-color: var(--main-purple);
}

/* Horizontal rule styling */
.message-content hr {
    border: none;
    height: 1px;
    background-color: var(--jet);
    margin: 12px 0;
    width: 100%;
    max-width: 100%;
    overflow: hidden;
}

/* Table styling */
.message-content table {
    border-collapse: collapse;
    width: 100%;
    margin: 12px 0;
    font-size: var(--fs-7);
    overflow-x: auto;
    display: block;
    max-width: 100%;
}

.message-content table th,
.message-content table td {
    border: 1px solid var(--jet);
    padding: 8px;
    text-align: left;
}

.message-content table th {
    background-color: var(--eerie-black-1);
    color: var(--white-2);
    font-weight: 500;
}

.message-content table tr:nth-child(even) {
    background-color: rgba(255, 255, 255, 0.03);
}

/* Adjusted line break spacing */
.message-content br {
    display: block;
    content: "";
    margin: 2px 0;
}

/* Remove extra space between consecutive br tags */
.message-content br + br {
    margin-top: 0;
}

.prompt-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    justify-content: flex-end;
}

.prompt-actions button {
    background: var(--eerie-black-2);
    border: 1px solid var(--jet);
    padding: 8px;
    border-radius: 6px;
    cursor: pointer;
    color: var(--light-gray);
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.prompt-actions button:hover {
    background: var(--eerie-black-1);
    border-color: var(--light-gray-70);
    color: var(--white-2);
}

.prompt-actions button svg {
    width: 16px;
    height: 16px;
}

.prompt-actions button[data-tooltip]:hover:after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--eerie-black-1);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    margin-bottom: 6px;
    z-index: 10;
}

.copy-prompt .copied-text {
    display: none;
}

.copy-prompt.copied {
    background: rgba(183, 82, 255, 0.15);
    border-color: var(--main-purple);
    color: var(--main-purple);
}

.copy-prompt.copied .copy-text {
    display: none;
}

.copy-prompt.copied .copied-text {
    display: inline;
    color: var(--main-purple);
}

.prompt-actions button.save-button {
    background: var(--eerie-black-1);
    border-color: var(--main-purple);
    color: var(--main-purple);
}

.prompt-actions button.save-button:hover {
    background: rgba(183, 82, 255, 0.15);
}

/* Regenerate button styles */
.prompt-actions button.regenerate-prompt {
    background: var(--eerie-black-2);
    border-color: var(--jet);
}

.prompt-actions button.regenerate-prompt:hover {
    background: rgba(183, 82, 255, 0.15);
    border-color: var(--main-purple);
    color: var(--main-purple);
}

.prompt-actions button.regenerate-prompt svg {
    transition: transform 0.3s ease;
}

.prompt-actions button.regenerate-prompt:hover svg {
    transform: rotate(180deg);
}

/* Library Page Styles */
.library-container {
    display: flex;
    flex-direction: column;
    padding: 0 20px;
    background-color: var(--eerie-black-2);
    width: 100%;
    height: 100%;
    overflow-y: auto;
}

.library-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.library-title {
    color: var(--white-2);
    font-size: var(--fs-2);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
}

.library-title .topic-icon {
    color: var(--main-purple);
    width: 16px;
    height: 16px;
}

.prompts-topics {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 80%;
    padding-bottom: 30px;
}

.topic {
    display: block;
    background-color: var(--eerie-black-1);
    border: 1px solid var(--jet);
    border-radius: 8px;
    overflow: hidden;
    margin: 8px 0;
}

.topic-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 20px;
    cursor: pointer;
    color: var(--white-3);
    position: relative;
}

.topic-header span {
    color: var(--white-3);
    font-size: var(--fs-6);
    font-weight: 500;
}

.topic-header .count {
    margin-right: 24px;
    color: var(--light-gray-70);
    background: rgba(255, 255, 255, 0.1);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: var(--fs-7);
    min-width: 24px;
    text-align: center;
    display: inline-block;
    transition: color 0.2s ease;
}

.topic-header:hover {
    background: rgba(183, 82, 255, 0.15);
    color: var(--main-purple);
}

.topic-header:hover .count {
    background: rgba(183, 82, 255, 0.15);
    color: var(--main-purple);
}

/* Add dropdown arrow indicator */
.topic-header::after {
    content: '';
    position: absolute;
    right: 12px;
    top: 50%;
    width: 8px;
    height: 8px;
    border-right: 2px solid var(--white-3);
    border-bottom: 2px solid var(--white-3);
    transform: translateY(-50%) rotate(45deg);
    transition: transform 0.3s ease, border-color 0.2s ease;
}

.topic-header:hover::after {
    border-color: var(--main-purple);
}

.topic.active .topic-header::after {
    transform: translateY(-50%) rotate(-135deg);
}

/* Topic items styles */
.topic-items {
    display: none;
    padding: 8px 0 8px 32px;
    max-height: 0;
    overflow: hidden;
    transition: all 0.3s ease;
}

.topic.active .topic-items {
    display: block;
    max-height: none;
    padding: 8px 0 8px 32px;
}

.item {
    padding: 12px 16px;
    padding-left: 24px;
    cursor: pointer;
    color: var(--white-3);
    margin: 4px 0;
    transition: background-color 0.2s ease, color 0.2s ease;
    border-radius: 6px;
    font-size: var(--fs-6);
}

.item:hover {
    background: rgba(183, 82, 255, 0.15);
    color: var(--main-purple);
}

.item.highlight {
    animation: highlightFade 2s ease-out forwards;
}

@keyframes highlightFade {
    0% {
        background: var(--main-purple);
        color: var(--white-1);
    }
    100% {
        background: transparent;
        color: var(--main-purple);
    }
}

/* Search styles */
.search-container {
    margin-top: -15px;
    margin-bottom: 20px;
    position: relative;
}

.search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    stroke: var(--light-gray-70);
    pointer-events: none;
}

.search-input {
    width: 100%;
    padding: 12px;
    padding-left: 36px;
    background: var(--eerie-black-1);
    border: 1px solid var(--jet);
    border-radius: 8px;
    color: var(--white-3);
    font-size: var(--fs-6);
    outline: none;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.search-input:focus {
    border-color: var(--main-purple);
    box-shadow: 0 0 0 2px rgba(183, 82, 255, 0.2);
}

.search-results {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 0;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--eerie-black-2);
    padding: 8px;
    z-index: 20;
    border-radius: 0 0 8px 8px;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
    max-height: 300px;
    overflow-y: auto;
}

.search-results:not(:empty) {
    opacity: 1;
    visibility: visible;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.search-pill {
    background: var(--eerie-black-1);
    border: 1px solid var(--jet);
    border-radius: 20px;
    padding: 6px 12px;
    color: var(--light-gray);
    font-size: var(--fs-7);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.search-pill:hover {
    background: var(--main-purple);
    border-color: var(--main-purple);
    color: var(--white-1);
}

.topic-label {
    color: var(--light-purple);
    font-size: var(--fs-8);
    opacity: 0.8;
}

.no-results {
    padding: 16px;
    text-align: center;
    color: var(--light-gray);
    font-size: var(--fs-7);
    width: 100%;
}

/* Back button styles */
.back-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: var(--white-2);
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px 0;
    transition: color 0.2s ease;
    font-family: var(--ff-poppins);
    font-size: var(--fs-4);
    font-weight: 500;
    margin-bottom: 24px;
}

.back-button:hover {
    color: var(--main-purple);
}

.back-button svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
}

.breadcrumb-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0;
}

.topic-title {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--white-2);
    font-size: var(--fs-4);
    font-weight: 500;
}

.topic-title .topic-icon {
    color: var(--main-purple);
    width: 14px;
    height: 14px;
}

/* Content overlay for search results */
.content-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 5;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.content-overlay.active {
    display: block;
    opacity: 1;
}

/* Library description styling */
.library-description {
    text-align: center;
    color: var(--light-purple);
    font-size: var(--fs-7);
    margin: 0 auto 30px auto;
    max-width: 600px;
    line-height: 1.5;
    padding: 0 20px 20px 20px;
    position: relative;
}

.library-description::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    height: 1px;
    background-color: var(--jet);
}

/* Send to Figma button */
.send-to-figma {
    position: absolute;
    bottom: -8px;
    right: 8px;
    background: var(--main-purple);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s ease, transform 0.2s ease;
    transform: translateY(4px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    z-index: 10;
}

.message.system {
    position: relative;
}

.message.system:hover .send-to-figma {
    opacity: 1;
    transform: translateY(0);
}

.send-to-figma:hover {
    background: var(--dark-purple);
}

.send-to-figma svg {
    width: 14px;
    height: 14px;
    fill: white;
}

.send-to-figma[data-tooltip]:hover:after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--eerie-black-1);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    margin-bottom: 6px;
    z-index: 10;
}

/* Suggestion bubble */
.suggestion-bubble {
    position: relative;
    display: inline-flex;
    align-items: center;
    background: var(--main-purple);
    color: var(--white-2);
    border-radius: 18px;
    padding: 8px 14px;
    margin-top: 12px;
    margin-left: auto;
    margin-right: 40px;
    margin-bottom: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    max-width: 80%;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    animation: fadeIn 0.3s ease-in-out;
    opacity: 0.5;
}

.suggestion-bubble:hover {
    background: var(--main-purple);
    color: var(--white-1);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    opacity: 1;
}

.suggestion-bubble::before {
    content: '';
    position: absolute;
    top: 50%;
    right: -8px;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-top: 8px solid transparent;
    border-bottom: 8px solid transparent;
    border-left: 8px solid var(--main-purple);
    border-right: none;
}

.suggestion-bubble:hover::before {
    border-left-color: var(--dark-purple);
}

.suggestion-bubble svg {
    width: 20px;
    height: 20px;
    margin-right: 8px;
}

.suggestion-bubble[data-tooltip]:hover:after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--eerie-black-1);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    margin-bottom: 6px;
    z-index: 10;
}

/* Notification styling */
.figma-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: var(--onyx);
    color: var(--light-gray);
    padding: 12px 16px;
    border-radius: 6px;
    font-size: var(--fs-6);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    animation: notification-slide-in 0.3s ease-out forwards;
}

.figma-notification.fade-out {
    animation: notification-fade-out 0.3s ease-out forwards;
}

@keyframes notification-slide-in {
    0% {
        transform: translateX(100%);
        opacity: 0;
    }
    100% {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes notification-fade-out {
    0% {
        transform: translateX(0);
        opacity: 1;
    }
    100% {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* Generate section styles */
.generate-form-container {
    padding: 20px;
    max-width: 800px;
    margin: 0 auto;
    overflow-y: auto;
    max-height: calc(100vh - 60px); /* Allow scrolling, accounting for nav bar */
}

.generate-form-container .category-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: -15px;
}

.generate-form-container .category-header .category-icon {
    width: 20px;
    height: 20px;
    margin-top: 5px;
    color: var(--white-1);
    stroke: var(--white-1);
    stroke-width: 2;
    fill: none;
}

.generate-form-container .category-header h2 {
    color: var(--white-1);
    font-size: var(--fs-3);
    font-weight: var(--fw-500);
    margin: 0;
}

.generate-description {
    color: var(--light-purple);
    font-size: var(--fs-6);
    margin-bottom: 16px;
    margin-top: -10px;
    line-height: 1.5;
    position: relative;
    width: 90%;
    padding-bottom: 16px;
}

.generate-description::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 1px;
    background: linear-gradient(to right, var(--jet), transparent);
}

.generate-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 32px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    color: var(--white-2);
    font-size: var(--fs-6);
    font-weight: var(--fw-500);
}

/* Checkbox styling */
.form-group input[type="checkbox"] {
    appearance: auto;
    -webkit-appearance: auto;
    width: 18px;
    height: 18px;
    min-width: 18px;
    background-color: var(--eerie-black-1);
    border: 1px solid var(--jet);
    border-radius: 3px;
    cursor: pointer;
    position: relative;
    margin: 0;
}

.form-group input[type="checkbox"]:checked {
    background-color: var(--main-purple);
    border-color: var(--main-purple);
}

.form-group input[type="checkbox"]:focus {
    outline: none;
    border-color: var(--main-purple);
    box-shadow: 0 0 0 2px rgba(138, 43, 226, 0.25);
}

.form-control {
    background-color: var(--eerie-black-1);
    border: 1px solid var(--jet);
    border-radius: 6px;
    color: var(--light-gray);
    font-family: 'Poppins', sans-serif;
    font-size: var(--fs-6);
    padding: 10px 12px;
    width: 100%;
    transition: border-color 0.2s;
}

.form-control:focus {
    border-color: var(--main-purple);
    outline: none;
}

.form-control::placeholder {
    color: var(--light-gray-70);
}

select.form-control {
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23aaa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 36px;
}

textarea.form-control {
    min-height: 80px;
    resize: vertical;
}

#generatedPromptContainer {
    background-color: var(--eerie-black-1);
    border-radius: 8px;
    padding: 20px;
    margin-top: 32px;
    border: 1px solid var(--jet);
}

#generatedPromptContainer h3 {
    color: var(--white-1);
    font-size: var(--fs-4);
    margin-bottom: 16px;
    font-weight: var(--fw-500);
}

.generated-prompt {
    background-color: var(--onyx);
    border-radius: 6px;
    padding: 16px;
    color: var(--light-gray);
    font-size: var(--fs-6);
    line-height: 1.6;
    white-space: pre-wrap;
    margin-bottom: 16px;
    border: 1px solid var(--jet);
}

.prompt-item-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 12px;
    gap: 8px;
}

.prompt-item-actions button {
    background: none;
    border: none;
    color: var(--light-gray);
    padding: 6px;
    cursor: pointer;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.prompt-item-actions button:hover {
    background-color: var(--jet);
}

.prompt-item-actions button[data-tooltip] {
    position: relative;
}

.prompt-item-actions button[data-tooltip]:hover:after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background-color: var(--eerie-black-2);
    color: var(--light-gray);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: var(--fs-7);
    white-space: nowrap;
    margin-bottom: 5px;
    z-index: 10;
}

.prompt-item-actions .copy-prompt {
    position: relative;
}

.prompt-item-actions .copy-prompt .copied-text {
    display: none;
}

.prompt-item-actions .copy-prompt.copied .copy-text {
    display: none;
}

.prompt-item-actions .copy-prompt.copied .copied-text {
    display: inline;
}

.prompt-item-actions .save-button {
    display: none;
    background: var(--eerie-black-1);
    border: 1px solid var(--main-purple);
    color: var(--main-purple);
}

.prompt-item-actions .save-button:hover {
    background-color: rgba(138, 43, 226, 0.1);
}

.prompt-item-actions .edit-button.active ~ .save-button {
    display: flex;
}

/* Generate page styles */
.generate-form {
    margin-top: 20px;
    padding: 0 10px;
}

.generate-form .form-group {
    margin-bottom: 15px;
}

.generate-form textarea.form-control {
    height: 60px;
    resize: vertical;
}

#generatedContent {
    white-space: pre-wrap;
    color: var(--light-gray);
    font-family: 'Poppins', sans-serif;
    font-size: var(--fs-6);
    line-height: 1.5;
    max-height: 300px;
    overflow-y: auto;
    background: var(--eerie-black-1);
    padding: 16px;
    border-radius: 8px;
    margin-top: 10px;
}

.generated-prompts {
    margin-top: 30px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.prompt-item {
    background-color: var(--onyx);
    border-radius: 6px;
    padding: 16px;
    color: var(--light-gray);
    font-size: var(--fs-6);
    line-height: 1.5;
    position: relative;
    margin-bottom: 0; /* Remove default margin, using gap instead */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Zoom levels for suggestion bubble */
.chat-container[data-zoom="80"] .suggestion-bubble {
    font-size: calc(14px * 0.8);
    padding: 6px 12px;
}
.chat-container[data-zoom="80"] .suggestion-bubble svg {
    width: calc(20px * 0.8);
    height: calc(20px * 0.8);
}

.chat-container[data-zoom="90"] .suggestion-bubble {
    font-size: calc(14px * 0.9);
    padding: 7px 13px;
}
.chat-container[data-zoom="90"] .suggestion-bubble svg {
    width: calc(20px * 0.9);
    height: calc(20px * 0.9);
}

.chat-container[data-zoom="100"] .suggestion-bubble {
    font-size: 14px;
    padding: 8px 14px;
}
.chat-container[data-zoom="100"] .suggestion-bubble svg {
    width: 20px;
    height: 20px;
}

.chat-container[data-zoom="110"] .suggestion-bubble {
    font-size: calc(14px * 1.1);
    padding: 9px 15px;
}
.chat-container[data-zoom="110"] .suggestion-bubble svg {
    width: calc(20px * 1.1);
    height: calc(20px * 1.1);
}

.chat-container[data-zoom="120"] .suggestion-bubble {
    font-size: calc(14px * 1.2);
    padding: 10px 16px;
}
.chat-container[data-zoom="120"] .suggestion-bubble svg {
    width: calc(20px * 1.2);
    height: calc(20px * 1.2);
}

.chat-container[data-zoom="130"] .suggestion-bubble {
    font-size: calc(14px * 1.3);
    padding: 10px 17px;
}
.chat-container[data-zoom="130"] .suggestion-bubble svg {
    width: calc(20px * 1.3);
    height: calc(20px * 1.3);
}

.chat-container[data-zoom="140"] .suggestion-bubble {
    font-size: calc(14px * 1.4);
    padding: 11px 18px;
}
.chat-container[data-zoom="140"] .suggestion-bubble svg {
    width: calc(20px * 1.4);
    height: calc(20px * 1.4);
}

.chat-container[data-zoom="150"] .suggestion-bubble {
    font-size: calc(14px * 1.5);
    padding: 12px 19px;
}
.chat-container[data-zoom="150"] .suggestion-bubble svg {
    width: calc(20px * 1.5);
    height: calc(20px * 1.5);
}

/* Scale the triangle indicator with zoom */
.chat-container[data-zoom="80"] .suggestion-bubble::before {
    right: -6px;
    border-top: 6px solid transparent;
    border-bottom: 6px solid transparent;
    border-left: 6px solid var(--main-purple);
}

.chat-container[data-zoom="90"] .suggestion-bubble::before {
    right: -7px;
    border-top: 7px solid transparent;
    border-bottom: 7px solid transparent;
    border-left: 7px solid var(--main-purple);
}

.chat-container[data-zoom="110"] .suggestion-bubble::before {
    right: -9px;
    border-top: 9px solid transparent;
    border-bottom: 9px solid transparent;
    border-left: 9px solid var(--main-purple);
}

.chat-container[data-zoom="120"] .suggestion-bubble::before {
    right: -10px;
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
    border-left: 10px solid var(--main-purple);
}

.chat-container[data-zoom="130"] .suggestion-bubble::before {
    right: -10px;
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
    border-left: 10px solid var(--main-purple);
}

.chat-container[data-zoom="140"] .suggestion-bubble::before {
    right: -11px;
    border-top: 11px solid transparent;
    border-bottom: 11px solid transparent;
    border-left: 11px solid var(--main-purple);
}

.chat-container[data-zoom="150"] .suggestion-bubble::before {
    right: -12px;
    border-top: 12px solid transparent;
    border-bottom: 12px solid transparent;
    border-left: 12px solid var(--main-purple);
}

/* Update hover states for different zoom levels */
.chat-container[data-zoom="80"] .suggestion-bubble:hover::before {
    border-left-color: var(--dark-purple);
}

.chat-container[data-zoom="90"] .suggestion-bubble:hover::before {
    border-left-color: var(--dark-purple);
}

.chat-container[data-zoom="110"] .suggestion-bubble:hover::before {
    border-left-color: var(--dark-purple);
}

.chat-container[data-zoom="120"] .suggestion-bubble:hover::before {
    border-left-color: var(--dark-purple);
}

.chat-container[data-zoom="130"] .suggestion-bubble:hover::before {
    border-left-color: var(--dark-purple);
}

.chat-container[data-zoom="140"] .suggestion-bubble:hover::before {
    border-left-color: var(--dark-purple);
}

.chat-container[data-zoom="150"] .suggestion-bubble:hover::before {
    border-left-color: var(--dark-purple);
}
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <div class="nav-bar">
        <div class="nav-tabs">
            <div class="nav-tab active" data-section="chat">Chat</div>
            <div class="nav-tab" data-section="prompts">Prompts</div>
            <div class="chevron-toggle" id="collapseToggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
                </svg>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content">
        <!-- Chat Section -->
        <div class="section active" id="chat">
            <div class="chat-container">
                <div class="api-key-container" id="apiKeyContainer">
                    <button class="close-api-dialog" id="closeApiDialog" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--light-gray);">×</button>
                    <h3>Enter your OpenAI API Key</h3>
                    <p>Your key will be used only in this session and won't be stored.
                        <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener noreferrer"
                            style="color: var(--main-purple); text-decoration: underline; text-underline-offset: 2px;">
                            You can find yours here.
                        </a>
                    </p>
                    <input type="password" class="api-key-input" id="apiKeyInput" placeholder="sk-..." />
                    <div style="display: flex; justify-content: center; margin-top: 20px;">
                        <button class="button button-primary" id="verifyKeyButton">Verify Key</button>
                    </div>
                </div>
                <div class="zoom-controls">
                    <button class="zoom-button" id="zoomOut" title="Zoom Out (Ctrl/Cmd + -)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            <line x1="8" y1="11" x2="14" y2="11"></line>
                        </svg>
                    </button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="zoom-button" id="zoomIn" title="Zoom In (Ctrl/Cmd + +)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            <line x1="11" y1="8" x2="11" y2="14"></line>
                            <line x1="8" y1="11" x2="14" y2="11"></line>
                        </svg>
                    </button>
                </div>
                <div class="chat-messages">
                    <!-- Initial welcome message will be added by JavaScript -->
                </div>
                <div class="prompt-suggestions-container">
                    <div class="prompt-suggestions-row">
                        <div class="prompt-suggestions" id="promptSuggestions">
                            <!-- Prompt suggestion tabs will be dynamically added here -->
                        </div>
                        <button class="regenerate-button" id="regenerateButton" title="Regenerate">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="chat-input-container">
                    <textarea class="chat-input" placeholder="Type your message here..." disabled></textarea>
                    <button class="button-icon" id="sendButton" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Prompts Section -->
        <div class="section" id="prompts">
            <div class="prompt-container">
                <div class="prompts-grid">
                    <div class="category" id="startCategory" onclick="document.querySelector('.prompts-grid').style.display = 'none'; document.getElementById('questionnaireContainer').style.display = 'block'; if(typeof initializeOptionItems === 'function') { initializeOptionItems(); } return false;">
                        <div class="category-content">
                            <svg xmlns="http://www.w3.org/2000/svg" class="category-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/>
                            </svg>
                            <h3 class="category-title">Start</h3>
                        </div>
                    </div>
                    <div class="category" id="savedCategory" onclick="showSavedPage()">
                        <div class="category-content">
                            <svg xmlns="http://www.w3.org/2000/svg" class="category-icon" viewBox="0 0 24 24">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                            </svg>
                            <h3 class="category-title">Saved</h3>
                        </div>
                    </div>
                    <div class="category" id="libraryCategory" onclick="showLibraryPage()">
                        <div class="category-content">
                            <svg xmlns="http://www.w3.org/2000/svg" class="category-icon" viewBox="0 0 24 24">
                                <path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/>
                            </svg>
                            <h3 class="category-title">Library</h3>
                        </div>
                    </div>
                    <div class="category" id="generateCategory" onclick="showGeneratePage()">
                        <div class="category-content">
                            <svg xmlns="http://www.w3.org/2000/svg" class="category-icon" viewBox="0 0 24 24">
                                <path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/>
                            </svg>
                            <h3 class="category-title">Generate</h3>
                        </div>
                    </div>
                </div>
                
                <!-- Add the questionnaire directly in the prompts section -->
                <div class="questionnaire-container" id="questionnaireContainer">
                    <button class="back-button" id="backToCategories" onclick="document.getElementById('questionnaireContainer').style.display = 'none'; document.querySelector('.prompts-grid').style.display = 'grid'; return false;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24">
                            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" fill="currentColor"/>
                        </svg>
                        Back
                    </button>
                    <div class="category-header">
                        <svg xmlns="http://www.w3.org/2000/svg" class="category-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/>
                        </svg>
                        <h2>Start</h2>
                    </div>
                    <p class="questionnaire-description">Fill in this survey to generate a project overview.<br>Send this to the chat to give it context.</p>
                    <div class="questionnaire">
                        <div class="question-item">
                            <h3 class="question-title">1. Give a short description of your current design project</h3>
                            <textarea class="text-input" id="projectDescription" placeholder="Briefly describe your project goals and context..."></textarea>
                        </div>
        
                        <div class="question-item">
                            <h3 class="question-title">2. What is the target audience for your design?</h3>
                            <textarea class="text-input" id="targetAudience" placeholder="Describe your target audience, their needs, and characteristics..."></textarea>
                        </div>
        
                        <div class="question-item">
                            <h3 class="question-title">3. What type of project are you working on?</h3>
                            <div class="option-grid">
                                <div class="option-item" data-value="Website">
                                    <div class="option-label">Website</div>
                                </div>
                                <div class="option-item" data-value="Mobile App">
                                    <div class="option-label">Mobile App</div>
                                </div>
                                <div class="option-item" data-value="Desktop Software">
                                    <div class="option-label">Desktop Software</div>
                                </div>
                                <div class="option-item other" data-value="Other">
                                    <div class="option-label">Other</div>
                                </div>
                            </div>
                        </div>
        
                        <div class="question-item">
                            <h3 class="question-title">4. What is the main goal of your design project? (Multiple answers possible)</h3>
                            <div class="option-grid multiple-select">
                                <div class="option-item" data-value="Usability">
                                    <div class="option-label">Usability</div>
                                </div>
                                <div class="option-item" data-value="Accessibility">
                                    <div class="option-label">Accessibility</div>
                                </div>
                                <div class="option-item" data-value="Aesthetics">
                                    <div class="option-label">Aesthetics</div>
                                </div>
                                <div class="option-item" data-value="User Engagement">
                                    <div class="option-label">User Engagement</div>
                                </div>
                                <div class="option-item" data-value="Efficiency">
                                    <div class="option-label">Efficiency</div>
                            </div>
                                <div class="option-item" data-value="Learnability">
                                    <div class="option-label">Learnability</div>
                                </div>
                            </div>
                        </div>
        
                        <div class="question-item">
                            <h3 class="question-title">5. What's your level in Figma?</h3>
                            <div class="option-grid">
                                <div class="option-item" data-value="Beginner">
                                    <div class="option-label">Beginner</div>
                                </div>
                                <div class="option-item" data-value="Intermediate">
                                    <div class="option-label">Intermediate</div>
                                </div>
                                <div class="option-item" data-value="Advanced">
                                    <div class="option-label">Advanced</div>
                                </div>
                                <div class="option-item" data-value="Expert">
                                    <div class="option-label">Expert</div>
                                </div>
                            </div>
                        </div>
        
                        <div class="question-item">
                            <h3 class="question-title">6. Do you have a preferred design style?</h3>
                            <div class="option-grid">
                                <div class="option-item" data-value="Modern">
                                    <div class="option-label">Modern</div>
                                </div>
                                <div class="option-item" data-value="Experimental">
                                    <div class="option-label">Experimental</div>
                                </div>
                                <div class="option-item" data-value="Professional">
                                    <div class="option-label">Professional</div>
                                </div>
                                <div class="option-item" data-value="Playful">
                                    <div class="option-label">Playful</div>
                                </div>
                                <div class="option-item" data-value="Informative">
                                    <div class="option-label">Informative</div>
                                </div>
                                <div class="option-item" data-value="No preference">
                                    <div class="option-label">No preference</div>
                                </div>
                            </div>
                        </div>
        
                        <div class="question-item">
                            <h3 class="question-title">7. How complex is your final product?</h3>
                            <div class="option-grid">
                                <div class="option-item" data-value="It has 1-3 purposes">
                                    <div class="option-label">It has 1-3 purposes</div>
                                </div>
                                <div class="option-item" data-value="It has 3-5 purposes">
                                    <div class="option-label">It has 3-5 purposes</div>
                                </div>
                                <div class="option-item" data-value="It has 5+ purposes">
                                    <div class="option-label">It has 5+ purposes</div>
                                </div>
                                <div class="option-item" data-value="I am unsure">
                                    <div class="option-label">I am unsure</div>
                                </div>
                            </div>
                        </div>
        
                        <div class="question-item">
                            <h3 class="question-title">8. Describe some of the purposes:</h3>
                            <textarea class="text-input" id="purposes" placeholder="E.g. conversion (webshop), informative (news/blog), community (social network), entertainment (streaming) etc."></textarea>
                        </div>
        
                        <div class="question-item">
                            <h3 class="question-title">9. What stage are you in within the design process?</h3>
                            <div class="option-grid">
                                <div class="option-item" data-value="Research">
                                    <div class="option-label">Research</div>
                                </div>
                                <div class="option-item" data-value="Wireframing">
                                    <div class="option-label">Wireframing</div>
                                </div>
                                <div class="option-item" data-value="Prototyping">
                                    <div class="option-label">Prototyping</div>
                                </div>
                                <div class="option-item" data-value="User Testing">
                                    <div class="option-label">User Testing</div>
                                </div>
                            </div>
                        </div>
        
                        <div class="question-item">
                            <h3 class="question-title">10. Do you have other guidelines or remarks regarding this project?</h3>
                            <textarea class="text-input" id="guidelines" placeholder="Add any additional guidelines, requirements, or remarks that might be relevant..."></textarea>
                        </div>
        
                        <div class="button-container">
                            <button class="button button-primary" id="makeOverviewButton">Make Overview</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Add this at the beginning of your script
function initializeWelcomeMessage() {
    const chatMessages = document.querySelector('.chat-messages');
    if (!chatMessages) return;
    
    // Reset the project overview sent flag when initializing welcome message
    projectOverviewSentToChat = false;
    
    // Hide the prompt suggestions container initially
    const promptSuggestionsContainer = document.querySelector('.prompt-suggestions-container');
    
    const welcomeMessage = `<div class="message system"><div class="message-content">👋 Hi there! I'm your Figma Design Assistant. 

🚀 Send my replies to Figma by clicking the purple arrow below.
            
📚 You can browse through the keywords in the prompt library to get inspiration

🛠️ Or you can also generate your own prompts.

▶️ But I highly recommend starting out by filling in the project overview.

<div class="welcome-buttons">
    <button class="button button-outline" id="welcomeLibraryBtn">Library</button>
    <button class="button button-outline" id="welcomeGenerateBtn">Generate</button>
    <button class="button button-primary" id="welcomeStartBtn">Getting Started</button>
</div></div>
    </div>`;
    
    chatMessages.innerHTML = welcomeMessage;
    
    // Add event listeners for welcome buttons right after creating them
    addWelcomeButtonListeners();

    // Add a delayed follow-up question about PromptlyUX's functionalities
    setTimeout(() => {
        // Create a container div for the suggestion bubble
        const bubbleContainer = document.createElement('div');
        bubbleContainer.style.display = 'flex';
        bubbleContainer.style.justifyContent = 'flex-end';
        bubbleContainer.style.width = '100%';
        
        // Create the suggestion bubble
        const suggestionBubble = document.createElement('div');
        suggestionBubble.className = 'suggestion-bubble';
        suggestionBubble.setAttribute('data-tooltip', 'Click to use this suggestion');
        suggestionBubble.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 18h6"></path>
                <path d="M10 22h4"></path>
                <path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0018 8 6 6 0 006 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 018.91 14"></path>
            </svg>
            Could you tell me more about the functionalities of PromptlyUX?
        `;
        
        // Add click event to open the prompt popup
        suggestionBubble.addEventListener('click', () => {
            showPromptPopup('About PromptlyUX', 'Could you tell me more about the functionalities of PromptlyUX?');
        });
        
        // Add the bubble to the container
        bubbleContainer.appendChild(suggestionBubble);
        
        // Add the container to the chat
        chatMessages.appendChild(bubbleContainer);
        
        // Scroll to show the suggestion bubble
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 3000); // 3 seconds delay
}

// Function to add event listeners to welcome buttons
function addWelcomeButtonListeners() {
    const welcomeLibraryBtn = document.getElementById('welcomeLibraryBtn');
    const welcomeGenerateBtn = document.getElementById('welcomeGenerateBtn');
    const welcomeStartBtn = document.getElementById('welcomeStartBtn');
    
    if (welcomeLibraryBtn) {
        welcomeLibraryBtn.addEventListener('click', () => {
            // Switch to prompts tab
            document.querySelector('.nav-tab[data-section="prompts"]').click();
            
            // Find the library category and trigger a click on it
            const libraryCategory = document.getElementById('libraryCategory');
            if (libraryCategory) {
                setTimeout(() => {
                    libraryCategory.click();
                }, 100); // Small delay to ensure the tab switch completes
            }
        });
    }
    
    if (welcomeGenerateBtn) {
        welcomeGenerateBtn.addEventListener('click', () => {
            // Switch to prompts tab
            document.querySelector('.nav-tab[data-section="prompts"]').click();
            
            // Show the generate page
            if (typeof showGeneratePage === 'function') {
                setTimeout(() => {
                    showGeneratePage();
                }, 100); // Small delay to ensure the tab switch completes
            } else {
                console.error('showGeneratePage function not found');
            }
        });
    }
    
    if (welcomeStartBtn) {
        welcomeStartBtn.addEventListener('click', () => {
            // Add animation class to the body for transition
            document.body.classList.add('page-transition');
            
            // Switch to prompts tab and show questionnaire
            document.querySelector('.nav-tab[data-section="prompts"]').click();
            
            setTimeout(() => {
                document.querySelector('.prompts-grid').style.display = 'none';
                document.getElementById('questionnaireContainer').style.display = 'block';
                // Re-initialize option items when questionnaire is shown
                initializeOptionItems();
                
                // Remove animation class after transition completes
                document.body.classList.remove('page-transition');
            }, 300); // Small delay to ensure the tab switch completes
        });
    }
}

// When page loads, ensure Chat section is active by default and initialize option items
window.addEventListener('DOMContentLoaded', () => {
    // Initialize welcome message
    initializeWelcomeMessage();
    
    // Set Chat tab as active
    document.querySelector('.nav-tab[data-section="chat"]').classList.add('active');
    document.querySelector('.nav-tab[data-section="prompts"]').classList.remove('active');
    
    // Set Chat section as active
    document.getElementById('chat').classList.add('active');
    document.getElementById('prompts').classList.remove('active');
    
    // Initialize option items
    initializeOptionItems();
    
    // Initialize zoom controls
    initializeZoomControls();
    
    // Initialize prompt categories
    if (typeof initializePromptCategories === 'function') {
        initializePromptCategories();
    }
    
    // Initialize back button functionality
    const backToCategories = document.getElementById('backToCategories');
    if (backToCategories) {
        backToCategories.addEventListener('click', () => {
            const questionnaireContainer = document.getElementById('questionnaireContainer');
            const promptsGrid = document.querySelector('.prompts-grid');
            if (questionnaireContainer && promptsGrid) {
                questionnaireContainer.style.display = 'none';
                promptsGrid.style.display = 'grid';
            }
        });
    }
    
    // Add direct click handler for the Generate category
    const generateCategory = document.getElementById('generateCategory');
    if (generateCategory) {
        generateCategory.addEventListener('click', function() {
            console.log('Generate category clicked from script.js');
            if (typeof showGenerateInterface === 'function') {
                showGenerateInterface();
            } else {
                console.error('showGenerateInterface function not found');
            }
        });
    }
});

// Initialize option items with event listeners
function initializeOptionItems() {
    document.querySelectorAll('.option-grid').forEach(grid => {
        const isMultipleSelect = grid.classList.contains('multiple-select');
        
        grid.querySelectorAll('.option-item').forEach(item => {
            // Remove any existing event listeners by cloning and replacing
            const newItem = item.cloneNode(true);
            item.parentNode.replaceChild(newItem, item);
            
            // Add new event listener
            newItem.addEventListener('click', () => {
                if (isMultipleSelect) {
                    // Toggle selection for multiple select
                    newItem.classList.toggle('selected');
                } else {
                    // Single selection behavior
                    grid.querySelectorAll('.option-item').forEach(opt => {
                        opt.classList.remove('selected');
                        // Remove other input if deselected
                        if (opt !== newItem && opt.classList.contains('other')) {
                            const input = opt.querySelector('.other-input');
                            if (input) opt.removeChild(input);
                        }
                    });
                    newItem.classList.add('selected');
                }
                
                // If this is an "Other" option, handle the input field
                if (newItem.classList.contains('other') && newItem.classList.contains('selected')) {
                    // Create input field if it doesn't exist
                    if (!newItem.querySelector('.other-input')) {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'other-input';
                        input.placeholder = 'Please specify';
                        
                        // Prevent click from toggling selection
                        input.addEventListener('click', e => e.stopPropagation());
                        
                        newItem.appendChild(input);
                        setTimeout(() => input.focus(), 0);
                    }
                }
            });
        });
    });
}

// Tab navigation
document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        const sectionId = tab.getAttribute('data-section');
        
        // Only add animation class for the prompts section
        if (sectionId === 'prompts') {
            document.body.classList.add('page-transition');
            
            // Remove animation class after transition completes
            setTimeout(() => {
                document.body.classList.remove('page-transition');
            }, 300);
        }
        
        // If switching to chat tab, refresh the placeholder prompts
        if (sectionId === 'chat') {
            // Update placeholder prompts based on whether project overview has been sent
            displayPlaceholderPrompts();
        }
        
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
            if (section.id === sectionId) section.classList.add('active');
        });
    });
});

// Handle Start category click to show questionnaire
document.getElementById('startCategory').addEventListener('click', () => {
    document.querySelector('.prompts-grid').style.display = 'none';
    document.getElementById('questionnaireContainer').style.display = 'block';
    // Re-initialize option items when questionnaire is shown
    initializeOptionItems();
});

// Handle Library category click to show library page
document.getElementById('libraryCategory').addEventListener('click', () => {
    // Call the showLibraryPage function from library.js
    if (typeof showLibraryPage === 'function') {
        showLibraryPage();
    }
});

// Back button to return to categories
document.getElementById('backToCategories').addEventListener('click', () => {
    document.getElementById('questionnaireContainer').style.display = 'none';
    document.querySelector('.prompts-grid').style.display = 'grid';
});

// Option selection
document.querySelectorAll('.option-item').forEach(item => {
    item.addEventListener('click', () => {
        const siblings = Array.from(item.parentElement.children);
        siblings.forEach(sibling => sibling.classList.remove('selected'));
        item.classList.add('selected');
    });
});

// Chat functionality
const chatInput = document.querySelector('.chat-input');
const sendButton = document.getElementById('sendButton');
const chatMessages = document.querySelector('.chat-messages');
const apiKeyInput = document.getElementById('apiKeyInput');
const verifyKeyButton = document.getElementById('verifyKeyButton');
const apiKeyContainer = document.getElementById('apiKeyContainer');
const promptSuggestionsContainer = document.querySelector('.prompt-suggestions-container');
const regenerateButton = document.getElementById('regenerateButton');

let apiKey = '';
let hasUserSentMessage = false;

// Verify API key
async function verifyApiKey(key) {
    try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${key}`
            },
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: [{ role: 'user', content: 'Test' }],
                max_tokens: 5
            })
        });

        return { valid: response.ok };
    } catch (error) {
        console.error('API verification error:', error);
        return { valid: false };
    }
}

// Handle verify button click
verifyKeyButton.addEventListener('click', async () => {
    const key = apiKeyInput.value.trim();
    if (!key) {
        return;
    }

    verifyKeyButton.disabled = true;
    verifyKeyButton.textContent = 'Verifying...';

    try {
        const result = await verifyApiKey(key);
        
        if (result.valid) {
            apiKey = key;
            apiKeyContainer.style.display = 'none';
            chatInput.disabled = false;
            sendButton.disabled = false;
            
            // Check if there's a pending overview in local storage
            const pendingOverview = localStorage.getItem('pendingOverview');
            if (pendingOverview) {
                chatInput.value = pendingOverview;
                localStorage.removeItem('pendingOverview');
            }
            
            // Set a timer to show prompt suggestions after 5 seconds if user hasn't sent a message
            setTimeout(() => {
                if (!hasUserSentMessage) {
                    hasUserSentMessage = true;
                    promptSuggestionsContainer.style.display = 'block';
                    // Display placeholder prompts for initial suggestions
                    displayPlaceholderPrompts();
                }
            }, 5000); // 5 seconds delay
        }
    } catch (error) {
        console.error('Error verifying API key:', error);
    } finally {
        verifyKeyButton.disabled = false;
        verifyKeyButton.textContent = 'Verify Key';
    }
});

// Handle Enter key on API key input
apiKeyInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        verifyKeyButton.click();
    }
});

function sendMessage() {
    const message = chatInput.value.trim();
    if (message) {
        addMessage(message, 'user');
        chatInput.value = '';
        
        if (!apiKey) {
            // If no API key, just show the API key dialog
            apiKeyContainer.style.display = 'flex';
            return;
        }
        
        // Show prompt suggestions after first message if not already shown
        if (!hasUserSentMessage) {
            hasUserSentMessage = true;
            promptSuggestionsContainer.style.display = 'block';
            // Display placeholder prompts for initial suggestions
            displayPlaceholderPrompts();
        }
        
        sendToAI(message);
    }
}

function addMessage(content, type) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message', type);
    
    // Create message content without timestamp for user messages
    messageDiv.innerHTML = `<div class="message-content">${content}</div>`;
    
    // Add "Send to Figma" button for system messages
    if (type === 'system') {
        // Create the send to Figma button
        const sendToFigmaButton = document.createElement('button');
        sendToFigmaButton.className = 'send-to-figma';
        sendToFigmaButton.title = 'Send to Figma';
        sendToFigmaButton.setAttribute('data-tooltip', 'Send to Figma');
        sendToFigmaButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 13h11.17l-4.88 4.88c-.39.39-.39 1.03 0 1.42.39.39 1.02.39 1.41 0l6.59-6.59c.39-.39.39-1.02 0-1.41l-6.58-6.6c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41L16.17 11H5c-.55 0-1 .45-1 1s.45 1 1 1z"/>
            </svg>
        `;
        
        // Add click event to send content to Figma
        sendToFigmaButton.addEventListener('click', () => {
            // Get the message content
            const messageContent = messageDiv.querySelector('.message-content');
            const textContent = messageContent.textContent;
            const htmlContent = messageContent.innerHTML;
            
            // Send to Figma
            parent.postMessage({ 
                pluginMessage: { 
                    type: 'create-text-frame', 
                    text: textContent,
                    html: htmlContent
                } 
            }, '*');
            
            // No popup notification - Figma will show its own notification
        });
        
        // Add the button to the message
        messageDiv.appendChild(sendToFigmaButton);
    }
    
    // Add message to chat
    chatMessages.appendChild(messageDiv);
    
    // Add timestamp for user messages only, but outside the bubble
    if (type === 'user') {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const timestamp = `${hours}:${minutes}`;
        
        const timestampDiv = document.createElement('div');
        timestampDiv.classList.add('message-timestamp');
        timestampDiv.style.textAlign = 'right';
        timestampDiv.textContent = timestamp;
        
        chatMessages.appendChild(timestampDiv);
    }
    
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Update the sendToAI function to handle markdown tables
async function sendToAI(message) {
    try {
        // Disable chat input and send button while generating
        const chatInput = document.querySelector('.chat-input');
        const sendButton = document.getElementById('sendButton');
        chatInput.disabled = true;
        sendButton.disabled = true;
        chatInput.placeholder = 'AI is generating...';
        
        // Show typing indicator
        const aiMessageElement = document.createElement('div');
        aiMessageElement.classList.add('message', 'system');
        aiMessageElement.innerHTML = `<div class="message-content typing-indicator">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
        </div>`;
        chatMessages.appendChild(aiMessageElement);
        
        // Initialize user scroll tracking
        let userHasScrolled = false;
        
        // Add scroll event listener to detect manual scrolling
        const scrollHandler = () => {
            // If user scrolls up during generation, mark as manually scrolled
            if (chatMessages.scrollTop < chatMessages.scrollHeight - chatMessages.clientHeight - 10) {
                userHasScrolled = true;
            }
        };
        
        chatMessages.addEventListener('scroll', scrollHandler);
        
        // Initial scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Check if this is a prompt from the tabs (Persona or Style Guide)
        const isPromptTabMessage = message.startsWith("I need to create a realistic persona") || 
                                  message.startsWith("Please generate a comprehensive style guide");
        
        // Get conversation history for context (only if not a prompt tab message)
        let conversationHistory = [];
        
        if (!isPromptTabMessage) {
            const messages = document.querySelectorAll('.message');
            
            const maxMessages = 20; // Increase from 10 to 20 messages for better context
            let count = 0;
            let foundProjectOverview = false;
            
            for (let i = messages.length - 1; i >= 0 && count < maxMessages; i--) {
                const message = messages[i];
                // Skip the typing indicator we just added
                if (message === aiMessageElement) continue;
                
                // Get the message content element specifically
                const messageContentElement = message.querySelector('.message-content');
                if (!messageContentElement) continue;
                
                // Skip typing indicators
                if (!messageContentElement.querySelector('.typing-indicator')) {
                    // Extract text from the message content element only
                    const text = messageContentElement.textContent.trim();
                    
                    // Check if this is the project overview message
                    if (text.includes('Project Information Sent')) {
                        foundProjectOverview = true;
                        continue; // Skip the project overview message itself
                    }
                    
                    // Only include messages after the project overview was sent
                    if (!projectOverviewSentToChat || (projectOverviewSentToChat && foundProjectOverview)) {
                        // Clean the text to remove any UI elements text that might be included
                        const cleanedText = cleanMessageContent(text);
                        
                        // Only add non-empty messages
                        if (cleanedText) {
                            // Map 'system' class to 'assistant' role for OpenAI API
                            const type = message.classList.contains('user') ? 'user' : 'assistant';
                            conversationHistory.unshift({
                                role: type,
                                content: cleanedText
                            });
                            count++;
                        }
                    }
                }
            }
        }
        
        // Only include project context if it has been explicitly sent to the chat
        let projectContext = '';
        if (projectOverviewSentToChat) {
            projectContext = `
Current project: ${projectData.projectName || 'Untitled Project'}

1. Project Description:
${projectData.projectDescription || 'Not specified'}

2. Target Audience:
${projectData.targetAudience || 'Not specified'}

3. Project Type:
${projectData.projectType || 'Not specified'}

4. Main Goal:
${projectData.mainGoals.length ? projectData.mainGoals.join(', ') : 'Not specified'}

5. Design Style:
${projectData.designStyle.length ? projectData.designStyle.join(', ') : 'Not specified'}

6. Figma Experience:
${projectData.figmaExperience || 'Not specified'}

7. Complexity:
${projectData.complexity || 'Not specified'}

8. Purposes:
${projectData.purposes || 'Not specified'}

9. Design Stage:
${projectData.designStage || 'Not specified'}

10. Additional Guidelines:
${projectData.guidelines || 'Not specified'}
`;
        }

        // Enhanced system prompt with project context
        const systemPrompt = `You are a (Western-)European AI UI/UX Design Assistant integrated into a Figma plugin named PromptlyUX. 
        About you:
        - As an expert in UI/UX principles and Figma, provide users with specific, actionable design advice. Use markdown formatting for better readability. 
        - DO NOT give ANY introductions or conclusions to your responses. ESPECIALLY NEVER when asked to directly generate something (e.g. Style Guide, Persona).
        - Plugin functionalities: An AI chat as an assistance for the design workflow in Figma with constant question suggestions after each AI response. When the user hovers over each response a small purple arrow appears at the bottom right, and with this arrow the user can send the generated answer to Figma. At the top you see a plus and a minus with the number 100% where you can can zoom in and out for beter readability. The two pill shaped tabs above the chat input are topic and prompt suggestions which you can regenerate with the button next to it. The other section besides "Chat" is called "Prompts" and here the user can put in their project information so the system has a better overview of the scope of the project. Also a there is a prompt library category with dropdown menus where you can find premade prompts, which you can edit, copy, save and send the AI chat. And lastly there is a category called generate prompts where the user can fill in a topic and the system will generate prompt suggestions for that topic. The user can choose to include their project information in this prompt generation.
        - When the user asks about the functionalities of the plugin give a clear overview of the two main features: AI chat and Prompts. Elaborate first on the features of the chat then of every category behind the Prompts section. VERY IMPORTANT: emphasize the user should do the "Getting Started" survey first so the system can better understand the scope of the project!
        - The name of your creator is Daphne Varekamp, she developed the Figma plugin for her masters degree (called Media Technology) at Leiden University.
        - Try to include more international and non Northen American examples in your responses.

About the project:
${projectContext}

${isPromptTabMessage ? 
  'This is a direct request to generate content based on the project information. Provide a detailed and concise response without elaborate jargon and filler text.' : 
  (projectOverviewSentToChat ? 
    'Always keep this project context in mind when responding. Your advice should be specifically tailored to this project, its goals, audience, and design stage. Refer back to relevant aspects of the project context in your responses.' : 
    'The user has not shared any project information yet. Provide general UI/UX advice or ask for more specific details about their project to give more tailored recommendations.')}`;
        
        // Prepare messages array for the API request
        let apiMessages = [
            {
                role: 'system',
                content: systemPrompt
            }
        ];
        
        // Add conversation history to the messages array only if not a prompt tab message
        if (!isPromptTabMessage && conversationHistory.length > 0) {
            console.log('Conversation history collected:', conversationHistory);
            apiMessages = apiMessages.concat(conversationHistory);
        } else {
            console.log('No conversation history included');
        }
        
        // Add the current message
        apiMessages.push({
            role: 'user',
            content: message
        });
        
        console.log('Final API messages:', apiMessages);
        
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: apiMessages,
                temperature: 0.7,
                max_tokens: 1000,
                stream: true
            })
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const errorMessage = errorData.error?.message || `API Error (${response.status})`;
            throw new Error(errorMessage);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let responseText = '';
        
        // Remove typing indicator and prepare for actual content
        aiMessageElement.innerHTML = '<div class="message-content"></div>';
        const messageContent = aiMessageElement.querySelector('.message-content');
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) {
                // Add the "Send to Figma" button after the response is complete
                const sendToFigmaButton = document.createElement('button');
                sendToFigmaButton.className = 'send-to-figma';
                sendToFigmaButton.title = 'Send to Figma';
                sendToFigmaButton.setAttribute('data-tooltip', 'Send to Figma');
                sendToFigmaButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 13h11.17l-4.88 4.88c-.39.39-.39 1.03 0 1.42.39.39 1.02.39 1.41 0l6.59-6.59c.39-.39.39-1.02 0-1.41l-6.58-6.6c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41L16.17 11H5c-.55 0-1 .45-1 1s.45 1 1 1z"/>
                    </svg>
                `;
                
                // Add click event to send content to Figma
                sendToFigmaButton.addEventListener('click', () => {
                    // Get the message content
                    const textContent = messageContent.textContent;
                    const htmlContent = messageContent.innerHTML;
                    
                    // Send to Figma
                    parent.postMessage({ 
                        pluginMessage: { 
                            type: 'create-text-frame', 
                            text: textContent,
                            html: htmlContent
                        } 
                    }, '*');
                    
                    // No popup notification - Figma will show its own notification
                });
                
                // Add the button to the message
                aiMessageElement.appendChild(sendToFigmaButton);
                
                // Add a suggestion bubble with a follow-up question
                addSuggestionBubble(aiMessageElement);
                
                // Only scroll to bottom when the response is complete
                chatMessages.scrollTop = chatMessages.scrollHeight;
                break;
            }
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            
            for (const line of lines) {
                if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                    try {
                        const json = JSON.parse(line.slice(5));
                        const content = json.choices[0].delta.content;
                        if (content) {
                            responseText += content;
                            const formattedResponse = responseText
                                // Headers (update order to handle #### first)
                                .replace(/^#### (.*?)$/gm, '<h4>$1</h4>')
                                .replace(/^### (.*?)$/gm, '<h3>$1</h3>')
                                .replace(/^## (.*?)$/gm, '<h2>$1</h2>')
                                .replace(/^# (.*?)$/gm, '<h1>$1</h1>')
                                // Remove !Color Palette links and variations
                                .replace(/!Color Palette/gi, 'Color Palette')
                                .replace(/!color palette/gi, 'Color Palette')
                                // Wrap plain text in paragraphs
                                .replace(/^(?!<[h|p|ul|ol|li|div|code|table|thead|tbody|tr|th|td])(.*?)$/gm, '<p>$1</p>')
                                // Bold and Italic
                                .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
                                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                                // Code
                                .replace(/`([^`]+)`/g, '<code>$1</code>')
                                // Lists
                                .replace(/^\d+\.\s+(.*?)$/gm, '<div class="list-item">$1</div>')
                                .replace(/^[-*]\s+(.*?)$/gm, '<div class="list-item">• $1</div>')
                                // Links
                                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
                                // Color codes - Hex (both #fff and #ffffff formats)
                                .replace(/(#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3}))\b/g, '<span class="color-preview" style="background-color: $1; display: inline-block; width: 12px; height: 12px; border-radius: 3px; margin-right: 4px; vertical-align: middle; border: 1px solid #ccc;"></span><span class="color-code">$1</span>')
                                // Color codes - RGB/RGBA
                                .replace(/(rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)|rgba\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3}),\s*(0?\.\d+|1(\.0)?)\))/g, function(match) {
                                    return `<span class="color-preview" style="background-color: ${match}; display: inline-block; width: 12px; height: 12px; border-radius: 3px; margin-right: 4px; vertical-align: middle; border: 1px solid #ccc;"></span><span class="color-code">${match}</span>`;
                                })
                                // Horizontal Rules
                                .replace(/^---+$/gm, '<hr>')
                                .replace(/^===+$/gm, '<hr>')
                                .replace(/^\*\*\*+$/gm, '<hr>')
                                // Tables - improved handling
                                .replace(/^\|(.*)\|$/gm, function(match, content) {
                                    // Split the table row by pipes
                                    const cells = content.split('|').map(cell => cell.trim());
                                    // Check if this is a header separator row
                                    if (cells.every(cell => /^:?-+:?$/.test(cell))) {
                                        return ''; // Skip separator rows
                                    }
                                    // Create table cells
                                    const cellsHtml = cells.map(cell => `<td>${cell}</td>`).join('');
                                    return `<tr>${cellsHtml}</tr>`;
                                })
                                // Wrap tables with proper table structure
                                .replace(/(<tr>.*?<\/tr>)\s*(<tr>.*?<\/tr>)/gs, function(match, headerRow, bodyRows) {
                                    return `<table><thead>${headerRow}</thead><tbody>${bodyRows}</tbody></table>`;
                                })
                                // Line breaks
                                .replace(/\n\n/g, '<br><br>')
                                .replace(/\n/g, '<br>');
                            
                            messageContent.innerHTML = formattedResponse;
                        }
                    } catch (e) {
                        console.error('Error parsing chunk:', e);
                    }
                }
            }
        }
        
    } catch (error) {
        console.error('Error sending to AI:', error);
        
        // Remove typing indicator if it exists
        const typingIndicator = document.querySelector('.typing-indicator');
        if (typingIndicator) {
            typingIndicator.parentElement.remove();
        }
        
        // Add specific error message
        let errorMessage = 'API Error. Please check your API key and try again.';
        
        if (error.message.includes('API key')) {
            errorMessage = 'Invalid API key. Please verify your API key and try again.';
        } else if (error.message.includes('billing')) {
            errorMessage = 'Billing issue with your OpenAI account. Please check your billing status.';
        } else if (error.message.includes('rate limit')) {
            errorMessage = 'Rate limit exceeded. Please try again in a few moments.';
        } else if (error.message.includes('model')) {
            errorMessage = 'The requested model is unavailable. Please try a different model.';
        } else if (error.message.includes('network')) {
            errorMessage = 'Network error. Please check your internet connection and try again.';
        }
        
        addMessage(`Error: ${errorMessage}`, 'system');
    } finally {
        // Re-enable chat input and send button, and restore placeholder
        const chatInput = document.querySelector('.chat-input');
        const sendButton = document.getElementById('sendButton');
        chatInput.disabled = false;
        sendButton.disabled = false;
        chatInput.placeholder = 'Type your message...';
    }
}

// Add this function near the top with other initialization functions
function displayPlaceholderPrompts() {
    // Check if project data is filled in
    const hasProjectData = projectData.projectType !== '' || 
                          projectData.projectDescription !== '' || 
                          projectData.targetAudience !== '';
    
    // Function to process placeholders in text
    const processPlaceholders = (text) => {
        // Replace common placeholders with project data if available
        return text
            .replace(/\[describe product\/service\/platform\]/g, hasProjectData && projectData.projectType !== '' ? 
                projectData.projectType : 
                '<span style="color:var(--main-purple)">[describe product/service/platform]</span>')
            
            .replace(/\[specific problem or market need\]/g, hasProjectData && projectData.projectDescription !== '' ? 
                `${projectData.projectDescription.split('.')[0]}` : 
                '<span style="color:var(--main-purple)">[specific problem or market need]</span>')
            
            .replace(/\[specific purpose\]/g, hasProjectData && projectData.mainGoals.length ? 
                projectData.mainGoals[0] : 
                '<span style="color:var(--main-purple)">[specific purpose]</span>')
            
            .replace(/\[target audience characteristics\]/g, hasProjectData && projectData.targetAudience !== '' ? 
                projectData.targetAudience : 
                '<span style="color:var(--main-purple)">[target audience characteristics]</span>');
    };
    
    let placeholderSuggestions = [];
    
    // Different prompts based on whether project overview has been sent to chat
    if (projectOverviewSentToChat) {
        // Persona prompt with project data incorporated - NO conversation history
        const personaPrompt = `I need to create a realistic persona for a [${projectData.projectType || 'my project'}] focused on [${projectData.mainGoals.length ? projectData.mainGoals.join(' and ') : 'improving user experience'}]. 
This is the project description: [${projectData.projectDescription || 'No project description provided'}].
Please generate one detailed persona that represents [${projectData.targetAudience || 'my target audience'}] with the following details:<br>

• Demographic: Name, age, occupation, and location <br>
• Personal: background and lifestyle <br>
• Personality (traits)<br>
• Hobbies (and interests) <br>
• Goals (and motivations) <br>
• Challenges (and pain points they face) <br>
• Considerations: Decision-making factors when choosing [${projectData.projectDescription || 'No project description provided'}] <br>
• Product interaction: How they might interact with an [${projectData.projectType}] <br>
• Quote: A unique deep quote <br>

Important: separate these topics by clear and short headings + paragraphs/lists. Make the persona have a CONSISTENT age and personality throughout. Be detailed, yet concise.`;

        // Style guide prompt with project data incorporated - NO conversation history
        const styleGuidePrompt = `Please generate a comprehensive style guide for a [${projectData.projectType || 'product'}]] with a[ [${projectData.designStyle.length ? projectData.designStyle.join('/') : 'modern]'}] design approach. Our target audience [is [${projectData.targetAudience || 'our use]rs'}] and our main goals inc[lude [${projectData.mainGoals.length ? projectData.mainGoals.join(' and ') : 'usability and engage]ment'}].

This guide should include:<br>
• Brand Tone & Voice: Writing style, formality level, and messaging tone that resonates with [${projectData.targetAudience || 'our users'}] and aligns with our [${projectData.designStyle.length ? projectData.designStyle.join('/') : 'modern'}] approach.<br>
• Typography: Approved fonts and their applications that support [${projectData.mainGoals.length ? projectData.mainGoals.join(' and ') : 'usability and engagement'}]<br>
• Color Palette: For example background, primary, secondary, accent, hover colors WITH hex codes, but also think about colors for specific features that reflect design direction<br>
• Imagery: Guidelines for photographs, illustrations, graphs and other visual content that appeal to [${projectData.targetAudience || 'our users'}]<br>
• Headings and Subheadings: Guidelines for hierarchy and formatting that enhance [${projectData.mainGoals.length ? projectData.mainGoals[0] : 'user experience'}]<br>
• Buttons: Styles (filled, outlined, text), sizes, and interaction states (default, hover, pressed, disabled) optimized for [${projectData.projectType || 'our product'}]<br>
• Forms & Inputs: Text fields, dropdowns, checkboxes, radio buttons, sliders that align with [${projectData.designStyle.length ? projectData.designStyle.join('/') : 'modern'}] standards<br>
• Navigation: Bottom tab bar, side menu, breadcrumbs, gestures designed for [${projectData.targetAudience || 'our users'}]'s needs<br>
• Cards & Containers: Usage, padding, borders, and shadowing that complement our [${projectData.designStyle.length ? projectData.designStyle.join('/') : 'modern'}] aesthetic<br>
• Gestures: Swipe, tap, long press, pinch, and drag behaviors suited to [${projectData.targetAudience || 'our users'}]'s tech comfort level<br>
• Best practices to ensure content is accessible to all users, particularly considering [${projectData.targetAudience || 'our target audience'}]<br>

Be detailed, yet concise.`;

        placeholderSuggestions = [
            {
                title: "Persona",
                prompt: personaPrompt
            },
            {
                title: "Style Guide",
                prompt: styleGuidePrompt
            }
        ];
    } else {
        // Default prompts when no project overview has been sent - NO conversation history
        placeholderSuggestions = [
        {
            title: "Persona",
                prompt: processPlaceholders("I need to create a realistic persona for a [specific purpose]. Please generate one detailed persona that includes: demographic information, personal background, hobbies, goals and motivations, pain points and challenges, daily routine, and technology usage. The persona should represent [target audience characteristics] and have a consistent personality throughout. Important: show this information of all these items by headings + paragraphs/lists. Be detailed, yet concise.")
            },
            {
                title: "Style Guide",
                prompt: processPlaceholders(`Please generate a comprehensive style guide for [describe product/service/platform]. This guide should include:<br>
• Brand Tone & Voice: Writing style, formality level, and messaging tone<br>
• Typography: Approved fonts and their applications<br>
• Color Palette: For example background, primary, secondary, accent, hover, colors etc. with hex codes<br>
• Imagery: Guidelines for photographs, illustrations, graphs and other visual content<br>
• Headings and Subheadings: Guidelines for hierarchy and formatting<br>
• Buttons: Styles (filled, outlined, text), sizes, and interaction states (default, hover, pressed, disabled)<br>
• Forms & Inputs: Text fields, dropdowns, checkboxes, radio buttons, sliders<br>
• Navigation: Bottom tab bar, side menu, breadcrumbs, gestures<br>
• Cards & Containers: Usage, padding, borders, and shadowing<br>
• Gestures: Swipe, tap, long press, pinch, and drag behaviors<br>
• Best practices to ensure content is accessible to all users<br><br>

Be detailed, yet concise.`)
            }
        ];
    }
    
    updatePromptSuggestionTabs(placeholderSuggestions);
}

function updatePromptSuggestionTabs(suggestions) {
    const promptSuggestionsContainer = document.getElementById('promptSuggestions');
    promptSuggestionsContainer.innerHTML = '';
    
    // Limit to exactly 2 suggestions
    const displaySuggestions = suggestions.slice(0, 2);
    
    // Create a tab for each suggestion
    displaySuggestions.forEach(suggestion => {
        // Limit title to two words and ensure it's not too long
        let title = suggestion.title.split(' ').slice(0, 2).join(' ');
        // If title is still too long, truncate it
        if (title.length > 15) {
            title = title.substring(0, 15) + '...';
        }
        
        const tab = document.createElement('div');
        tab.className = 'prompt-tab';
        tab.innerHTML = `
            <div class="prompt-tab-header">${title}</div>
        `;
        
        tab.addEventListener('click', () => {
            showPromptPopup(suggestion.title, suggestion.prompt, false);
        });
        
        promptSuggestionsContainer.appendChild(tab);
    });
}

// Add a function to show prompt suggestion tabs with loading animation
function showPromptSuggestionTabsWithLoading() {
    const promptSuggestionsContainer = document.querySelector('.prompt-suggestions-container');
    if (promptSuggestionsContainer) {
        promptSuggestionsContainer.style.display = 'block';
    }
    
    const promptSuggestionsElement = document.getElementById('promptSuggestions');
    promptSuggestionsElement.innerHTML = '';
    
    // Create loading animation for tabs
    for (let i = 0; i < 2; i++) {
        const loadingTab = document.createElement('div');
        loadingTab.className = 'prompt-tab';
        loadingTab.innerHTML = `
            <div class="prompt-tab-header">
                <div class="loading-dot-container" style="display: flex; justify-content: center; padding: 4px 0;">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
        `;
        promptSuggestionsElement.appendChild(loadingTab);
    }
    
    // Make the prompt suggestions row visible
    const promptSuggestionsRow = document.querySelector('.prompt-suggestions-row');
    if (promptSuggestionsRow) {
        promptSuggestionsRow.style.display = 'flex';
    }
}

// Update the showPromptPopup function to move the close button to the popup itself and improve the save button styling.
function showPromptPopup(title, prompt, isProjectOverview = false) {
    const overlay = document.createElement('div');
    overlay.className = 'prompt-overlay';
    
    // Format the prompt content to preserve line breaks and lists
    const formattedPrompt = prompt
        .replace(/\[([^\]]+)\]/g, '<span style="color:var(--main-purple)">[$1]</span>') // Color bracket placeholders
        .replace(/\n\n/g, '</p><p>') // Convert double line breaks to paragraphs
        .replace(/\n([0-9]+\.|•)/g, '</p><p>$1') // Preserve list items
        .replace(/\n/g, '<br>') // Convert single line breaks to <br>
        .replace(/^/, '<p>') // Add opening paragraph
        .replace(/$/, '</p>'); // Add closing paragraph
    
    const popup = document.createElement('div');
    popup.className = 'prompt-popup';
    if (isProjectOverview) {
        popup.setAttribute('data-is-project-overview', 'true');
    }
    
    // Create the popup HTML - hide regenerate button for project overview
    popup.innerHTML = `
        <div style="position: relative;">
            <button class="close-prompt" style="position:absolute;top:0;right:0;background:none;border:none;font-size:24px;cursor:pointer;color:var(--light-gray);">×</button>
            <h3 style="margin-top: 0; padding-right: 24px; color: var(--white-1); font-size: var(--fs-4);">${title}</h3>
        </div>
        <div class="prompt-content" contenteditable="false">${formattedPrompt}</div>
        <div class="prompt-actions">
            ${isProjectOverview ? '' : `
            <button class="regenerate-prompt" data-tooltip="Regenerate">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M23 4v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M1 20v-6h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            `}
            <button class="copy-prompt" data-tooltip="Copy">
                <svg class="copy-text" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 9H11C9.89543 9 9 9.89543 9 11V20C9 21.1046 9.89543 22 11 22H20C21.1046 22 22 21.1046 22 20V11C22 9.89543 21.1046 9 20 9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M5 15H4C3.46957 15 2.96086 14.7893 2.58579 14.4142C2.21071 14.0391 2 13.5304 2 13V4C2 3.46957 2.21071 2.96086 2.58579 2.58579C2.96086 2.21071 3.46957 2 4 2H13C13.5304 2 14.0391 2.21071 14.4142 2.58579C14.7893 2.96086 15 3.46957 15 4V5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <svg class="copied-text" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <button class="send-to-chat" data-tooltip="Send to chat">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <button class="edit-button" data-tooltip="Edit">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18.5 2.50001C18.8978 2.10219 19.4374 1.87869 20 1.87869C20.5626 1.87869 21.1022 2.10219 21.5 2.50001C21.8978 2.89784 22.1213 3.4374 22.1213 4.00001C22.1213 4.56262 21.8978 5.10219 21.5 5.50001L12 15L8 16L9 12L18.5 2.50001Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <button class="save-button" data-tooltip="Save" style="display: none; background: var(--eerie-black-1); border-color: var(--main-purple); color: var(--main-purple);">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16L21 8V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M17 21V13H7V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M7 3V8H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    `;
    
    overlay.appendChild(popup);
    document.body.appendChild(overlay);
    
    const promptContent = popup.querySelector('.prompt-content');
    const editButton = popup.querySelector('.edit-button');
    const saveButton = popup.querySelector('.save-button');
    const regenerateButton = popup.querySelector('.regenerate-prompt');
    
    // Close button handler
    popup.querySelector('.close-prompt').addEventListener('click', () => {
        document.body.removeChild(overlay);
    });
    
    // Regenerate button handler - only add if the button exists
    if (regenerateButton) {
    regenerateButton.addEventListener('click', () => {
        // Show loading state in the prompt content
        const originalPrompt = promptContent.innerHTML;
        promptContent.innerHTML = `
            <div class="loading-dot-container" style="margin: 20px auto;">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
        `;
        
        // Generate a new prompt based on the title
        generateSinglePrompt(title)
            .then(newPrompt => {
                    // Format the new prompt with purple brackets
                    const formattedPrompt = newPrompt
                        .replace(/\[([^\]]+)\]/g, '<span style="color:var(--main-purple)">[$1]</span>')
                        .replace(/\n\n/g, '</p><p>')
                        .replace(/\n([0-9]+\.|•)/g, '</p><p>$1')
                        .replace(/\n/g, '<br>')
                        .replace(/^/, '<p>')
                        .replace(/$/, '</p>');
                    
                    promptContent.innerHTML = formattedPrompt;
            })
            .catch(error => {
                console.error('Error regenerating prompt:', error);
                promptContent.innerHTML = originalPrompt;
            });
    });
    }
    
    // Copy button handler
    popup.querySelector('.copy-prompt').addEventListener('click', () => {
        // Create a temporary textarea element to handle the copying
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = promptContent.textContent;
        // Make the textarea invisible
        tempTextArea.style.position = 'absolute';
        tempTextArea.style.left = '-9999px';
        tempTextArea.style.top = '0';
        tempTextArea.style.opacity = '0';
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        
        try {
            // Execute the copy command
            document.execCommand('copy');
            
            // Visual feedback
            const copyBtn = popup.querySelector('.copy-prompt');
            copyBtn.classList.add('copied');
            
            setTimeout(() => {
                copyBtn.classList.remove('copied');
            }, 2000);
            
            console.log('Prompt copied to clipboard');
        } catch (err) {
            console.error('Failed to copy text: ', err);
        } finally {
            // Remove the temporary element
            document.body.removeChild(tempTextArea);
        }
    });
    
    // Send to chat button handler
    popup.querySelector('.send-to-chat').addEventListener('click', () => {
        // Switch to chat tab
        document.querySelector('.nav-tab[data-section="chat"]').click();
        
        if (isProjectOverview) {
            // Set flag to indicate project overview has been sent to chat
            projectOverviewSentToChat = true;
            
            // Add the special project information messages
            addMessage('<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Project Information Sent', 'user'); 
            addMessage('<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Received', 'system');
            
            // Show prompt suggestion tabs with loading animation
            showPromptSuggestionTabsWithLoading();
            
            // Update placeholder prompts to use project data
            displayPlaceholderPrompts();
        } else {
            // For regular prompts, add the message to the chat input and send it
            const chatInput = document.querySelector('.chat-input');
            if (chatInput) {
                chatInput.value = promptContent.textContent;
                chatInput.disabled = false;
                
                // Focus the chat input
                setTimeout(() => {
        chatInput.focus();
                    
                    // Simulate pressing Enter to send the message
                    const event = new KeyboardEvent('keydown', {
                        key: 'Enter',
                        code: 'Enter',
                        which: 13,
                        keyCode: 13,
                        bubbles: true
                    });
                    
                    chatInput.dispatchEvent(event);
                }, 100);
            }
        }
        
        // Close the popup
        document.body.removeChild(overlay);
    });
    
    // Edit button handler
    editButton.addEventListener('click', () => {
        promptContent.contentEditable = 'true';
        promptContent.focus();
        editButton.style.display = 'none';
        saveButton.style.display = 'inline-flex';
    });
    
    // Save button handler
    saveButton.addEventListener('click', () => {
        promptContent.contentEditable = 'false';
        saveButton.style.display = 'none';
        editButton.style.display = 'inline-flex';
    });
}

// Add a new function to generate a single prompt based on a title
async function generateSinglePrompt(title) {
    // Check if API key is available
    if (!apiKey) {
        // Show API key dialog if no key is available
        apiKeyContainer.style.display = 'flex';
        return '';
    }
    
    try {
        // Check if project overview button has been clicked
        const projectOverviewButton = document.querySelector('#projectOverviewButton');
        const hasProjectData = projectOverviewButton ? projectOverviewButton.classList.contains('clicked') : false;
        
        // Prepare context for generating a single prompt
        const context = {
            projectName: projectData.projectName || 'Untitled Project',
            projectType: projectData.projectType || '',
            designStage: projectData.designStage || '',
            targetAudience: projectData.targetAudience || '',
            mainGoals: projectData.mainGoals || [],
            projectDescription: projectData.projectDescription || '',
            designStyle: projectData.designStyle || [],
            complexity: projectData.complexity || '',
            purposes: projectData.purposes || ''
        };
        
        // Get conversation history for context
        const messages = document.querySelectorAll('.message');
        let conversationHistory = [];
        
        const maxMessages = 20; // Increase from 10 to 20 messages for better context
        let count = 0;
        for (let i = messages.length - 1; i >= 0 && count < maxMessages; i--) {
            const message = messages[i];
            // Map 'system' class to 'assistant' role for OpenAI API
            const type = message.classList.contains('user') ? 'user' : 'assistant';
            
            // Get the message content element specifically
            const messageContentElement = message.querySelector('.message-content');
            if (!messageContentElement) continue;
            
            // Skip typing indicators
            if (!messageContentElement.querySelector('.typing-indicator')) {
                // Extract text from the message content element only
                const text = messageContentElement.textContent.trim();
                
                // Clean the text to remove any UI elements text that might be included
                const cleanedText = cleanMessageContent(text);
                
                // Only add non-empty messages
                if (cleanedText) {
                conversationHistory.unshift({
                        role: type === 'user' ? 'user' : 'assistant',
                        content: cleanedText
                });
                count++;
                }
            }
        }
        
        console.log('Conversation history for prompt generation:', conversationHistory);
        
        let systemContent, userContent;
        
        if (!hasProjectData) {
            // Generic system prompt if survey not filled in
            systemContent = `You generate prompt suggestions to ask an AI chat in a Plugin in Figma.
            Generate a detailed prompt which I can send to a large language model based on the given title.
            
            IMPORTANT GUIDELINES:
            1. Focus on general UI/UX design principles and best practices useful for within the Figma design environment (for example: make a persona, style guide, etc.).
            2. Include context suggestions in brackets (for example: for [platform], describe [target group], etc.)
            3. Ensure the prompt avoids using terms such as 'build,' 'design,' 'develop,' that insinuate building and focus on 'create' or 'generate' as the GPT can only reply with text.
            4. Make the prompts concise, and end every prompt with "Be detailed, yet concise"
            5. Try to make the prompts relevant to the conversation. For example, elaborate on previous answers and take them into account, but don't duplicate them.
            
            Respond with ONLY the prompt text, no additional commentary.`;
            
            userContent = `Generate a prompt for this topic: "${title}"
            
            Recent conversation history: ${JSON.stringify(conversationHistory)}

            Remember the guidelines.`;
        } else {
            // Project-specific system prompt if survey is filled in
            systemContent = `You generate prompt suggestions to ask an AI chat in a Plugin in Figma.
            Generate a detailed prompt which I can send to a large language model based on the given title.
            
            IMPORTANT GUIDELINES:
            1. Focus on the PROJECT CONTEXT provided, e.g. "For a ${context.projectType} project targeting ${context.targetAudience}, how...".
            2. Ensure the prompt avoids using terms such as 'build,' 'design,' 'develop,' that insinuate building and focus on 'create' or 'generate' as the GPT can only reply with text.
            3. Make the prompt concise, and end every prompt with "Be detailed, yet concise"
            4. DIRECTLY REFERENCE specific project details in your prompt, such as:
               - "Considering that this project is for ${context.targetAudience || 'your target audience'}, could you..."
               - "Given that the project is in the ${context.designStage || 'current'} stage, how might..."
               - "With the goal of ${context.mainGoals.length ? context.mainGoals[0] : 'improving user experience'}, what..."
            5. Try to make the prompts relevant to the project conversation. For example, elaborate on previous answers and take them into account, but don't duplicate them.
            
            Respond with ONLY the prompt text, no additional commentary.`;
            
            userContent = `Generate a prompt for this topic: "${title}", take into consideration this project context: ${JSON.stringify(context)}
            
            Recent conversation history: ${JSON.stringify(conversationHistory)}

            Remember the guidelines.`;
        }
        
        // Call OpenAI to generate a single prompt based on the title
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: [
                    {
                        role: 'system',
                        content: systemContent
                    },
                    {
                        role: 'user',
                        content: userContent
                    }
                ],
                temperature: 0.7,
                max_tokens: 500
            })
        });
        
        if (!response.ok) {
            throw new Error(`API request failed with status ${response.status}`);
        }
        
        const data = await response.json();
        return data.choices[0].message.content.trim();
    } catch (error) {
        console.error('Error generating prompt:', error);
        return `I couldn't generate a new prompt for "${title}". Please try again later.`;
    }
}

// Update the generatePromptSuggestions function to default the project overview button clicked state to negative/turned off
async function generatePromptSuggestions(userMessage, aiResponse) {
    try {
        // Show loading state in the tabs
        updatePromptSuggestionsLoadingState();
        
        // Get the last few messages to identify recent topics
        const messages = document.querySelectorAll('.message');
        let recentTopics = [];
        
        // Extract potential topics from recent messages (last 3 user messages)
        let userMessageCount = 0;
        for (let i = messages.length - 1; i >= 0 && userMessageCount < 3; i--) {
            const message = messages[i];
            if (message.classList.contains('user')) {
                const text = message.textContent.trim().toLowerCase();
                // Extract potential topics (nouns and key terms)
                const words = text.split(/\s+/);
                for (const word of words) {
                    if (word.length > 4 && !recentTopics.includes(word)) {
                        recentTopics.push(word);
                    }
                }
                userMessageCount++;
            }
        }
        
        // Check if project data is filled in (default to false)
        const projectOverviewButton = document.querySelector('#projectOverviewButton');
        const hasProjectData = projectOverviewButton ? projectOverviewButton.classList.contains('clicked') : false;
        
        // Prepare context for generating suggestions with emphasis on project details
        const projectContext = {
            name: projectData.projectName || '',
            description: projectData.projectDescription || '',
            type: projectData.projectType || '',
            stage: projectData.designStage || '',
            audience: projectData.targetAudience || '',
            goals: projectData.mainGoals || [],
            style: projectData.designStyle || [],
            experience: projectData.figmaExperience || '',
            complexity: projectData.complexity || '',
            purposes: projectData.purposes || ''
        };
        
        // Latest conversation for context, but with less emphasis
        const conversationContext = {
            userMessage: userMessage,
            aiResponse: aiResponse.substring(0, 200) + (aiResponse.length > 200 ? '...' : ''),
            recentTopics: recentTopics
        };
        
        let systemContent, userContent;
        
        if (hasProjectData) {
            // Project-specific suggestions if survey is filled in
            systemContent = `You generate prompt suggestions to ask an AI chat in a Plugin in Figma.
            Generate a detailed prompt which I can send to a large language model based on the given title.
            Generate two prompts based on the project context, make the first one elaborate and the second one concise.
            
            Your response must be in this exact JSON format:
            [
                {
                    "title": "Short title (1-2 words)",
                    "prompt": "Detailed prompt text"
                },
                {
                    "title": "...",
                    "prompt": "..."
                }
            ]
            
            IMPORTANT GUIDELINES:
            1. Focus on the PROJECT CONTEXT.
            2. Generate DIVERSE suggestions that cover DIFFERENT aspects of the project.
            3. AVOID suggesting topics similar to the recent conversation topics: ${recentTopics.join(', ')}.
            4. Ensure the prompts avoid using terms such as 'create,' 'build,' 'design,' 'develop,' or any language that implies direct design actions.
            5. Make the prompts detailed yet concise.
            6. Keep titles very short (1-2 words).
            7. DIRECTLY REFERENCE specific project details in your prompts, such as:
               - "With this project description ${projectData.projectDescription || 'No project description provided'}, ..."
               - "Considering that this project is for ${projectData.targetAudience || 'the target audience'}, could you..."
               - "Given that the project is in the ${projectData.designStage || 'current'} stage, how might..."
               - "With the goal of ${projectData.mainGoals.length ? projectData.mainGoals[0] : 'improving user experience'}, what..."
               - "For a ${projectData.projectType || 'design'} project with ${projectData.complexity || 'this complexity'}, how..."
            
            Do not include any text outside of the JSON array.`;
            
            userContent = `Generate two DIVERSE prompt suggestions based on this project context: ${JSON.stringify(projectContext)}
            
            Recent conversation (for reference only, DO NOT focus solely on this): ${JSON.stringify(conversationContext)}
            
            Remember to:
            1. Suggest topics DIFFERENT from the recent conversation
            2. Cover varied aspects of the project
            3. DIRECTLY REFERENCE specific project details in your prompts (target audience, project type, design stage, goals, etc.)
            4. Frame questions in a way that acknowledges the specific project context, like "Given that you're designing for ${projectData.targetAudience || 'your audience'}..." or "Considering this is a ${projectData.projectType || 'design'} project..."`;
        } else {
            // Generic UI/UX suggestions if survey not filled in
            systemContent = `You generate prompt suggestions to ask an AI chat in a Plugin in Figma.
            Generate a detailed prompt which I can send to a large language model based on the given title.
            Generate two prompts based on the project context, make the first one elaborate and the second one concise.
            
            Your response must be in this exact JSON format:
            [
                {
                    "title": "Short title (1-2 words)",
                    "prompt": "Detailed prompt text"
                },
                {
                    "title": "...",
                    "prompt": "..."
                }
            ]
            
            IMPORTANT GUIDELINES:
            1. Focus on general UI/UX design principles which are relevant to ask a large language model within the Figma design environment (for example: make a persona, style guide, etc.).
            2. Include context suggestions in brackets (for example: for [platform], describe [target group], etc.)
            3. Generate DIVERSE suggestions that cover DIFFERENT aspects of design.
            4. AVOID suggesting topics similar to the recent conversation topics: ${recentTopics.join(', ')}.
            5. Ensure the prompts avoid using terms such as 'create,' 'build,' 'design,' 'develop,' or any language that implies direct design actions.
            
            Do not include any text outside of the JSON array.`;
            
            userContent = `Generate two DIVERSE prompt suggestions about UI/UX design.`;
        }
        
        // Call OpenAI to generate suggestions
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: [
                    {
                        role: 'system',
                        content: systemContent
                    },
                    {
                        role: 'user',
                        content: userContent
                    }
                ],
                temperature: 0.8,
                max_tokens: 1000
            })
        });

        if (!response.ok) throw new Error('Failed to generate suggestions');
        
        const data = await response.json();
        const suggestionsText = data.choices[0].message.content;
        
        // Parse the JSON response
        let suggestions;
        try {
            // Find JSON in the response
            const jsonMatch = suggestionsText.match(/\[[\s\S]*\]/);
            if (jsonMatch) {
                suggestions = JSON.parse(jsonMatch[0]);
                // Validate the structure of each suggestion
                suggestions = suggestions.map(suggestion => ({
                    title: suggestion.title || 'Design',
                    prompt: suggestion.prompt || 'Could not generate prompt'
                }));
            } else {
                throw new Error('No valid JSON found in response');
            }
        } catch (e) {
            console.error('Error parsing suggestions:', e);
            suggestions = getFallbackSuggestions();
        }
        
        // Update the UI with the suggestions
        updatePromptSuggestionTabs(suggestions);
    } catch (error) {
        console.error('Error generating suggestions:', error);
        updatePromptSuggestionTabs(getFallbackSuggestions());
    }
}

// Show loading state while suggestions are being generated
function updatePromptSuggestionsLoadingState() {
    const promptSuggestionsContainer = document.getElementById('promptSuggestions');
    promptSuggestionsContainer.innerHTML = '';
    
    // Create loading tabs with the same styling as the placeholder tabs
    for (let i = 0; i < 2; i++) {
        const tab = document.createElement('div');
        tab.className = 'prompt-tab';
        tab.style.minWidth = '120px'; // Ensure consistent width with regular tabs
        tab.style.flex = '1'; // Allow it to grow
        tab.innerHTML = `
            <div class="prompt-tab-header">
                <div class="loading-dot-container">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
        `;
        promptSuggestionsContainer.appendChild(tab);
    }
}

// Update the getFallbackSuggestions function to remove description
function getFallbackSuggestions() {
    return [
        {
            title: "Help",
            prompt: "I need guidance on my current design challenge. Based on my project context, what would you recommend?"
        },
        {
            title: "Next",
            prompt: "What should be my next steps in this design project based on the information I've shared so far?"
        }
    ];
}

// Show popup with detailed prompt
function showPromptSuggestionPopup(suggestion) {
    const overlay = document.createElement('div');
    overlay.className = 'prompt-overlay';
    
    const popup = document.createElement('div');
    popup.className = 'prompt-suggestion-popup';
    
    popup.innerHTML = `
        <button class="close-prompt" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:var(--light-gray);">×</button>
        <h3 class="prompt-suggestion-title">${suggestion.title}</h3>
        <div class="prompt-suggestion-content">${suggestion.description}</div>
        <div class="prompt-text" style="background:var(--eerie-black-2);padding:12px;border-radius:8px;margin-bottom:16px;color:var(--white-2);">${suggestion.prompt}</div>
        <div style="display:flex;justify-content:flex-end;gap:8px;">
            <button class="button copy-button">Copy</button>
            <button class="button button-primary send-prompt-button">Send</button>
        </div>
    `;
    
    overlay.appendChild(popup);
    document.body.appendChild(overlay);
    
    // Add event listeners
    popup.querySelector('.close-prompt').addEventListener('click', () => {
        document.body.removeChild(overlay);
    });
    
    // Add copy button functionality
    popup.querySelector('.copy-button').addEventListener('click', () => {
        const promptText = popup.querySelector('.prompt-text').textContent;
        
        // Create a temporary textarea element to handle the copying
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = promptText;
        // Make the textarea invisible
        tempTextArea.style.position = 'absolute';
        tempTextArea.style.left = '-9999px';
        tempTextArea.style.top = '0';
        tempTextArea.style.opacity = '0';
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        
        try {
            // Execute the copy command
            document.execCommand('copy');
            
            // Visual feedback
            const copyBtn = popup.querySelector('.copy-button');
            copyBtn.textContent = 'Copied!';
            
            setTimeout(() => {
                copyBtn.textContent = 'Copy';
            }, 2000);
            
            console.log('Prompt copied to clipboard');
        } catch (err) {
            console.error('Failed to copy text: ', err);
        } finally {
            // Remove the temporary element
            document.body.removeChild(tempTextArea);
        }
    });
    
    popup.querySelector('.send-prompt-button').addEventListener('click', () => {
        chatInput.value = suggestion.prompt;
        document.body.removeChild(overlay);
        sendMessage();
    });
    
    // Close when clicking outside the popup
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            document.body.removeChild(overlay);
        }
    });
}

// Plugin communication
function sendToPlugin(type, data = {}) {
    parent.postMessage({ pluginMessage: { type, ...data } }, '*');
}

// Add back the event listeners
sendButton.addEventListener('click', sendMessage);

chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Auto-resize textarea
chatInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});

// Prompt selection
document.querySelectorAll('.prompt-item').forEach(item => {
    item.addEventListener('click', () => {
        const promptTitle = item.querySelector('.prompt-title')?.textContent || '';
        sendToPlugin('prompt-selected', { promptTitle });
        document.querySelector('.nav-tab[data-section="chat"]').click();
        addMessage(`You've selected the "${promptTitle}" prompt. What details would you like to provide?`, 'system');
    });
});

// Button handlers
document.querySelector('.button-primary').addEventListener('click', () => {
    const projectDescription = document.querySelector('.text-input')?.value || '';
    const designStage = document.querySelector('.option-item.selected .option-label')?.textContent || '';
    const guidelines = document.querySelectorAll('.text-input')[1]?.value || '';
    
    sendToPlugin('questionnaire-complete', {
        data: {
            projectDescription,
            designStage,
            guidelines
        }
    });
    
    document.querySelector('.nav-tab[data-section="chat"]').click();
});

// Project data storage
let projectData = {
    projectName: '',
    projectDescription: '',
    targetAudience: '',
    projectType: '',
    mainGoals: [],
    figmaExperience: '',
    designStyle: [],
    complexity: '',
    purposes: '',
    designStage: '',
    guidelines: ''
};

// Flag to track if project overview has been sent to the chat
let projectOverviewSentToChat = false;

// Handle "Other" option with input field
document.querySelectorAll('.option-item.other').forEach(item => {
    item.addEventListener('click', () => {
        if (item.classList.contains('selected')) {
            // If already selected and has input, just focus on input
            const existingInput = item.querySelector('.other-input');
            if (existingInput) {
                existingInput.focus();
                return;
            }
        }
        
        // Create input field if it doesn't exist
        if (!item.querySelector('.other-input')) {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'other-input';
            input.placeholder = 'Please specify';
            
            // Prevent click from toggling selection
            input.addEventListener('click', e => e.stopPropagation());
            
            item.appendChild(input);
            input.focus();
        }
    });
});

  

// Generate project overview
function generateProjectOverview() {
    // Collect data from form
    projectData.projectDescription = document.getElementById('projectDescription').value || '';
    projectData.targetAudience = document.getElementById('targetAudience').value || '';
    projectData.purposes = document.getElementById('purposes').value || '';
    projectData.guidelines = document.getElementById('guidelines').value || '';
    
    // Get project type (single select)
    const projectTypeEl = document.querySelector('.question-item:nth-child(3) .option-item.selected');
    if (projectTypeEl) {
        if (projectTypeEl.classList.contains('other')) {
            const input = projectTypeEl.querySelector('.other-input');
            projectData.projectType = input && input.value ? input.value : 'Other';
        } else {
            projectData.projectType = projectTypeEl.getAttribute('data-value');
        }
    } else {
        projectData.projectType = 'Not specified';
    }
    
    // Get main goals (multiple select)
    projectData.mainGoals = [];
    document.querySelectorAll('.question-item:nth-child(4) .option-item.selected').forEach(item => {
        if (item.classList.contains('other')) {
            const input = item.querySelector('.other-input');
            if (input && input.value) projectData.mainGoals.push(input.value);
        } else {
            projectData.mainGoals.push(item.getAttribute('data-value'));
        }
    });
    
    // Get Figma experience (single select)
    const figmaExpEl = document.querySelector('.question-item:nth-child(5) .option-item.selected');
    if (figmaExpEl) {
        projectData.figmaExperience = figmaExpEl.getAttribute('data-value');
    } else {
        projectData.figmaExperience = 'Not specified';
    }
    
    // Get design style (single select)
    const designStyleEl = document.querySelector('.question-item:nth-child(6) .option-item.selected');
    if (designStyleEl) {
        projectData.designStyle = [designStyleEl.getAttribute('data-value')];
    } else {
        projectData.designStyle = [];
    }
    
    // Get complexity (single select)
    const complexityEl = document.querySelector('.question-item:nth-child(7) .option-item.selected');
    if (complexityEl) {
        projectData.complexity = complexityEl.getAttribute('data-value');
    } else {
        projectData.complexity = 'Not specified';
    }
    
    // Get design stage (single select)
    const designStageEl = document.querySelector('.question-item:nth-child(9) .option-item.selected');
    if (designStageEl) {
        projectData.designStage = designStageEl.getAttribute('data-value');
    } else {
        projectData.designStage = 'Not specified';
    }
    
    // Get project name from Figma (if available)
    parent.postMessage({ pluginMessage: { type: 'get-project-name' } }, '*');
    
    console.log('Project data collected:', projectData);
    
    return formatProjectOverview();
}

// Format project overview for display
function formatProjectOverview(includeIntroAndClosing = false) {
    const overviewContent = `<strong>Current project: ${projectData.projectName || 'Untitled Project'}</strong><br><br>

<strong>1. Project Description:</strong>
<span style="color:var(--main-purple)">${projectData.projectDescription || 'Not specified'}</span><br><br>

<strong>2. Target Audience:</strong>
<span style="color:var(--main-purple)">${projectData.targetAudience || 'Not specified'}</span><br><br>

<strong>3. Project Type:</strong>
<span style="color:var(--main-purple)">${projectData.projectType || 'Not specified'}</span><br><br>

<strong>4. Main Goal:</strong>
<span style="color:var(--main-purple)">${projectData.mainGoals.length ? projectData.mainGoals.join(', ') : 'Not specified'}</span><br><br>

<strong>5. Design Style:</strong>
<span style="color:var(--main-purple)">${projectData.designStyle.length ? projectData.designStyle.join(', ') : 'Not specified'}</span><br><br>

<strong>6. Figma Experience:</strong>
<span style="color:var(--main-purple)">${projectData.figmaExperience || 'Not specified'}</span><br><br>

<strong>7. Website Complexity:</strong>
<span style="color:var(--main-purple)">${projectData.complexity || 'Not specified'}</span><br><br>

<strong>8. Purposes:</strong>
<span style="color:var(--main-purple)">${projectData.purposes || 'Not specified'}</span><br><br>

<strong>9. Design Stage:</strong>
<span style="color:var(--main-purple)">${projectData.designStage || 'Not specified'}</span><br><br>

<strong>10. Additional Guidelines:</strong>
<span style="color:var(--main-purple)">${projectData.guidelines || 'Not specified'}</span>`;

    // For chat, we need plain text without HTML
    const plainOverviewContent = `Current project: ${projectData.projectName || 'Untitled Project'}

1. Project Description:
${projectData.projectDescription || 'Not specified'}

2. Target Audience:
${projectData.targetAudience || 'Not specified'}

3. Project Type:
${projectData.projectType || 'Not specified'}

4. Main Goal:
${projectData.mainGoals.length ? projectData.mainGoals.join(', ') : 'Not specified'}

5. Design Style:
${projectData.designStyle.length ? projectData.designStyle.join(', ') : 'Not specified'}

6. Figma Experience:
${projectData.figmaExperience || 'Not specified'}

7. Website Complexity:
${projectData.complexity || 'Not specified'}

8. Purposes:
${projectData.purposes || 'Not specified'}

9. Design Stage:
${projectData.designStage || 'Not specified'}

10. Additional Guidelines:
${projectData.guidelines || 'Not specified'}`;

    if (includeIntroAndClosing) {
        return `I am currently working on a Figma design project${projectData.projectName ? ' for ' + projectData.projectName : ''} with the following details:

${plainOverviewContent}

Take note of this information and acknowledge the details provided. Await further instructions before generating any recommendations.`;
    }
    
    return overviewContent;
}

// Handle Make Overview button click
document.getElementById('makeOverviewButton').addEventListener('click', () => {
    // Generate overview data first
    generateProjectOverview();
    
    // Request the project name from Figma
    parent.postMessage({ pluginMessage: { type: 'get-project-name' } }, '*');
    
    // Wait a short time for the project name to be received
            setTimeout(() => {
        const overview = formatProjectOverview(false);
        // Use the showPromptPopup function with isProjectOverview=true
        showPromptPopup('Project Overview', overview, true);
    }, 300); // Wait 300ms for the project name to be received
});

// Listen for project name from Figma
window.addEventListener('message', event => {
    const msg = event.data.pluginMessage;
    if (msg && msg.type === 'project-name') {
        projectData.projectName = msg.name || 'Untitled Project';
        console.log('Received project name from Figma:', projectData.projectName);
        
        // If the project name was just updated and we have a project overview popup open,
        // update the content to reflect the new project name
        const projectOverviewPopup = document.querySelector('.prompt-popup[data-is-project-overview="true"]');
        if (projectOverviewPopup) {
            const titleElement = projectOverviewPopup.querySelector('strong:first-child');
            if (titleElement) {
                titleElement.innerHTML = `Current project: ${projectData.projectName}`;
            }
        }
    }
});

// Generate design-stage-specific prompt suggestions
function generateDesignStagePrompts(designStage) {
    // Create a context-specific message for the AI to generate relevant suggestions
    // that are appropriate for the current design stage
    
    // Create a more detailed context message that emphasizes the project details
    const contextMessage = `I need prompt suggestions for my ${projectData.projectType || 'design'} project 
    called "${projectData.projectName || 'Untitled Project'}" 
    for ${projectData.targetAudience || 'users'} 
    at the ${designStage || 'initial'} stage 
    with goals including ${projectData.mainGoals.join(', ') || 'improving user experience'}.
    
    The project description is: ${projectData.projectDescription || 'Not specified'}
    
    The design style is: ${projectData.designStyle.join(', ') || 'Not specified'}
    
    Additional purposes: ${projectData.purposes || 'Not specified'}`;
    
    // Use the existing generatePromptSuggestions function with empty AI response
    // to ensure it focuses on project context rather than conversation
    generatePromptSuggestions(contextMessage, "");
}

// Add event listener for regenerate button
regenerateButton.addEventListener('click', () => {
    // Get the last few messages for context
    const messages = document.querySelectorAll('.message');
    let lastUserMessage = '';
    let lastAIResponse = '';
    
    // Find the last user message and AI response
    for (let i = messages.length - 1; i >= 0; i--) {
        const message = messages[i];
        if (message.classList.contains('user') && !lastUserMessage) {
            lastUserMessage = message.textContent.trim();
        } else if (message.classList.contains('system') && !lastAIResponse && !message.querySelector('.typing-indicator')) {
            lastAIResponse = message.textContent.trim();
        }
        
        if (lastUserMessage && lastAIResponse) break;
    }
    
    // Show loading state
    updatePromptSuggestionsLoadingState();
    
    // Generate new suggestions based on conversation context
    generatePromptSuggestions(lastUserMessage, lastAIResponse);
});

// Add the collapse toggle functionality
const collapseToggle = document.getElementById('collapseToggle');
collapseToggle.addEventListener('click', () => {
    document.body.classList.toggle('plugin-collapsed');
    collapseToggle.classList.toggle('collapsed');
    
    // Notify the plugin about the collapse state
    const isCollapsed = document.body.classList.contains('plugin-collapsed');
    sendToPlugin('toggle-collapse', { collapsed: isCollapsed });
});

// Add these functions near the top of your script
function closeApiKeyDialog() {
    apiKeyContainer.style.display = 'none';
    chatInput.disabled = false;
    sendButton.disabled = false;
}

// Add event listener for the close button
document.getElementById('closeApiDialog').addEventListener('click', closeApiKeyDialog);

// Add HTML Parser for Figma styling
window.addEventListener('message', (event) => {
    const message = event.data.pluginMessage;
    if (!message) return;
    
    if (message.type === 'parse-html') {
        const html = message.html;
        const parser = new DOMParser();
        const doc = parser.parseFromString(`<div>${html}</div>`, 'text/html');
        const container = doc.body.firstChild;
        
        const elements = [];
        parseElements(container, elements);
        
        // Send parsed elements back to the plugin
        parent.postMessage({ 
            pluginMessage: { 
                type: 'parsed-html-result', 
                elements: elements 
            } 
        }, '*');
    }
});

// Function to parse HTML elements recursively
function parseElements(container, elements) {
    if (!container || !container.childNodes) return;
    
    // Track sections by headings
    let currentSection = null;
    let currentSectionType = null;
    let currentSectionContent = '';
    let inBulletList = false;
    let bulletListContent = '';
    let inNumberedList = false;
    let numberedListContent = '';
    
    const finishCurrentSection = () => {
        if (currentSection && currentSectionContent.trim()) {
            elements.push({
                type: currentSectionType,
                text: currentSectionContent.trim()
            });
            currentSection = null;
            currentSectionType = null;
            currentSectionContent = '';
        }
    };
    
    const finishBulletList = () => {
        if (bulletListContent.trim()) {
            elements.push({
                type: 'bullet-list',
                text: bulletListContent.trim()
            });
            bulletListContent = '';
            inBulletList = false;
        }
    };
    
    const finishNumberedList = () => {
        if (numberedListContent.trim()) {
            elements.push({
                type: 'numbered-list',
                text: numberedListContent.trim()
            });
            numberedListContent = '';
            inNumberedList = false;
        }
    };
    
    // First pass: collect all headings to identify sections
    const headings = [];
    for (const node of container.childNodes) {
        if (node.nodeType === Node.ELEMENT_NODE && ['H1', 'H2', 'H3', 'H4', 'H5', 'H6'].includes(node.nodeName)) {
            headings.push({
                node: node,
                text: node.textContent.trim(),
                type: node.nodeName.toLowerCase()
            });
        }
    }
    
    // Process the content
    for (let i = 0; i < container.childNodes.length; i++) {
        const node = container.childNodes[i];
        
        // Text node
        if (node.nodeType === Node.TEXT_NODE) {
            const text = node.textContent;
            if (text.trim()) {
                // If we're in a bullet list, add to it
                if (inBulletList) {
                    bulletListContent += text;
                }
                // If we're in a numbered list, add to it
                else if (inNumberedList) {
                    numberedListContent += text;
                }
                // If we're in a section, add to it
                else if (currentSection) {
                    currentSectionContent += text;
                }
                // Otherwise, check parent type
                else {
                    let type = node.parentNode.nodeName.toLowerCase();
                    
                    // Check for special styling
                    if (node.parentNode.nodeName === 'STRONG' || node.parentNode.nodeName === 'B') {
                        type = 'strong';
                    } else if (node.parentNode.nodeName === 'EM' || node.parentNode.nodeName === 'I') {
                        type = 'em';
                    } else if (node.parentNode.nodeName === 'CODE') {
                        type = 'code';
                    }
                    
                    // If it's a paragraph or div, start a new section
                    if (['p', 'div'].includes(type)) {
                        currentSection = node.parentNode;
                        currentSectionType = 'content';
                        currentSectionContent = text;
                    } else {
                        // For inline elements, add directly
                        elements.push({
                            type: type,
                            text: text
                        });
                    }
                }
            }
        } 
        // Element node
        else if (node.nodeType === Node.ELEMENT_NODE) {
            // Handle headings - these always start a new section
            if (['H1', 'H2', 'H3', 'H4', 'H5', 'H6'].includes(node.nodeName)) {
                // Finish any current section or list
                finishCurrentSection();
                finishBulletList();
                finishNumberedList();
                
                const text = node.textContent.trim();
                if (text) {
                    elements.push({
                        type: node.nodeName.toLowerCase(),
                        text: text
                    });
                }
            }
            // Check if this is an ordered list (OL)
            else if (node.nodeName === 'OL') {
                // Process children directly to handle numbered items
                for (let j = 0; j < node.childNodes.length; j++) {
                    const childNode = node.childNodes[j];
                    if (childNode.nodeName === 'LI') {
                        // If not already in a numbered list, finish current section and start a new numbered list
                        if (!inNumberedList) {
                            finishCurrentSection();
                            finishBulletList();
                            inNumberedList = true;
                            numberedListContent = '';
                        } else {
                            // Add a line break between numbered points
                            numberedListContent += '\n';
                        }
                        
                        // Get the index of this item in the list (1-based)
                        const index = Array.from(node.children).indexOf(childNode) + 1;
                        
                        // Add numbered point
                        numberedListContent += `${index}. ${childNode.textContent.trim()}`;
                    }
                }
                // Skip processing the OL's children since we've handled them directly
                i += node.childNodes.length;
            }
            // Handle bullet points - group them together
            else if (node.nodeName === 'LI') {
                // Check if parent is OL (ordered list)
                if (node.parentNode && node.parentNode.nodeName === 'OL') {
                    // If not already in a numbered list, finish current section and start a new numbered list
                    if (!inNumberedList) {
                        finishCurrentSection();
                        finishBulletList();
                        inNumberedList = true;
                        numberedListContent = '';
                    } else {
                        // Add a line break between numbered points
                        numberedListContent += '\n';
                    }
                    
                    // Get the index of this item in the list (1-based)
                    const index = Array.from(node.parentNode.children).indexOf(node) + 1;
                    
                    // Add numbered point
                    numberedListContent += `${index}. ${node.textContent.trim()}`;
                } else {
                    // If not already in a bullet list, finish current section and start a new bullet list
                    if (!inBulletList) {
                        finishCurrentSection();
                        finishNumberedList();
                        inBulletList = true;
                        bulletListContent = '';
                    } else {
                        // Add a line break between bullet points
                        bulletListContent += '\n';
                    }
                    
                    // Add bullet point with a bullet character
                    bulletListContent += '• ' + node.textContent.trim();
                }
            }
            // Handle line breaks
            else if (node.nodeName === 'BR') {
                if (inBulletList) {
                    bulletListContent += '\n';
                } else if (inNumberedList) {
                    numberedListContent += '\n';
                } else if (currentSection) {
                    currentSectionContent += '\n';
                }
            }
            // Handle paragraphs and divs
            else if (['P', 'DIV'].includes(node.nodeName)) {
                // If we're in a list, stay there
                if (inBulletList) {
                    // Only add line break if there's content
                    if (bulletListContent.trim()) {
                        bulletListContent += '\n';
                    }
                    bulletListContent += node.textContent.trim();
                } else if (inNumberedList) {
                    // Only add line break if there's content
                    if (numberedListContent.trim()) {
                        numberedListContent += '\n';
                    }
                    numberedListContent += node.textContent.trim();
                }
                // Otherwise, finish current section and start a new one
                else {
                    finishCurrentSection();
                    
                    // Check if this is empty
                    const text = node.textContent.trim();
                    if (text) {
                        currentSection = node;
                        currentSectionType = 'content';
                        currentSectionContent = text;
                    }
                }
            }
            // Recursively parse other elements
            else {
                // For other elements, just parse their children
                for (let j = 0; j < node.childNodes.length; j++) {
                    const childNode = node.childNodes[j];
                    
                    // Text node
                    if (childNode.nodeType === Node.TEXT_NODE) {
                        const text = childNode.textContent;
                        if (text.trim()) {
                            if (inBulletList) {
                                bulletListContent += text;
                            } else if (inNumberedList) {
                                numberedListContent += text;
                            } else if (currentSection) {
                                currentSectionContent += text;
                            }
                        }
                    }
                    // Element node - handle recursively
                    else if (childNode.nodeType === Node.ELEMENT_NODE) {
                        // Special handling for certain elements
                        if (childNode.nodeName === 'BR') {
                            if (inBulletList) {
                                bulletListContent += '\n';
                            } else if (inNumberedList) {
                                numberedListContent += '\n';
                            } else if (currentSection) {
                                currentSectionContent += '\n';
                            }
                        } else if (childNode.nodeName === 'LI') {
                            // Handle nested list items
                            if (childNode.parentNode && childNode.parentNode.nodeName === 'OL') {
                                // If not already in a numbered list, finish current section and start a new numbered list
                                if (!inNumberedList) {
                                    finishCurrentSection();
                                    finishBulletList();
                                    inNumberedList = true;
                                    numberedListContent = '';
                                } else {
                                    numberedListContent += '\n';
                                }
                                
                                // Get the index of this item in the list (1-based)
                                const index = Array.from(childNode.parentNode.children).indexOf(childNode) + 1;
                                
                                // Add numbered point
                                numberedListContent += `${index}. ${childNode.textContent.trim()}`;
                            } else {
                                if (!inBulletList) {
                                    finishCurrentSection();
                                    finishNumberedList();
                                    inBulletList = true;
                                    bulletListContent = '';
                                } else {
                                    bulletListContent += '\n';
                                }
                                bulletListContent += '• ' + childNode.textContent.trim();
                            }
                        } else {
                            // For other elements, just add their text content
                            const text = childNode.textContent.trim();
                            if (text) {
                                if (inBulletList) {
                                    bulletListContent += text;
                                } else if (inNumberedList) {
                                    numberedListContent += text;
                                } else if (currentSection) {
                                    currentSectionContent += text;
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    
    // Finish any remaining sections
    finishCurrentSection();
    finishBulletList();
    finishNumberedList();
}

function initializeZoomControls() {
    const chatContainer = document.querySelector('.chat-container');
    const zoomInButton = document.getElementById('zoomIn');
    const zoomOutButton = document.getElementById('zoomOut');
    const zoomLevelDisplay = document.getElementById('zoomLevel');
    
    // Set default zoom level
    let currentZoom = 100;
    chatContainer.setAttribute('data-zoom', currentZoom);
    
    // Zoom in function
    function zoomIn() {
        if (currentZoom < 150) {
            currentZoom += 10;
            updateZoom();
        }
    }
    
    // Zoom out function
    function zoomOut() {
        if (currentZoom > 80) {
            currentZoom -= 10;
            updateZoom();
        }
    }
    
    // Zoom in button click handler
    zoomInButton.addEventListener('click', zoomIn);
    
    // Zoom out button click handler
    zoomOutButton.addEventListener('click', zoomOut);
    
    // Add keyboard shortcuts for zooming
    document.addEventListener('keydown', (e) => {
        // Check if Ctrl/Cmd key is pressed
        if (e.ctrlKey || e.metaKey) {
            // Zoom in with Ctrl/Cmd + Plus
            if (e.key === '+' || e.key === '=') {
                e.preventDefault();
                zoomIn();
            }
            // Zoom out with Ctrl/Cmd + Minus
            else if (e.key === '-' || e.key === '_') {
                e.preventDefault();
                zoomOut();
            }
            // Reset zoom with Ctrl/Cmd + 0
            else if (e.key === '0') {
                e.preventDefault();
                currentZoom = 100;
                updateZoom();
            }
        }
    });
    
    // Update zoom level
    function updateZoom() {
        chatContainer.setAttribute('data-zoom', currentZoom);
        zoomLevelDisplay.textContent = `${currentZoom}%`;
        
        // Save zoom preference to localStorage
        localStorage.setItem('chatZoomLevel', currentZoom);
    }
    
    // Load saved zoom preference if available
    const savedZoom = localStorage.getItem('chatZoomLevel');
    if (savedZoom) {
        currentZoom = parseInt(savedZoom);
        updateZoom();
    }
}

// Handle Back button to return to categories
document.addEventListener('DOMContentLoaded', function() {
    const backToCategories = document.getElementById('backToCategories');
    if (backToCategories) {
        backToCategories.addEventListener('click', () => {
            document.getElementById('questionnaireContainer').style.display = 'none';
            document.querySelector('.prompts-grid').style.display = 'grid';
        });
    }
});

// Helper function to clean message content
function cleanMessageContent(text) {
    // Remove any "Send to Figma" text that might be included
    let cleaned = text.replace(/Send to Figma/g, '').trim();
    
    // Remove any other UI text that might be included
    cleaned = cleaned.replace(/Copy|Edit|Save/g, '').trim();
    
    return cleaned;
}

// Add a new function to generate a follow-up question based on chat history
async function generateFollowUpQuestion(aiResponse) {
    // Check if API key is available
    if (!apiKey) {
        return '';
    }
    
    try {
        // Get the last few messages to provide context
        const messages = document.querySelectorAll('.message');
        let conversationHistory = [];
        
        // Collect the last 5 messages for context
        const maxMessages = 8;
        let count = 0;
        for (let i = messages.length - 1; i >= 0 && count < maxMessages; i--) {
            const message = messages[i];
            // Skip typing indicators
            if (message.querySelector('.typing-indicator')) continue;
            
            // Get the message content element specifically
            const messageContentElement = message.querySelector('.message-content');
            if (!messageContentElement) continue;
            
            // Extract text from the message content element only
            const text = messageContentElement.textContent.trim();
            
            // Clean the text to remove any UI elements text that might be included
            const cleanedText = cleanMessageContent(text);
            
            // Only add non-empty messages
            if (cleanedText) {
                const type = message.classList.contains('user') ? 'user' : 'assistant';
                conversationHistory.unshift({
                    role: type,
                    content: cleanedText
                });
                count++;
            }
        }
        
        // Create a system prompt for generating a follow-up question
        const systemPrompt = `You are a specialized AI assistant focused on generating engaging follow-up questions for UI/UX design conversations. Your role is to analyze the conversation history and identify key discussion points and generate follow-up question prompts.

Guidelines for follow-up question prompts:
- Keep question prompts concise (under 100 characters)
- Focus on the most recent assistant response
- Prefer "how" and "what" questions over yes/no questions
- Include specific references to mentioned design elements or concepts

Example good question prompts:
- "Could you elaborate on [part of previous response]?"
- "How would this design pattern impact user engagement?"
- "What metrics would measure this solution's effectiveness?"
- "Which accessibility considerations apply to this component?"`;        
        // Prepare messages array for the API request
        let apiMessages = [
            {
                role: 'system',
                content: systemPrompt
            }
        ];
        
        // Add conversation history to the messages array
        if (conversationHistory.length > 0) {
            apiMessages = apiMessages.concat(conversationHistory);
        }
        
        // Add a final user message asking for a follow-up question
        apiMessages.push({
            role: 'user',
            content: 'Generate a focused follow-up question about the most recent topic discussed in our conversation.'
        });
        
        // Call the OpenAI API
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: apiMessages,
                temperature: 0.7,
                max_tokens: 100
            })
        });
        
        if (!response.ok) {
            throw new Error(`API Error (${response.status})`);
        }
        
        const data = await response.json();
        let followUpQuestion = data.choices[0].message.content.trim();
        
        // Remove quotes if present
        followUpQuestion = followUpQuestion.replace(/^["'](.*)["']$/, '$1');
        
        // Remove "You could ask:" or similar prefixes
        followUpQuestion = followUpQuestion.replace(/^(You could ask:|You might ask:|Consider asking:|How about:|Question:)\s*/i, '');
        
        return followUpQuestion;
    } catch (error) {
        console.error('Error generating follow-up question:', error);
        return '';
    }
}

// Add a function to create and add a suggestion bubble after an AI response
async function addSuggestionBubble(aiMessageElement) {
    try {
        // Get the AI response text
        const aiResponseText = aiMessageElement.querySelector('.message-content').textContent.trim();
        
        // Generate a follow-up question based on the AI response
        const followUpQuestion = await generateFollowUpQuestion(aiResponseText);
        
        // If no question was generated, don't add a bubble
        if (!followUpQuestion) return;
        
        // Create a container div for the suggestion bubble
        const bubbleContainer = document.createElement('div');
        bubbleContainer.style.display = 'flex';
        bubbleContainer.style.justifyContent = 'flex-end';
        bubbleContainer.style.width = '100%';
        
        // Create the suggestion bubble
        const suggestionBubble = document.createElement('div');
        suggestionBubble.className = 'suggestion-bubble';
        suggestionBubble.setAttribute('data-tooltip', 'Click to use this suggestion');
        suggestionBubble.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 18h6"></path>
                <path d="M10 22h4"></path>
                <path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0018 8 6 6 0 006 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 018.91 14"></path>
            </svg>
            ${followUpQuestion}
        `;
        
        // Add click event to open the prompt popup
        suggestionBubble.addEventListener('click', () => {
            showPromptPopup('Follow-up Question', followUpQuestion);
        });
        
        // Add the bubble to the container
        bubbleContainer.appendChild(suggestionBubble);
        
        // Add the container to the chat
        const chatMessages = document.querySelector('.chat-messages');
        chatMessages.appendChild(bubbleContainer);
        
        // Scroll to show the suggestion bubble
        chatMessages.scrollTop = chatMessages.scrollHeight;
    } catch (error) {
        console.error('Error adding suggestion bubble:', error);
    }
}




// Library page functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the library page when it's selected
    initializeLibraryPage();
});

// Function to initialize the library page
function initializeLibraryPage() {
    // Get the library category element
    const libraryCategory = document.getElementById('libraryCategory');
    
    if (libraryCategory) {
        // Add click event listener to the library category
        libraryCategory.addEventListener('click', function() {
            showLibraryPage();
        });
    }
}

// Function to show the library page
function showLibraryPage() {
    // Hide the questionnaire container if it's visible
    const questionnaireContainer = document.getElementById('questionnaireContainer');
    if (questionnaireContainer) {
        questionnaireContainer.style.display = 'none';
    }
    
    // Create or show the library container
    let libraryContainer = document.getElementById('libraryContainer');
    
    if (!libraryContainer) {
        // Create the library container if it doesn't exist
        libraryContainer = document.createElement('div');
        libraryContainer.id = 'libraryContainer';
        libraryContainer.className = 'library-container';
        
        // Create the breadcrumb container
        const breadcrumbContainer = document.createElement('div');
        breadcrumbContainer.className = 'breadcrumb-container';
        
        // Create the back button
        const backButton = document.createElement('button');
        backButton.className = 'back-button';
        backButton.id = 'backFromLibrary';
        backButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5"></path>
                <path d="M12 19l-7-7 7-7"></path>
            </svg>
            Back
        `;
        
        // Add event listener to the back button
        backButton.addEventListener('click', function() {
            libraryContainer.style.display = 'none';
            // Show the prompt categories again
            const promptsGrid = document.querySelector('.prompts-grid');
            if (promptsGrid) {
                promptsGrid.style.display = 'grid';
            }
        });
        
        // Create the category title
        const categoryTitle = document.createElement('div');
        categoryTitle.className = 'category-title';
        categoryTitle.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="topic-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
            </svg>
            Library
        `;
        
        // Create the library description
        const libraryDescription = document.createElement('p');
        libraryDescription.className = 'library-description';
        libraryDescription.textContent = 'Browse pre-made prompts organized by category to enhance your design process.';
        
        // Add back button and category title to breadcrumb container
        breadcrumbContainer.appendChild(backButton);
        breadcrumbContainer.appendChild(categoryTitle);
        
        // Create the search container
        const searchContainer = document.createElement('div');
        searchContainer.className = 'search-container';
        searchContainer.innerHTML = `
            <div class="search-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </div>
            <input type="text" id="promptSearchInput" class="search-input" placeholder="Search prompts...">
            <div id="searchResults" class="search-results"></div>
        `;
        
        // Create the prompts categories container
        const promptsCategories = document.createElement('div');
        promptsCategories.className = 'prompts-categories';
        
        // Define the main topic categories
        const mainTopicCategories = [
            {
                name: 'UX Research',
                count: 19,
                items: [
                    'User persona', 'User journey map', 'Target audience', 'Behavior analysis',
                    'Demographics', 'Psychographics', 'Pain points', 'Stakeholder interviews',
                    'Observational research', 'Competitive analysis', 'Market research', 'Survey design',
                    'Affinity diagram', 'Field studies', 'Focus groups', 'Ethnographic research',
                    'Contextual inquiry', 'Emotional mapping', 'User journey'
                ]
            },
            {
                name: 'Strategy',
                count: 20,
                items: [
                    'Problem statement', 'User needs', 'Goal definition', 'Insights clustering',
                    'Value proposition', 'Design constraints', 'User requirements', 'Opportunity framing',
                    'Problem space', 'How-might-we questions', 'Gap analysis', 'Success criteria',
                    'Task analysis', 'Job-to-be-done', 'User pain', 'Journey pain points',
                    'Prioritization matrix', 'Experience goals', 'Product vision', 'Problem framing'
                ]
            },
            {
                name: 'Ideation',
                count: 18,
                items: [
                    'Brainstorming', 'Co-creation', 'Mind mapping', 'Storyboarding',
                    'Role-playing', 'Ideation workshop', 'Concept sketching', 'Crazy 8s',
                    'SCAMPER method', 'Blue-sky thinking', 'Moodboarding', 'Design exploration',
                    'Divergent thinking', 'Problem reframing', 'Reverse engineering', 'Concept testing',
                    'Heuristic ideation', 'Design sprint'
                ]
            },
            {
                name: 'Prototyping',
                count: 24,
                items: [
                    'Wireframe', 'Mockup', 'Clickable prototype', 'Interactive flow',
                    'Style guide', 'Design system', 'UI components', 'User flow',
                    'Color picker', 'Information architecture', 'High-fidelity prototype', 'Low-fidelity prototype',
                    'Responsive design', 'Adaptive design', 'Fixed layout', 'Full-width design',
                    'Minimalist layout', 'Microinteractions', 'Parallax scrolling', 'Iconography',
                    'Infinite scroll', 'Auto-complete', 'Background video', 'SVG graphics'
                ]
            },
            {
                name: 'Testing',
                count: 16,
                items: [
                    'A/B testing', 'Usability testing', 'Heatmaps', 'Click tracking',
                    'User feedback', 'Accessibility audit', 'Performance optimization', 'Mobile-first design',
                    'Error tracking', 'Metrics dashboard', 'Eye-tracking', 'First-click testing',
                    'Retention metrics', 'Conversion rates', 'Qualitative feedback', 'Quantitative feedback'
                ]
            },
            {
                name: 'UI Elements',
                count: 60,
                items: [
                    'Hover effect', 'Drag-and-drop', 'Swipeable interface', 'Toggle',
                    'Scrollbar', 'Loading spinner', 'Breadcrumb navigation/trail', 'Pagination',
                    'Dropdown menu', 'Text field', 'Radio button', 'Checkbox',
                    'Dropdown list', 'Multi-step form', 'Inline validation', 'Placeholder text',
                    'Hero image', 'Submit button', 'Error message', 'Progress bar',
                    'Modal window', 'Tooltip', 'Card', 'Accordion menu',
                    'Carousel/Slider', 'Image gallery', 'Search bar', 'Table',
                    'File upload', 'Date picker', 'Time picker', 'Switch',
                    'Stepper', 'Rating stars', 'Toast notification', 'Tab navigation',
                    'Timeline', 'Hyperlinks', 'Sidebar', 'Multi-select dropdown',
                    'Chip list', 'Footer', 'Action button (floating action button - FAB)', 'Header',
                    'Loader (spinner/bar/screen)', 'Fisheye menu', 'Earcons', 'Chartjunk',
                    'Bento menu', 'Hamburger menu', 'Alt-menu', 'Meatball menu',
                    'Kebab menu', 'Doner menu', 'Button', 'Comment',
                    'Fom', 'Feed', 'Input field', 'Picker (date/time)',
                    'Notification', 'Tag'
                ]
            },
            {
                name: 'Visual Design',
                count: 14,
                items: [
                    'Visual Design', 'Golden Ratio', 'Monochromatic scheme', 'Complementary colors',
                    'Accent color', 'Gradient background', 'Light theme', 'Dark mode',
                    'Pastel colors', 'Neutral palette', 'High contrast', 'Rule of Thirds',
                    'Proximity', 'Color models'
                ]
            },
            {
                name: 'Accessibility',
                count: 10,
                items: [
                    'ARIA labels', 'Alt text', 'Keyboard navigation', 'Screen reader support',
                    'High contrast mode', 'Focus indicators', 'Accessible forms', 'Large tap target',
                    'Dynamic text resizing', 'Color-blind friendly design'
                ]
            },
            {
                name: 'Figma',
                count: 23,
                items: [
                    'Auto Layout', 'Smart Selection', 'Variables', 'Constraints',
                    'Components & Instances', 'Variants', 'Nested Components', 'Interactive Components',
                    'Styles (Text, Colors, Effects, Grids)', 'Plugins & Widgets', 'Figma Tokens', 'Smart Animate',
                    'Dev Mode', 'Version Control', 'File Organization', 'FigJam Collaboration',
                    'Team Libraries', 'Boolean Operations', 'Vector Editing', 'Pen Tool',
                    'Blend Modes', 'Masking', 'Exporting Assets'
                ]
            },
            {
                name: 'Design Principles',
                count: 49,
                items: [
                    'Design Thinking Process', 'Aesthetic-Usability Effect', 'Choice Overload', 'Chunking',
                    'Cognitive Bias', 'Cognitive Load', 'Doherty Threshold', 'Fitts\'s Law',
                    'Flow', 'Goal-Gradient Effect', 'Hick\'s Law', 'Jakob\'s Law',
                    'Law of Common Region', 'Law of Proximity', 'Law of Prägnanz', 'Law of Similarity',
                    'Law of Uniform Connectedness', 'Mental Model', 'Miller\'s Law', 'Occam\'s Razor',
                    'Paradox of the Active User', 'Pareto Principle', 'Parkinson\'s Law', 'Peak-End Rule',
                    'Postel\'s Law', 'Selective Attention', 'Serial Position Effect', 'Tesler\'s Law',
                    'Von Restorff Effect', 'Working Memory', 'Zeigarnik Effect', 'Dark Patterns',
                    'Persuasive Design', 'Gestalt Principles', 'Progressive Disclosure', 'Nielsen\'s Usability Heuristics',
                    'Principle of Least Effort', 'Dunning-Kruger Effect', 'Kano Model', 'Default Effect',
                    'Mere Exposure Effect', 'Social Proof', 'Sunk Cost Fallacy', 'Gamification Mechanics',
                    'FOMO', 'Scarcity Principle', 'Decoy Effect', 'Hyperbolic Discounting',
                    'Nudge Theory', 'Form Follows Function'
                ]
            }
        ];
        
        // Create categories for all topics
        mainTopicCategories.forEach(category => {
            const categoryDiv = createTopicWithItems(category.name, category.items, category.count);
            promptsCategories.appendChild(categoryDiv);
        });
        
        // Assemble the library container
        libraryContainer.appendChild(breadcrumbContainer);
        libraryContainer.appendChild(libraryDescription);
        libraryContainer.appendChild(searchContainer);
        libraryContainer.appendChild(promptsCategories);
        
        // Add the library container to the prompt container
        const promptContainer = document.querySelector('.prompt-container');
        if (promptContainer) {
            promptContainer.appendChild(libraryContainer);
        }
        
        // Initialize search functionality
        initializeSearch();
        
        // Add click event listeners to category headers for accordion functionality
        initializeAccordion();
        
    } else {
        // Show the library container if it already exists
        libraryContainer.style.display = 'block';
    }
    
    // Hide the prompts grid
    const promptsGrid = document.querySelector('.prompts-grid');
    if (promptsGrid) {
        promptsGrid.style.display = 'none';
    }
}

// Helper function to create a topic with items
function createTopicWithItems(topicName, items, count) {
    const topic = document.createElement('div');
    topic.className = 'topic';
    
    const topicHeader = document.createElement('div');
    topicHeader.className = 'topic-header';
    topicHeader.innerHTML = `
        <span>${topicName}</span>
        <span class="count">${count}</span>
    `;
    
    const topicItems = document.createElement('div');
    topicItems.className = 'topic-items';
    
    items.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'item';
        itemDiv.textContent = item;
        
        // Add click event to show the prompt popup
        itemDiv.addEventListener('click', () => {
            // Create and show the popup
            const overlay = document.createElement('div');
            overlay.className = 'prompt-overlay';
            
            // Get the prompt content immediately
            const promptText = generatePromptContent(item, topicName);
            
            // Process the prompt text to highlight placeholders in purple
            const processedPromptText = highlightPlaceholders(promptText);
            
            const popup = document.createElement('div');
            popup.className = 'prompt-popup';
            popup.innerHTML = `
                <div style="position: relative;">
                    <button class="close-prompt" style="position:absolute;top:0;right:0;background:none;border:none;font-size:24px;cursor:pointer;color:var(--light-gray);">×</button>
                    <h3 style="margin-top: 0; padding-right: 24px; color: var(--white-1); font-size: var(--fs-4);">${item}</h3>
                </div>
                <div class="prompt-content" contenteditable="false">${processedPromptText}</div>
                <div class="prompt-actions">
                    <button class="regenerate-prompt" data-tooltip="Regenerate">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M23 4v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M1 20v-6h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <button class="copy-prompt" data-tooltip="Copy">
                        <svg class="copy-text" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 9H11C9.89543 9 9 9.89543 9 11V20C9 21.1046 9.89543 22 11 22H20C21.1046 22 22 21.1046 22 20V11C22 9.89543 21.1046 9 20 9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M5 15H4C3.46957 15 2.96086 14.7893 2.58579 14.4142C2.21071 14.0391 2 13.5304 2 13V4C2 3.46957 2.21071 2.96086 2.58579 2.58579C2.96086 2.21071 3.46957 2 4 2H13C13.5304 2 14.0391 2.21071 14.4142 2.58579C14.7893 2.96086 15 3.46957 15 4V5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <svg class="copied-text" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <button class="send-to-chat" data-tooltip="Send to chat">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <button class="edit-button" data-tooltip="Edit">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M18.5 2.50001C18.8978 2.10219 19.4374 1.87869 20 1.87869C20.5626 1.87869 21.1022 2.10219 21.5 2.50001C21.8978 2.89784 22.1213 3.4374 22.1213 4.00001C22.1213 4.56262 21.8978 5.10219 21.5 5.50001L12 15L8 16L9 12L18.5 2.50001Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <button class="save-button" data-tooltip="Save" style="display: none; background: var(--eerie-black-1); border-color: var(--main-purple); color: var(--main-purple);">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16L21 8V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M17 21V13H7V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M7 3V8H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            `;
            
            overlay.appendChild(popup);
            document.body.appendChild(overlay);
            
            const promptContent = popup.querySelector('.prompt-content');
            const editButton = popup.querySelector('.edit-button');
            const saveButton = popup.querySelector('.save-button');
            const regenerateButton = popup.querySelector('.regenerate-prompt');
            
            // Close button handler
            popup.querySelector('.close-prompt').addEventListener('click', () => {
                document.body.removeChild(overlay);
            });
            
            // Regenerate button handler
            regenerateButton.addEventListener('click', async () => {
                // Show loading state in the prompt content
                const originalPrompt = promptContent.innerHTML;
                promptContent.innerHTML = `
                    <div class="loading-dot-container" style="margin: 20px auto;">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                `;
                
                try {
                    // Get the API key
                    const apiKey = document.getElementById('apiKeyInput')?.value;
                    if (!apiKey) {
                        throw new Error('API key not found');
                    }

                    // Check if project data exists and is meaningful
                    const hasProjectData = checkForProjectData();
                    
                    // Get project overview data if it exists
                    let projectOverviewText = '';
                    if (hasProjectData) {
                        projectOverviewText = getProjectOverviewText();
                    }

                    // Prepare the prompt for GPT
                    let systemPrompt = `You are a UX/UI design expert tasked with generating unique prompt questions. For the topic "${item}" in the context of ${topicName}, create a completely new and different prompt that:
1. Approaches the topic from a fresh angle or perspective
2. Is phrased as 2-3 related questions that build on each other
3. Focuses on different aspects than the current prompt
4. Maintains high quality and depth while being concise
5. Encourages detailed, actionable responses
6. Is specific to UX/UI design best practices
7. Follows this format: "What [specific aspect]? How [implementation detail]? What [considerations/pitfalls]?"`;

                    // Add project overview data if it exists
                    if (hasProjectData) {
                        systemPrompt += `\n\nThe user has provided the following project overview information. Tailor your prompt to be relevant to their specific project context:\n${projectOverviewText}`;
                    }

                    systemPrompt += `\n\nCurrent prompt for reference (generate something different):
${originalPrompt}`;
                    
                    // Call OpenAI API
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4',
                            messages: [
                                { role: 'system', content: systemPrompt },
                                { role: 'user', content: 'Generate a new, unique prompt question that explores different aspects of this topic than the current prompt.' }
                            ],
                            temperature: 0.8,
                            max_tokens: 500
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to generate new prompt');
                    }

                    const data = await response.json();
                    const newPrompt = data.choices[0].message.content.trim();
                    
                    // Process the new prompt to highlight placeholders
                    promptContent.innerHTML = highlightPlaceholders(newPrompt);

                } catch (error) {
                    console.error('Error generating new prompt:', error);
                    // Restore original prompt if there's an error
                    promptContent.innerHTML = originalPrompt;
                    
                    // Show error message to user
                    const errorMessage = error.message === 'API key not found' 
                        ? 'Please enter your OpenAI API key in the chat section first.'
                        : 'Failed to generate new prompt. Please try again.';
                        
                    alert(errorMessage);
                }
            });
            
            // Copy button handler
            popup.querySelector('.copy-prompt').addEventListener('click', () => {
                // Create a temporary textarea element to handle the copying
                const tempTextArea = document.createElement('textarea');
                // Use textContent to get the plain text without HTML formatting
                tempTextArea.value = promptContent.textContent;
                // Make the textarea invisible
                tempTextArea.style.position = 'absolute';
                tempTextArea.style.left = '-9999px';
                tempTextArea.style.top = '0';
                tempTextArea.style.opacity = '0';
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                
                try {
                    // Execute the copy command
                    document.execCommand('copy');
                    
                    // Visual feedback
                    const copyBtn = popup.querySelector('.copy-prompt');
                    copyBtn.classList.add('copied');
                    
                    setTimeout(() => {
                        copyBtn.classList.remove('copied');
                    }, 2000);
                    
                    console.log('Prompt copied to clipboard');
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                } finally {
                    // Remove the temporary element
                    document.body.removeChild(tempTextArea);
                }
            });
            
            // Send to chat button handler
            popup.querySelector('.send-to-chat').addEventListener('click', () => {
                // Get the prompt content as plain text without HTML formatting
                const promptText = promptContent.textContent.trim();
                
                // Switch to chat tab
                document.querySelector('.nav-tab[data-section="chat"]').click();
                
                // Set the prompt text in the chat input
                const chatInput = document.querySelector('.chat-input');
                if (chatInput) {
                    chatInput.value = promptText;
                    chatInput.disabled = false;
                    
                    // Enable the send button if it exists
                    const sendButton = document.getElementById('sendButton');
                    if (sendButton) {
                        sendButton.disabled = false;
                    }
                    
                    // Focus the chat input
                    chatInput.focus();
                }
                
                // Close the popup
                document.body.removeChild(overlay);
            });
            
            // Edit button handler
            editButton.addEventListener('click', () => {
                // Make the content editable but preserve the highlighting
                promptContent.contentEditable = 'true';
                promptContent.focus();
                editButton.style.display = 'none';
                saveButton.style.display = 'inline-flex';
            });
            
            // Save button handler
            saveButton.addEventListener('click', () => {
                promptContent.contentEditable = 'false';
                
                // Re-process the content to ensure placeholders are highlighted
                const rawText = promptContent.textContent;
                promptContent.innerHTML = highlightPlaceholders(rawText);
                
                saveButton.style.display = 'none';
                editButton.style.display = 'inline-flex';
            });
            
            // Close when clicking outside the popup
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            });
        });
        
        topicItems.appendChild(itemDiv);
    });
    
    topic.appendChild(topicHeader);
    topic.appendChild(topicItems);
    
    return topic;
}

// Function to initialize accordion functionality
function initializeAccordion() {
    const topicHeaders = document.querySelectorAll('.topic-header');
    
    topicHeaders.forEach(header => {
        header.addEventListener('click', () => {
            const topic = header.parentElement;
            
            // Check if the topic is already active
            const isActive = topic.classList.contains('active');
            
            // Close all topics first
            const allTopics = document.querySelectorAll('.topic');
            allTopics.forEach(t => t.classList.remove('active'));
            
            // If the clicked topic wasn't active before, open it
            if (!isActive) {
                topic.classList.add('active');
            }
            // If it was active, it's now closed (we removed the active class above)
        });
    });
}

// Function to initialize search functionality
function initializeSearch() {
    const searchInput = document.getElementById('promptSearchInput');
    const searchResults = document.getElementById('searchResults');
    
    if (!searchInput || !searchResults) return;
    
    // Create an overlay for darkening content when search results are shown
    let overlay = document.querySelector('.content-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'content-overlay';
        document.body.appendChild(overlay);
        
        // Add click event to close search results when clicking outside
        overlay.addEventListener('click', () => {
            overlay.classList.remove('active');
            searchResults.innerHTML = '';
            searchInput.value = '';
        });
    }
    
    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        
        // Clear previous results
        searchResults.innerHTML = '';
        
        if (searchTerm.length < 2) {
            overlay.classList.remove('active');
            return;
        }
        
        const results = [];
        
        // Collect all items from all topics
        document.querySelectorAll('.topic').forEach(topic => {
            const topicName = topic.querySelector('.topic-header span').textContent;
            
            topic.querySelectorAll('.item').forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    results.push({
                        text: item.textContent,
                        topic: topicName
                    });
                }
            });
        });
        
        // Display results
        if (results.length > 0) {
            overlay.classList.add('active');
            
            results.forEach(result => {
                const pill = document.createElement('div');
                pill.className = 'search-pill';
                pill.innerHTML = `
                    ${result.text}
                    <span class="topic-label">${result.topic}</span>
                `;
                
                // Add click handler to show the item
                pill.addEventListener('click', () => {
                    searchInput.value = '';
                    searchResults.innerHTML = '';
                    overlay.classList.remove('active');
                    
                    // Find and show the corresponding topic and item
                    document.querySelectorAll('.topic').forEach(topic => {
                        const topicHeader = topic.querySelector('.topic-header span');
                        if (topicHeader.textContent === result.topic) {
                            // Open the topic if it's not already open
                            if (!topic.classList.contains('active')) {
                                topic.classList.add('active');
                            }
                            
                            // Find and highlight the item
                            const item = Array.from(topic.querySelectorAll('.item'))
                                .find(item => item.textContent === result.text);
                            
                            if (item) {
                                // Remove any existing highlights
                                document.querySelectorAll('.item.highlight').forEach(i => {
                                    i.classList.remove('highlight');
                                });
                                
                                // Add highlight class to trigger animation
                                item.classList.add('highlight');
                                
                                // Scroll the item into view
                                setTimeout(() => {
                                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }, 100);
                            }
                        }
                    });
                });
                
                searchResults.appendChild(pill);
            });
        } else {
            overlay.classList.remove('active');
            searchResults.innerHTML = '<div class="no-results">No matching prompts found</div>';
        }
    });
    
    // Remove overlay when clicking a search result
    document.addEventListener('click', (e) => {
        if (e.target.closest('.search-pill')) {
            overlay.classList.remove('active');
        }
    });
}

// Function to generate prompt content based on the item and topic
function generatePromptContent(item, topic) {
    // Object containing preset prompts for each topic and item
    const presetPrompts = {
        'UX Research': {
            'User persona': `Create a detailed user persona for [product/service] that includes demographic information, behaviors, goals, frustrations, and motivations. Include a day-in-the-life narrative that shows how they interact with products like mine, their decision-making process, and key touchpoints where my solution could add value.`,
            
            'User journey map': `Help me develop a comprehensive user journey map for [specific user persona] interacting with [product/service/process]. Include all stages from awareness to advocacy, detailing their actions, thoughts, emotions, pain points, and opportunities for improvement at each touchpoint. Highlight critical moments that could make or break their experience.`,
            
            'Target audience': `Define a precise target audience for [product/service/content], including primary and secondary segments. For each segment, outline demographic characteristics, behavioral patterns, media consumption habits, purchasing power, and the specific problems my [product/service] would solve for them. Explain why this audience is strategically valuable.`,
            
            'Behavior analysis': `Analyze the typical behavioral patterns of [specific user group] when they [relevant activity]. Include their decision triggers, habitual actions, environmental influences, psychological factors, and how these behaviors have evolved over time. Focus on identifying unexpected or counterintuitive behaviors that might inform product design.`,
            
            'Demographics': `Create a comprehensive demographic profile for the ideal users of [product/service]. Include age ranges, income levels, education, occupation, geographic location, family structure, and technology adoption patterns. Explain how each demographic factor influences their needs, preferences, and likelihood to engage with solutions like mine.`,
            
            'Psychographics': `Develop a detailed psychographic profile for users of [product/service], focusing on their values, attitudes, interests, lifestyle choices, social identities, and aspirations. Explain how these psychological characteristics influence their purchasing decisions, brand preferences, and product usage patterns for solutions in my category.`,
            
            'Pain points': `Identify and analyze the critical pain points experienced by [specific user group] when they attempt to [relevant task/process]. For each pain point, describe the context in which it occurs, its emotional impact, current workarounds users employ, and how these challenges affect overall satisfaction and outcomes. Prioritize these pain points by severity and frequency.`,
            
            'Stakeholder interviews': `Design a structured stakeholder interview protocol for gathering insights about [project/product]. Include questions that explore their role, business objectives, definition of success, concerns, constraints, and vision. Provide guidance on how to conduct these interviews effectively and how to analyze the resulting data to inform product strategy.`,
            
            'Observational research': `Create a detailed plan for conducting observational research to understand how [specific user group] interacts with [product/environment/process]. Include methodology, what behaviors to document, ethical considerations, data collection techniques, and a framework for analyzing patterns and anomalies in the observed behaviors.`,
            
            'Competitive analysis': `Develop a comprehensive competitive analysis framework for [product/service category]. Include direct and indirect competitors, evaluation criteria (features, pricing, user experience, market positioning, strengths/weaknesses), emerging threats, and opportunities for differentiation. Conclude with strategic recommendations based on competitive gaps.`,
            
            'Market research': `Design a market research plan for [product/service/industry] that combines quantitative and qualitative methods. Include research questions, data sources, analysis approach, and how findings will inform business strategy. Focus on market size, growth trends, customer segments, buying patterns, and emerging opportunities or threats.`,
            
            'Survey design': `Create a customer survey to gather insights about [specific aspect of product/service/experience]. Include a mix of question types (multiple choice, rating scales, open-ended) that will generate actionable data. Organize questions in a logical flow, avoid bias, and design it to take no more than 10 minutes to complete. Include guidance on sampling strategy and analysis methods.`,
            
            'Affinity diagram': `Help me structure an affinity diagramming exercise to organize and make sense of [specific research data/user feedback]. Outline the process for converting raw data into insights, including how to create meaningful categories, identify patterns and relationships, and translate the resulting structure into actionable recommendations.`,
            
            'Field studies': `Design a comprehensive field study plan to understand how [specific users] interact with [products/services/environments] in their natural context. Include research questions, participant selection criteria, data collection methods, ethical considerations, and analytical approach. Focus on capturing authentic behaviors and contextual factors that influence the user experience.`,
            
            'Focus groups': `Develop a detailed focus group discussion guide to explore [specific topic/product/concept] with [target participants]. Include warm-up activities, stimulus materials, key questions, probing techniques, and exercises that will generate meaningful insights. Structure the session to build from general to specific topics and manage group dynamics effectively.`,
            
            'Ethnographic research': `Create a plan for ethnographic research to deeply understand the cultural context and lived experiences of [specific user group] as they relate to [product/service/activity]. Include methods for immersion, relationship building, data collection, cultural sensitivity considerations, and how to analyze findings to inform product development and marketing strategy.`,
            
            'Contextual inquiry': `Design a contextual inquiry protocol to observe and interview [specific users] while they perform [specific tasks] in their natural environment. Include preparation steps, observation guidelines, interview questions, documentation methods, and analytical framework to translate findings into design requirements and opportunities.`,
            
            'Emotional mapping': `Help me create an emotional mapping framework to understand the feelings and reactions of users as they interact with [product/service/experience]. Include methods for identifying and measuring emotional states at each touchpoint, visualization techniques, and how to connect emotional patterns to specific design elements or service moments.`,
            
            'User journey': `Map out a detailed user journey for [specific persona] interacting with [product/service], from initial awareness through long-term usage. For each stage, identify the user's goals, actions, touchpoints, thoughts, feelings, and opportunities for improvement. Highlight moments of truth that disproportionately impact satisfaction and loyalty.`
        },
        
        'Visual Design': {
            // ... existing code ...
        },
            
        'Strategy': {
            // ... existing code ...
        },
        
        'Ideation': {
            // ... existing code ...
        },
        
        'Prototyping': {
            // ... existing code ...
        },
        
        'Testing': {
            // ... existing code ...
        },
        
        'UI Elements': {
            // ... existing code ...
        },
        
        'Accessibility': {
            // ... existing code ...
        },
        
        'Figma': {
            // ... existing code ...
        },
        
        'Design Principles': {
            // ... existing code ...
        }
    };
    
    // Check if we have a preset prompt for this topic and item
    if (presetPrompts[topic] && presetPrompts[topic][item]) {
        return presetPrompts[topic][item];
    }
    
    // Fallback for items that don't have a preset prompt
    return `What are the key considerations and best practices for implementing ${item.toLowerCase()} in the context of ${topic}? How does it impact the overall user experience, and what common pitfalls should be avoided? Be detailed, yet concise.`;
}

// Function to highlight placeholder text in brackets with purple color
function highlightPlaceholders(text) {
    return text.replace(/\[([^\]]+)\]/g, '<span style="color: var(--main-purple);">[$1]</span>');
}

// Function to check if project data exists and is meaningful
function checkForProjectData() {
    try {
        // Check if projectData is defined and has meaningful data
        return (
            typeof projectData !== 'undefined' &&
            (
                (projectData.projectDescription && projectData.projectDescription !== '' && projectData.projectDescription !== 'Not specified') ||
                (projectData.targetAudience && projectData.targetAudience !== '' && projectData.targetAudience !== 'Not specified') ||
                (projectData.projectType && projectData.projectType !== '' && projectData.projectType !== 'Not specified')
            )
        );
    } catch (error) {
        console.error('Error checking for project data:', error);
        return false;
    }
}

// Function to get project overview text
function getProjectOverviewText() {
    try {
        if (typeof projectData === 'undefined') {
            return '';
        }
        
        // Format project data into a readable text format
        return `Project Description: ${projectData.projectDescription || 'Not specified'}
Target Audience: ${projectData.targetAudience || 'Not specified'}
Project Type: ${projectData.projectType || 'Not specified'}
Main Goals: ${projectData.mainGoals && projectData.mainGoals.length ? projectData.mainGoals.join(', ') : 'Not specified'}
Design Style: ${projectData.designStyle && projectData.designStyle.length ? projectData.designStyle.join(', ') : 'Not specified'}
Figma Experience: ${projectData.figmaExperience || 'Not specified'}
Website Complexity: ${projectData.complexity || 'Not specified'}
Purposes: ${projectData.purposes || 'Not specified'}
Design Stage: ${projectData.designStage || 'Not specified'}
Additional Guidelines: ${projectData.guidelines || 'Not specified'}`;
    } catch (error) {
        console.error('Error getting project overview text:', error);
        return '';
    }
} 
    </script>
    <script src="generate.js"></script>
    <script src="library.js"></script>
    
    <script>
        // Function to show the "Saved Prompts" page
        function showSavedPage() {
            console.log('showSavedPage called');
            
            // Get the prompt container
            const promptsContainer = document.querySelector('.prompt-container');
            if (!promptsContainer) {
                console.error('Prompt container not found');
                return;
            }
            
            // Save the original content
            if (!promptsContainer.getAttribute('data-original-content')) {
                promptsContainer.setAttribute('data-original-content', promptsContainer.innerHTML);
            }
            
            // Clear the container
            promptsContainer.innerHTML = '';
            
            // Create a container with proper class for styling
            const container = document.createElement('div');
            container.className = 'saved-prompts-container';
            container.style.padding = '20px';
            container.style.maxWidth = '800px';
            container.style.margin = '0 auto';
            
            // Create the back button
            const backButton = document.createElement('button');
            backButton.className = 'back-button';
            backButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" fill="currentColor"/>
                </svg>
                Back
            `;
            backButton.style.marginBottom = '20px';
            
            // Create the title
            const title = document.createElement('h2');
            title.textContent = 'Saved Prompts';
            title.style.color = 'var(--white-1)';
            title.style.marginBottom = '20px';
            
            // Create the empty state message
            const emptyState = document.createElement('div');
            emptyState.className = 'empty-state';
            emptyState.style.textAlign = 'center';
            emptyState.style.padding = '40px 20px';
            emptyState.style.backgroundColor = 'var(--eerie-black-1)';
            emptyState.style.borderRadius = '8px';
            emptyState.style.marginTop = '30px';
            
            // Add the star icon
            const starIcon = document.createElement('div');
            starIcon.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" style="margin-bottom: 16px; opacity: 0.5;">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill="var(--main-purple)"></polygon>
                </svg>
            `;
            
            // Add the message
            const message = document.createElement('p');
            message.textContent = 'You have no saved prompts yet';
            message.style.fontSize = '18px';
            message.style.color = 'var(--white-2)';
            message.style.marginBottom = '16px';
            
            // Add the description
            const description = document.createElement('p');
            description.textContent = 'Your saved prompts will appear here.';
            description.style.color = 'var(--light-gray)';
            description.style.fontSize = '14px';
            
            // Add elements to the empty state
            emptyState.appendChild(starIcon);
            emptyState.appendChild(message);
            emptyState.appendChild(description);
            
            // Add event listener to the back button
            backButton.addEventListener('click', function() {
                console.log('Back button clicked in Saved page');
                // Restore the original content with the grid categories
                if (promptsContainer.getAttribute('data-original-content')) {
                    promptsContainer.innerHTML = promptsContainer.getAttribute('data-original-content');
                    
                    // Re-add click handlers to categories
                    const generateCategory = document.getElementById('generateCategory');
                    if (generateCategory) {
                        generateCategory.onclick = function() {
                            showGeneratePage();
                            return false;
                        };
                    }
                    
                    const startCategory = document.getElementById('startCategory');
                    if (startCategory) {
                        startCategory.onclick = function() {
                            showStartPage();
                            return false;
                        };
                    }
                    
                    const libraryCategory = document.getElementById('libraryCategory');
                    if (libraryCategory) {
                        libraryCategory.onclick = function() {
                            showLibraryPage();
                            return false;
                        };
                    }
                    
                    const savedCategory = document.getElementById('savedCategory');
                    if (savedCategory) {
                        savedCategory.onclick = function() {
                            showSavedPage();
                            return false;
                        };
                    }
                }
            });
            
            // Add elements to the container
            container.appendChild(backButton);
            container.appendChild(title);
            container.appendChild(emptyState);
            
            // Add the container to the prompts container
            promptsContainer.appendChild(container);
        }
        
        // Simple implementation of showLibraryPage in case the library.js file doesn't load properly
        if (typeof showLibraryPage !== 'function') {
            function showLibraryPage() {
                console.log('showLibraryPage called (fallback implementation)');
                
                // Get the prompt container
                const promptsContainer = document.querySelector('.prompt-container');
                if (!promptsContainer) {
                    console.error('Prompt container not found');
                    return;
                }
                
                // Save the original content
                if (!promptsContainer.getAttribute('data-original-content')) {
                    promptsContainer.setAttribute('data-original-content', promptsContainer.innerHTML);
                }
                
                // Clear the container
                promptsContainer.innerHTML = '';
                
                // Create a simple container
                const container = document.createElement('div');
                container.style.padding = '20px';
                container.style.maxWidth = '800px';
                container.style.margin = '0 auto';
                
                // Create the back button
                const backButton = document.createElement('button');
                backButton.className = 'back-button';
                backButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" fill="currentColor"/>
                    </svg>
                    Back
                `;
                backButton.style.marginBottom = '20px';
                
                // Create the title
                const title = document.createElement('h2');
                title.textContent = 'Library';
                title.style.color = 'var(--white-1)';
                title.style.marginBottom = '20px';
                
                // Create the description
                const description = document.createElement('p');
                description.textContent = 'Browse the library of prompts for design inspiration.';
                description.style.marginBottom = '20px';
                
                // Add event listener to the back button
                backButton.addEventListener('click', function() {
                    console.log('Back button clicked in Library page');
                    // Restore the original content with the grid categories
                    if (promptsContainer.getAttribute('data-original-content')) {
                        promptsContainer.innerHTML = promptsContainer.getAttribute('data-original-content');
                        
                        // Re-add click handlers to categories
                        const generateCategory = document.getElementById('generateCategory');
                        if (generateCategory) {
                            generateCategory.onclick = function() {
                                showGeneratePage();
                                return false;
                            };
                        }
                        
                        const startCategory = document.getElementById('startCategory');
                        if (startCategory) {
                            startCategory.onclick = function() {
                                showStartPage();
                                return false;
                            };
                        }
                        
                        const libraryCategory = document.getElementById('libraryCategory');
                        if (libraryCategory) {
                            libraryCategory.onclick = function() {
                                showLibraryPage();
                                return false;
                            };
                        }
                    }
                });
                
                // Add elements to the container
                container.appendChild(backButton);
                container.appendChild(title);
                container.appendChild(description);
                
                // Add some sample library content
                const libraryContent = document.createElement('div');
                libraryContent.innerHTML = `
                    <div style="margin-top: 30px;">
                        <h3 style="color: var(--white-1); margin-bottom: 15px;">UI Design</h3>
                        <div style="background-color: var(--eerie-black-1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin-bottom: 10px;">How can I create a cohesive color palette for my mobile app?</p>
                            <button class="button button-primary" style="margin-top: 10px;">Use Prompt</button>
                        </div>
                        
                        <h3 style="color: var(--white-1); margin-bottom: 15px;">UX Research</h3>
                        <div style="background-color: var(--eerie-black-1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin-bottom: 10px;">What are the best practices for conducting user interviews?</p>
                            <button class="button button-primary" style="margin-top: 10px;">Use Prompt</button>
                        </div>
                    </div>
                `;
                
                container.appendChild(libraryContent);
                
                // Add the container to the prompts container
                promptsContainer.appendChild(container);
            }
        }
        
        // Function to show the Start page (questionnaire)
        function showStartPage() {
            console.log('showStartPage called');
            document.querySelector('.prompts-grid').style.display = 'none';
            document.getElementById('questionnaireContainer').style.display = 'block';
            
            // Initialize option items to make them clickable
            if (typeof initializeOptionItems === 'function') {
                initializeOptionItems();
            } else {
                console.warn('initializeOptionItems function not found, implementing fallback');
                // Fallback implementation if the function isn't available
                document.querySelectorAll('.option-grid').forEach(grid => {
                    const isMultipleSelect = grid.classList.contains('multiple-select');
                    
                    grid.querySelectorAll('.option-item').forEach(item => {
                        // Add click event listener
                        item.addEventListener('click', () => {
                            if (isMultipleSelect) {
                                // Toggle selection for multiple select
                                item.classList.toggle('selected');
                            } else {
                                // Single selection behavior
                                grid.querySelectorAll('.option-item').forEach(opt => {
                                    opt.classList.remove('selected');
                                });
                                item.classList.add('selected');
                            }
                            
                            // If this is an "Other" option, handle the input field
                            if (item.classList.contains('other') && item.classList.contains('selected')) {
                                // Create input field if it doesn't exist
                                if (!item.querySelector('.other-input')) {
                                    const input = document.createElement('input');
                                    input.type = 'text';
                                    input.className = 'other-input';
                                    input.placeholder = 'Please specify';
                                    
                                    // Prevent click from toggling selection
                                    input.addEventListener('click', e => e.stopPropagation());
                                    
                                    item.appendChild(input);
                                    setTimeout(() => input.focus(), 0);
                                }
                            }
                        });
                    });
                });
            }
            
            // Make sure the Make Overview button is properly initialized
            const makeOverviewButton = document.getElementById('makeOverviewButton');
            if (makeOverviewButton) {
                // Remove existing event listeners by cloning and replacing
                const newButton = makeOverviewButton.cloneNode(true);
                makeOverviewButton.parentNode.replaceChild(newButton, makeOverviewButton);
                
                // Add new event listener
                newButton.addEventListener('click', () => {
                    console.log('Make Overview button clicked');
                    if (typeof generateProjectOverview === 'function') {
                        // Generate overview data first
                        generateProjectOverview();
                        
                        // Check if formatProjectOverview function exists
                        if (typeof formatProjectOverview === 'function') {
                            const overview = formatProjectOverview(false);
                            
                            // Use the showPromptPopup function from script.js if it exists
                            if (typeof showPromptPopup === 'function') {
                                showPromptPopup('Project Overview', overview, true);
                            } else {
                                // Fallback to the original popup implementation
                                // Create and show popup with overview
                                const overlay = document.createElement('div');
                                overlay.className = 'prompt-overlay';
                                overlay.style.display = 'flex';
                                
                                const popup = document.createElement('div');
                                popup.className = 'prompt-popup';
                                popup.style.maxWidth = '600px';
                                
                                popup.innerHTML = `
                                    <div style="position: relative;">
                                        <button class="close-prompt" style="position:absolute;top:0;right:0;background:none;border:none;font-size:24px;cursor:pointer;color:var(--light-gray);">×</button>
                                        <h2 style="margin-top: 0; padding-right: 24px; color: var(--white-2); margin-bottom: 16px;">Project Overview</h2>
                                    </div>
                                    <div class="prompt-content" contenteditable="false" style="margin-bottom:20px;color:var(--white-3);white-space:pre-wrap;">${overview}</div>
                                    <div class="prompt-actions">
                                        <button class="copy-prompt" data-tooltip="Copy">
                                            <svg class="copy-text" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M20 9H11C9.89543 9 9 9.89543 9 11V20C9 21.1046 9.89543 22 11 22H20C21.1046 22 22 21.1046 22 20V11C22 9.89543 21.1046 9 20 9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                <path d="M5 15H4C3.46957 15 2.96086 14.7893 2.58579 14.4142C2.21071 14.0391 2 13.5304 2 13V4C2 3.46957 2.21071 2.96086 2.58579 2.58579C2.96086 2.21071 3.46957 2 4 2H13C13.5304 2 14.0391 2.21071 14.4142 2.58579C14.7893 2.96086 15 3.46957 15 4V5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            <svg class="copied-text" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                        <button class="send-to-chat" data-tooltip="Send to chat">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                        <button class="edit-button" data-tooltip="Edit">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                <path d="M18.5 2.50001C18.8978 2.10219 19.4374 1.87869 20 1.87869C20.5626 1.87869 21.1022 2.10219 21.5 2.50001C21.8978 2.89784 22.1213 3.4374 22.1213 4.00001C22.1213 4.56262 21.8978 5.10219 21.5 5.50001L12 15L8 16L9 12L18.5 2.50001Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                        <button class="save-button" data-tooltip="Save" style="display: none; background: var(--eerie-black-1); border-color: var(--main-purple); color: var(--main-purple);">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16L21 8V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                <path d="M17 21V13H7V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                <path d="M7 3V8H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </button>
                                    </div>
                                `;
                                
                                // Add to document
                                document.body.appendChild(overlay);
                                overlay.appendChild(popup);
                                
                                // Get elements for event listeners
                                const promptContent = popup.querySelector('.prompt-content');
                                const closeButton = popup.querySelector('.close-prompt');
                                const copyButton = popup.querySelector('.copy-prompt');
                                const editButton = popup.querySelector('.edit-button');
                                const saveButton = popup.querySelector('.save-button');
                                
                                // Close button handler
                                closeButton.addEventListener('click', () => {
                                    document.body.removeChild(overlay);
                                });
                                
                                // Copy button handler
                                copyButton.addEventListener('click', () => {
                                    // Create a temporary textarea element to copy from
                                    const tempTextArea = document.createElement('textarea');
                                    tempTextArea.value = promptContent.textContent;
                                    tempTextArea.setAttribute('readonly', '');
                                    tempTextArea.style.position = 'absolute';
                                    tempTextArea.style.left = '-9999px';
                                    document.body.appendChild(tempTextArea);
                                    
                                    try {
                                        // Select and copy the text
                                        tempTextArea.select();
                                        document.execCommand('copy');
                                        
                                        // Show copied state
                                        copyButton.classList.add('copied');
                                        
                                        // Reset copied state after 2 seconds
                                        setTimeout(() => {
                                            copyButton.classList.remove('copied');
                                        }, 2000);
                                        
                                        console.log('Project overview copied to clipboard');
                                    } catch (err) {
                                        console.error('Failed to copy text: ', err);
                                    } finally {
                                        // Remove the temporary element
                                        document.body.removeChild(tempTextArea);
                                    }
                                });
                                
                                // Send to chat button handler
                                popup.querySelector('.send-to-chat').addEventListener('click', () => {
                                    // Set flag to indicate project overview has been sent to chat
                                    if (typeof projectOverviewSentToChat !== 'undefined') {
                                        projectOverviewSentToChat = true;
                                    }
                                    
                                    // Switch to chat tab
                                    document.querySelector('.nav-tab[data-section="chat"]').click();
                                    
                                    addMessage('<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Project Information Sent', 'user'); 
                                    addMessage('<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Received', 'system');
                                    
                                    document.body.removeChild(overlay);
                                });
                                
                                // Edit button handler
                                editButton.addEventListener('click', () => {
                                    promptContent.contentEditable = 'true';
                                    promptContent.focus();
                                    editButton.style.display = 'none';
                                    saveButton.style.display = 'inline-flex';
                                });
                                
                                // Save button handler
                                saveButton.addEventListener('click', () => {
                                    promptContent.contentEditable = 'false';
                                    saveButton.style.display = 'none';
                                    editButton.style.display = 'inline-flex';
                                });
                            }
                        } else {
                            alert('Project overview formatting is not available. Please make sure all required scripts are loaded.');
                        }
                    } else {
                        alert('Project overview generation is not available. Please make sure you have entered your API key.');
                    }
                });
            }
        }
        
        // Function to generate prompts using OpenAI API
        async function generatePrompts() {
            const generateInput = document.getElementById('generateInput');
            const includeOverview = document.getElementById('includeOverview');
            const generatedPrompts = document.getElementById('generatedPrompts');
            const generateButton = document.getElementById('generateSubmit');
            
            if (!generateInput || !generatedPrompts || !generateButton) return;
            
            const userPrompt = generateInput.value.trim();
            if (!userPrompt) {
                alert('Please enter a description of what you want to generate prompts for.');
                return;
            }
            
            // Disable button and show loading state
            generateButton.disabled = true;
            generateButton.textContent = 'Generating...';
            generatedPrompts.innerHTML = '<div class="loading-dot-container"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>';
            
            // Get project overview if checkbox is checked
            let overviewText = '';
            if (includeOverview && includeOverview.checked) {
                // Try to get project overview from the questionnaire
                const projectDescription = document.getElementById('projectDescription');
                const targetAudience = document.getElementById('targetAudience');
                
                if (projectDescription && projectDescription.value) {
                    overviewText += `Project Description: ${projectDescription.value}\n\n`;
                }
                
                if (targetAudience && targetAudience.value) {
                    overviewText += `Target Audience: ${targetAudience.value}\n\n`;
                }
                
                // If no project info found, add a note
                if (!overviewText) {
                    overviewText = 'Note: No project overview information available yet.\n\n';
                }
            }
            
            try {
                // Get the API key from the input field
                const apiKeyInput = document.getElementById('apiKeyInput');
                let apiKey = '';
                
                if (apiKeyInput && apiKeyInput.value) {
                    apiKey = apiKeyInput.value.trim();
                } else {
                    // If no API key, show a message and simulate response
                    generatedPrompts.innerHTML = '<div class="prompt-item">Please enter your OpenAI API key in the chat section to generate prompts.</div>';
                    generateButton.disabled = false;
                    generateButton.textContent = 'Generate';
                    return;
                }
                
                // Prepare the prompt for OpenAI
                const promptText = `Generate THREE different prompts for ChatGPT based on the following topic: "${userPrompt}".\n
                GUIDELINES:\n
                - Generate each prompt as a separate paragraph WITHOUT numbering them, OR giving them titles (e.g. "Prompt 1", "Prompt 2", "Prompt 3"), OR adding quotation marks: just provide the prompt text.\n
                - Make the prompts help with the ux design process (for example: "What is the industry standard for [topic]?"“Help me create interview questions for [target users] to understand their needs around [topic].” “Summarize user pain points from this set of notes: [paste notes].” “What personas can I create based on the following data: [user quotes or data]?” “What are effective color schemes for a mental health app and why?”) \n
                - Do not use lot of actionable verbs as ChatGPT is unable to design, develop, edit, etc. \n
                - Make the prompts SHORT and GENERAL, not specific to a product or service. Refer to topics/users/data in [brackets] instead. \n
                ${overviewText ? `Include the following project information in your considerations:\n${overviewText}` : ''}`;
                
                // Call OpenAI API
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a helpful assistant that generates prompts for ChatGPT. Generate each prompt as a separate paragraph without numbering them, or giving them titles (e.g. "Prompt 1", "Prompt 2", "Prompt 3"), or adding quotation marks: just provide the prompt text.'
                            },
                            {
                                role: 'user',
                                content: promptText
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 500
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const data = await response.json();
                const generatedText = data.choices[0].message.content;
                
                // Split the generated text into separate prompts
                // First try to split by double newlines, then by numbered patterns if needed
                let prompts = generatedText.split(/\n\s*\n/).filter(p => p.trim() !== '');
                
                // If we don't have at least 3 prompts, try to split by numbered patterns
                if (prompts.length < 3) {
                    prompts = generatedText.split(/\d+\.\s+/).filter(p => p.trim() !== '');
                    // Remove the first empty element if it exists
                    if (prompts.length > 0 && prompts[0].trim() === '') {
                        prompts.shift();
                    }
                }
                
                // Display the prompts
                generatedPrompts.innerHTML = '';
                prompts.forEach((prompt, index) => {
                    // Clean up the prompt text - remove any remaining numbering
                    let cleanPrompt = prompt.trim();
                    cleanPrompt = cleanPrompt.replace(/^\d+\.\s*/, ''); // Remove numbering at the start
                    cleanPrompt = cleanPrompt.replace(/^[•\-*]\s*/, ''); // Remove bullet points
                    
                    // Create a div for each prompt
                    const promptElement = document.createElement('div');
                    promptElement.className = 'prompt-item';
                    promptElement.textContent = cleanPrompt;
                    
                    // Create a div for the prompt actions
                    const actionsElement = document.createElement('div');
                    actionsElement.className = 'prompt-item-actions';
                    
                    // Regenerate button
                    const regenerateButton = document.createElement('button');
                    regenerateButton.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4C7.58 4 4.01 7.58 4.01 12C4.01 16.42 7.58 20 12 20C15.73 20 18.84 17.45 19.73 14H17.65C16.83 16.33 14.61 18 12 18C8.69 18 6 15.31 6 12C6 8.69 8.69 6 12 6C13.66 6 15.14 6.69 16.22 7.78L13 11H20V4L17.65 6.35Z" fill="currentColor"/></svg>';
                    regenerateButton.setAttribute('data-tooltip', 'Regenerate');
                    regenerateButton.addEventListener('click', function(e) {
                        // Prevent event bubbling
                        e.stopPropagation();
                        
                        // Get the current prompt text
                        const promptText = promptElement.textContent;
                        
                        // Call the generateSpecificPrompt function with the current prompt text
                        generateSpecificPrompt(`Generate a new design prompt similar to this one: "${promptText}"`, promptElement);
                    });
                    actionsElement.appendChild(regenerateButton);
                    
                    // Copy button
                    const copyButton = document.createElement('button');
                    copyButton.className = 'copy-prompt';
                    copyButton.setAttribute('data-tooltip', 'Copy');
                    copyButton.innerHTML = `
                        <span class="copy-text">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 9H11C9.89543 9 9 9.89543 9 11V20C9 21.1046 9.89543 22 11 22H20C21.1046 22 22 21.1046 22 20V11C22 9.89543 21.1046 9 20 9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M5 15H4C3.46957 15 2.96086 14.7893 2.58579 14.4142C2.21071 14.0391 2 13.5304 2 13V4C2 3.46957 2.21071 2.96086 2.58579 2.58579C2.96086 2.21071 3.46957 2 4 2H13C13.5304 2 14.0391 2.21071 14.4142 2.58579C14.7893 2.96086 15 3.46957 15 4V5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                        <span class="copied-text">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                    `;
                    copyButton.addEventListener('click', function() {
                        // Create a temporary textarea element to copy from
                        const textarea = document.createElement('textarea');
                        textarea.value = cleanPrompt;
                        textarea.setAttribute('readonly', '');
                        textarea.style.position = 'absolute';
                        textarea.style.left = '-9999px';
                        document.body.appendChild(textarea);
                        
                        // Select and copy the text
                        textarea.select();
                        document.execCommand('copy');
                        
                        // Clean up
                        document.body.removeChild(textarea);
                        
                        // Show copied state
                        copyButton.classList.add('copied');
                        
                        // Reset copied state after 2 seconds
                        setTimeout(() => {
                            copyButton.classList.remove('copied');
                        }, 2000);
                    });
                    actionsElement.appendChild(copyButton);
                    
                    // Send to chat button
                    const sendToChatButton = document.createElement('button');
                    sendToChatButton.setAttribute('data-tooltip', 'Send to Chat');
                    sendToChatButton.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    `;
                    sendToChatButton.addEventListener('click', function(e) {
                        // Prevent event bubbling
                        e.stopPropagation();
                        
                        // Get the chat input element using class selector
                        const chatInput = document.querySelector('.chat-input');
                        
                        // If chat input exists, set its value to the prompt text and focus it
                        if (chatInput) {
                            chatInput.value = cleanPrompt;
                            chatInput.disabled = false;
                            
                            // Switch to the chat tab
                            const chatTab = document.querySelector('.nav-tab[data-section="chat"]');
                            if (chatTab) {
                                chatTab.click();
                            }
                            
                            // Focus the chat input
                            setTimeout(() => {
                                chatInput.focus();
                            }, 100);
                        }
                    });
                    actionsElement.appendChild(sendToChatButton);
                    
                    // Edit button
                    const editButton = document.createElement('button');
                    editButton.className = 'edit-button';
                    editButton.setAttribute('data-tooltip', 'Edit');
                    editButton.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M18.5 2.5C18.8978 2.10217 19.4374 1.87868 20 1.87868C20.5626 1.87868 21.1022 2.10217 21.5 2.5C21.8978 2.89782 22.1213 3.43739 22.1213 4C22.1213 4.56261 21.8978 5.10217 21.5 5.5L12 15L8 16L9 12L18.5 2.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    `;
                    editButton.addEventListener('click', function(e) {
                        // Prevent event bubbling
                        e.stopPropagation();
                        
                        // Toggle the contenteditable attribute
                        const isEditable = promptElement.getAttribute('contenteditable') === 'true';
                        
                        if (!isEditable) {
                            // Make the prompt editable
                            promptElement.setAttribute('contenteditable', 'true');
                            promptElement.focus();
                            
                            // Add a class to the edit button to show it's active
                            editButton.classList.add('active');
                        } else {
                            // Make the prompt non-editable
                            promptElement.setAttribute('contenteditable', 'false');
                            
                            // Remove the active class from the edit button
                            editButton.classList.remove('active');
                        }
                    });
                    actionsElement.appendChild(editButton);
                    
                    // Save button
                    const saveButton = document.createElement('button');
                    saveButton.className = 'save-button';
                    saveButton.setAttribute('data-tooltip', 'Save');
                    saveButton.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16L21 8V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M17 21V13H7V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M7 3V8H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    `;
                    saveButton.addEventListener('click', function(e) {
                        // Prevent event bubbling
                        e.stopPropagation();
                        
                        // Make the prompt non-editable
                        promptElement.setAttribute('contenteditable', 'false');
                        
                        // Remove the active class from the edit button
                        editButton.classList.remove('active');
                    });
                    actionsElement.appendChild(saveButton);
                    
                    // Append the actions to the prompt element
                    promptElement.appendChild(actionsElement);
                    
                    generatedPrompts.appendChild(promptElement);
                });
                
                // Scroll to the generated prompts
                generatedPrompts.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error generating prompts:', error);
                generatedPrompts.innerHTML = `<div class="prompt-item">Error generating prompts: ${error.message}</div>`;
            } finally {
                // Re-enable button
                generateButton.disabled = false;
                generateButton.textContent = 'Generate';
            }
        }
        
        // Direct click handler for the Generate category
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Adding direct click handlers for categories');
            
            // Generate category
            const generateCategory = document.getElementById('generateCategory');
            if (generateCategory) {
                generateCategory.onclick = function() {
                    console.log('Generate category clicked directly');
                    showGeneratePage();
                    return false;
                };
            }
            
            // Start category has inline onclick attribute, no need to add handler here
            
            // Library category
            const libraryCategory = document.getElementById('libraryCategory');
            if (libraryCategory) {
                libraryCategory.onclick = function() {
                    console.log('Library category clicked directly');
                    if (typeof showLibraryPage === 'function') {
                        showLibraryPage();
                    } else {
                        console.error('showLibraryPage function not found');
                    }
                    return false;
                };
            }
            
            // Saved category
            const savedCategory = document.getElementById('savedCategory');
            if (savedCategory) {
                savedCategory.onclick = function() {
                    console.log('Saved category clicked directly');
                    showSavedPage();
                    return false;
                };
            }
            
            // Initialize back button in questionnaire
            initializeBackButtons();
        });
        
        // Function to initialize all back buttons
        function initializeBackButtons() {
            console.log('Initializing back buttons');
            
            // Back button in questionnaire
            const backButton = document.getElementById('backToCategories');
            if (backButton && !backButton.hasAttribute('onclick')) {
                console.log('Setting up back button in questionnaire');
                // Remove existing event listeners by cloning and replacing
                const newBackButton = backButton.cloneNode(true);
                backButton.parentNode.replaceChild(newBackButton, backButton);
                
                // Add new event listener
                newBackButton.addEventListener('click', function() {
                    console.log('Back button clicked in questionnaire');
                    // Hide the questionnaire container
                    document.getElementById('questionnaireContainer').style.display = 'none';
                    // Show the prompts grid
                    document.querySelector('.prompts-grid').style.display = 'grid';
                    return false;
        });
            }
        }
        
        // Define the showGeneratePage function directly in the HTML
        function showGeneratePage() {
            console.log('showGeneratePage called');
            
            // Get the prompt container
            const promptsContainer = document.querySelector('.prompt-container');
            if (!promptsContainer) {
                console.error('Prompt container not found');
                return;
            }
            
            // Save the original content
            if (!promptsContainer.getAttribute('data-original-content')) {
                promptsContainer.setAttribute('data-original-content', promptsContainer.innerHTML);
            }
            
            // Clear the container
            promptsContainer.innerHTML = '';
            
            // Create a container with proper class for styling
            const container = document.createElement('div');
            container.className = 'generate-form-container';
            
            // Ensure the container is scrollable
            const promptsSection = document.getElementById('prompts');
            if (promptsSection) {
                promptsSection.style.overflow = 'auto';
            }
            
            // Create the header container to hold back button and category header
            const headerContainer = document.createElement('div');
            headerContainer.style.display = 'flex';
            headerContainer.style.justifyContent = 'space-between';
            headerContainer.style.alignItems = 'center';
            headerContainer.style.marginBottom = '0';
            
            // Create the back button
            const backButton = document.createElement('button');
            backButton.className = 'back-button';
            backButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" fill="currentColor"/>
                </svg>
                Back
            `;
            
            // Create the category header with icon (similar to other pages)
            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'category-header';
            categoryHeader.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="category-icon" viewBox="0 0 24 24">
                    <path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/>
                </svg>
                <h2>Generate</h2>
            `;
            
            // Add back button and category header to the header container
            headerContainer.appendChild(backButton);
            headerContainer.appendChild(categoryHeader);
            
            // Create the description
            const description = document.createElement('p');
            description.textContent = 'Please describe what you want to generate prompts for.';
            description.className = 'generate-description';
            
            // Create the form
            const generateForm = document.createElement('form');
            generateForm.className = 'generate-form';
            generateForm.addEventListener('submit', function(e) {
                e.preventDefault();
                generatePrompts();
            });
            
            // Create the text input
            const textInput = document.createElement('textarea');
            textInput.id = 'generateInput';
            textInput.className = 'form-control';
            textInput.placeholder = 'E.g. functionalities, style guide, navigation, etc.';
            textInput.style.minHeight = '50px';
            textInput.required = true;
            
            // Create the checkbox for including project overview
            const checkboxContainer = document.createElement('div');
            checkboxContainer.className = 'form-group';
            checkboxContainer.style.flexDirection = 'row';
            checkboxContainer.style.alignItems = 'center';
            checkboxContainer.style.gap = '10px';
            checkboxContainer.style.marginTop = '16px';
            checkboxContainer.style.marginBottom = '20px';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = 'includeOverview';
            checkbox.className = 'overview-checkbox';
            checkbox.style.margin = '0';
            checkbox.style.width = '18px';
            checkbox.style.height = '18px';
            checkbox.style.minWidth = '18px';
            
            const checkboxLabel = document.createElement('label');
            checkboxLabel.setAttribute('for', 'includeOverview');
            checkboxLabel.textContent = 'Include project overview information';
            checkboxLabel.style.margin = '0';
            checkboxLabel.style.color = 'var(--light-gray)';
            
            checkboxContainer.appendChild(checkbox);
            checkboxContainer.appendChild(checkboxLabel);
            
            // Create the generate button
            const generateButton = document.createElement('button');
            generateButton.type = 'submit';
            generateButton.id = 'generateSubmit';
            generateButton.className = 'button button-primary';
            generateButton.textContent = 'Generate';
            
            // Create the generated prompts container
            const generatedPrompts = document.createElement('div');
            generatedPrompts.id = 'generatedPrompts';
            generatedPrompts.className = 'generated-prompts';
            generatedPrompts.style.marginTop = '30px';
            
            // Add elements to the form
            generateForm.appendChild(textInput);
            generateForm.appendChild(checkboxContainer);
            generateForm.appendChild(generateButton);
            
            // Add event listener to the back button
            backButton.addEventListener('click', function() {
                console.log('Back button clicked in Generate page');
                // Restore the original content with the grid categories
                if (promptsContainer.getAttribute('data-original-content')) {
                    promptsContainer.innerHTML = promptsContainer.getAttribute('data-original-content');
                    
                    // Re-add click handlers to categories
                    const generateCategory = document.getElementById('generateCategory');
                    if (generateCategory) {
                        generateCategory.onclick = function() {
                            showGeneratePage();
                            return false;
                        };
                    }
                    
                    const startCategory = document.getElementById('startCategory');
                    if (startCategory) {
                        startCategory.onclick = function() {
                            showStartPage();
                            return false;
                        };
                    }
                    
                    const libraryCategory = document.getElementById('libraryCategory');
                    if (libraryCategory) {
                        libraryCategory.onclick = function() {
                            showLibraryPage();
                            return false;
                        };
                    }
                }
            });
            
            // Add elements to the container
            container.appendChild(headerContainer);
            container.appendChild(description);
            container.appendChild(generateForm);
            container.appendChild(generatedPrompts);
            
            // Add the container to the prompts container
            promptsContainer.appendChild(container);
            
            // Focus on the input field
            setTimeout(() => {
                textInput.focus();
            }, 100);
        }

        // Function to generate a specific prompt (used for regeneration)
        async function generateSpecificPrompt(specificPrompt, promptElement) {
            // Save the actions element before updating the content
            const actionsElement = promptElement.querySelector('.prompt-item-actions');
            if (actionsElement) {
                // Clone it to preserve all event listeners
                actionsElement.remove();
            }
            
            // Show loading state in the prompt element
            const originalContent = promptElement.textContent;
            promptElement.innerHTML = '<div class="loading-dot-container"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>';
            
            try {
                // Get the API key from the input field
                const apiKeyInput = document.getElementById('apiKeyInput');
                let apiKey = '';
                
                if (apiKeyInput && apiKeyInput.value) {
                    apiKey = apiKeyInput.value.trim();
                } else {
                    // If no API key, restore original content and show error
                    promptElement.textContent = originalContent;
                    if (actionsElement) {
                        promptElement.appendChild(actionsElement);
                    }
                    return;
                }
                
                // Call OpenAI API
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a helpful assistant that generates design prompts for ChatGPT. Generate each prompt as a separate paragraph without numbering them, or giving them titles (e.g. "Prompt 1", "Prompt 2", "Prompt 3"), or adding quotation marks: just provide the prompt text.'
                            },
                            {
                                role: 'user',
                                content: specificPrompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 300
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const data = await response.json();
                const generatedText = data.choices[0].message.content;
                
                // Clean up the generated text
                let cleanPrompt = generatedText.trim();
                cleanPrompt = cleanPrompt.replace(/^\d+\.\s*/, ''); // Remove numbering at the start
                cleanPrompt = cleanPrompt.replace(/^[•\-*]\s*/, ''); // Remove bullet points
                
                // Update the prompt element with the new content
                promptElement.textContent = cleanPrompt;
                
                // Re-add the actions element if it exists
                if (actionsElement) {
                    promptElement.appendChild(actionsElement);
                }
                
            } catch (error) {
                console.error('Error regenerating prompt:', error);
                promptElement.textContent = originalContent;
                
                // Re-add the actions element if it exists
                if (actionsElement) {
                    promptElement.appendChild(actionsElement);
                }
            }
        }
    </script>
</body>
</html> 